
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>运行用户代码时间过长调度 · golang goroutine详解</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="zput">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="2.3.2.系统调用收尾,如果从系统调用返回,如何重新得到P.html" />
    
    
    <link rel="prev" href="2.2.被动调度.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    
    
        
        <li>
            <a href="https://zput.github.io" target="_blank" class="custom-link">zput|堆排序</a>
        </li>
    
    

    
    <li class="divider"></li>
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../">
            
                <a href="../../">
            
                    
                    大纲
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../part0.基础知识/1.汇编基础.html">
            
                <a href="../../part0.基础知识/1.汇编基础.html">
            
                    
                    第一部分 基础知识
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../part0.基础知识/1.汇编基础.html">
            
                <a href="../../part0.基础知识/1.汇编基础.html">
            
                    
                    汇编基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../../part0.基础知识/2.内存.html">
            
                <a href="../../part0.基础知识/2.内存.html">
            
                    
                    内存
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../part1.进入main函数之前的初始化/1.进入main函数之前的初始化.html">
            
                <a href="../../part1.进入main函数之前的初始化/1.进入main函数之前的初始化.html">
            
                    
                    第二部分 进入main函数之前的初始化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../../part1.进入main函数之前的初始化/1.进入main函数之前的初始化.html">
            
                <a href="../../part1.进入main函数之前的初始化/1.进入main函数之前的初始化.html">
            
                    
                    进入main函数之前的初始化
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../../part2.退出goroutine/1.退出goroutine.html">
            
                <a href="../../part2.退出goroutine/1.退出goroutine.html">
            
                    
                    第三部分 退出goroutine
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../../part2.退出goroutine/1.退出goroutine.html">
            
                <a href="../../part2.退出goroutine/1.退出goroutine.html">
            
                    
                    退出goroutine
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    第四部分 调度
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../1.调度策略/1.1.从本地队列或全局队列获取goroutine.html">
            
                <a href="../1.调度策略/1.1.从本地队列或全局队列获取goroutine.html">
            
                    
                    1.调度策略
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1.1" data-path="../1.调度策略/1.1.从本地队列或全局队列获取goroutine.html">
            
                <a href="../1.调度策略/1.1.从本地队列或全局队列获取goroutine.html">
            
                    
                    从本地队列或全局队列获取goroutine
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.2" data-path="../1.调度策略/1.2.盗取goroutine从其他队列.html">
            
                <a href="../1.调度策略/1.2.盗取goroutine从其他队列.html">
            
                    
                    盗取goroutine从其他队列
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="2.1.主动调度.html">
            
                <a href="2.1.主动调度.html">
            
                    
                    2.调度的时机
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.2.1" data-path="2.1.主动调度.html">
            
                <a href="2.1.主动调度.html">
            
                    
                    主动调度
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.2" data-path="2.2.被动调度.html">
            
                <a href="2.2.被动调度.html">
            
                    
                    被动调度
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6.2.3" data-path="2.3.1.运行用户代码时间过长调度.html">
            
                <a href="2.3.1.运行用户代码时间过长调度.html">
            
                    
                    运行用户代码时间过长调度
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2.4" data-path="2.3.2.系统调用收尾,如果从系统调用返回,如何重新得到P.html">
            
                <a href="2.3.2.系统调用收尾,如果从系统调用返回,如何重新得到P.html">
            
                    
                    系统调用收尾,如果从系统调用返回,如何重新得到P
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../3.调度循环/3.3.调度循环.html">
            
                <a href="../3.调度循环/3.3.调度循环.html">
            
                    
                    3.调度循环
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.3.1" data-path="../3.调度循环/3.3.调度循环.html">
            
                <a href="../3.调度循环/3.3.调度循环.html">
            
                    
                    调度循环
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../总结.html">
            
                <a href="../总结.html">
            
                    
                    总结
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >运行用户代码时间过长调度</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#x8FC7;&#x957F;&#x88AB;&#x8C03;&#x5EA6;&#x7684;&#x60C5;&#x51B5;"><b>1. </b>&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#x8FC7;&#x957F;&#x88AB;&#x8C03;&#x5EA6;&#x7684;&#x60C5;&#x51B5;</a></li><ul><li><span class="title-icon "></span><a href="#&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;"><b>1.1. </b>&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;"><b>1.1.1. </b>&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;</a></li></ul><li><span class="title-icon "></span><a href="#sysmon"><b>1.2. </b>sysmon</a></li><li><span class="title-icon "></span><a href="#retake"><b>1.3. </b>retake</a></li><li><span class="title-icon "></span><a href="#&#x6808;&#x589E;&#x957F;&#x76F8;&#x5173;&#x4EE3;&#x7801;"><b>1.4. </b>&#x6808;&#x589E;&#x957F;&#x76F8;&#x5173;&#x4EE3;&#x7801;</a></li><li><span class="title-icon "></span><a href="#&#x989D;&#x5916;&#x7684;&#x4F8B;&#x5B50;"><b>1.5. </b>&#x989D;&#x5916;&#x7684;&#x4F8B;&#x5B50;</a></li><ul><li><span class="title-icon "></span><a href="#&#x5B9A;&#x4E49;&#x7A0B;&#x5E8F;"><b>1.5.1. </b>&#x5B9A;&#x4E49;&#x7A0B;&#x5E8F;</a></li><li><span class="title-icon "></span><a href="#gdb&#x8C03;&#x8BD5;&#x524D;&#x51C6;&#x5907;"><b>1.5.2. </b>gdb&#x8C03;&#x8BD5;&#x524D;&#x51C6;&#x5907;</a></li><li><span class="title-icon "></span><a href="#&#x7F16;&#x8BD1;&#x7A0B;&#x5E8F;"><b>1.5.3. </b>&#x7F16;&#x8BD1;&#x7A0B;&#x5E8F;</a></li></ul></ul></ul></div><a href="#&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#x8FC7;&#x957F;&#x88AB;&#x8C03;&#x5EA6;&#x7684;&#x60C5;&#x51B5;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><h1 id="&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#x8FC7;&#x957F;&#x88AB;&#x8C03;&#x5EA6;&#x7684;&#x60C5;&#x51B5;"><a name="&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#x8FC7;&#x957F;&#x88AB;&#x8C03;&#x5EA6;&#x7684;&#x60C5;&#x51B5;" class="anchor-navigation-ex-anchor" href="#&#x8FD0;&#x884C;&#x65F6;&#x95F4;&#x8FC7;&#x957F;&#x88AB;&#x8C03;&#x5EA6;&#x7684;&#x60C5;&#x51B5;"><i class="fa fa-link" aria-hidden="true"></i></a>1. &#x8FD0;&#x884C;&#x65F6;&#x95F4;&#x8FC7;&#x957F;&#x88AB;&#x8C03;&#x5EA6;&#x7684;&#x60C5;&#x51B5;</h1>
<ul>
<li>&#x8FD0;&#x884C;&#x7528;&#x6237;&#x4EE3;&#x7801;&#x65F6;&#x95F4;&#x8FC7;&#x957F;;</li>
<li>&#x56E0;&#x4E3A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;,&#x5BFC;&#x81F4;&#x65F6;&#x95F4;&#x8FC7;&#x957F;.</li>
</ul>
<h2 id="&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;"><a name="&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;" class="anchor-navigation-ex-anchor" href="#&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. &#x7CFB;&#x7EDF;&#x76D1;&#x63A7;</h2>
<blockquote>
<p>&#x6211;&#x4EEC;&#x80FD;&#x60F3;&#x5230;&#x6709;&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;&#x624D;&#x80FD;&#x67E5;&#x770B;&#x662F;&#x5426;&#x4EE3;&#x7801;&#x662F;&#x5426;&#x8FC7;&#x957F;.</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200923134823.png" alt="sysmon"></p>
<h3 id="&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;"><a name="&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;" class="anchor-navigation-ex-anchor" href="#&#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;"><i class="fa fa-link" aria-hidden="true"></i></a>1.1.1. &#x5F00;&#x542F;&#x7CFB;&#x7EDF;&#x76D1;&#x63A7;</h3>
<ul>
<li>sysmon&#x6C38;&#x8FDC;for&#x5FAA;&#x73AF;<code>src/runtime/proc.go</code></li>
</ul>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> main() {
    <span class="hljs-comment">//...</span>

    <span class="hljs-keyword">if</span> GOARCH != <span class="hljs-string">&quot;wasm&quot;</span> { <span class="hljs-comment">// no threads on wasm yet, so no sysmon</span>
        systemstack(<span class="hljs-keyword">func</span>() {
            newm(sysmon, <span class="hljs-literal">nil</span>)
        })
    }

    <span class="hljs-comment">//...</span>
}
</code></pre>
<p><img src="https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200917111914.png" alt="&#x88AB;&#x52A8;&#x8C03;&#x5EA6;;&#x5524;&#x9192;">
&#x4E0A;&#x4E00;&#x7AE0;&#x6211;&#x4EEC;&#x4E5F;&#x5206;&#x6790;&#x4E86;&#x8FD9;&#x4E2A;<code>newm</code>&#x51FD;&#x6570;;&#x6240;&#x4EE5;&#x5728;&#x8FDB;&#x5165;schedule()&#x51FD;&#x6570;&#x4E4B;&#x524D;,&#x4F1A;&#x5148;&#x6267;&#x884C;&#x8FD9;&#x4E2A;<code>sysmon</code>&#x51FD;&#x6570;.</p>
<h2 id="sysmon"><a name="sysmon" class="anchor-navigation-ex-anchor" href="#sysmon"><i class="fa fa-link" aria-hidden="true"></i></a>1.2. sysmon</h2>
<p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EA;&#x770B;&#x62A2;&#x5360;&#x76F8;&#x5173;&#x7684;,&#x5F53;retake&#x8FD4;&#x56DE;&#x975E;0,&#x90A3;&#x4E48;&#x4EE3;&#x8868;&#x6240;&#x6709;P&#x4E0D;&#x662F;&#x7A7A;&#x95F2;&#x7684;&#x72B6;&#x6001;,&#x6240;&#x4EE5;<code>idle=0</code>==&gt;<code>usleep(delay)</code>&#x53EA;&#x662F;&#x4F11;&#x7720;&#x6700;&#x5C11;&#x7684;&#x65F6;&#x95F4;,&#x53EA;&#x6709;20us</p>
<pre><code class="lang-go"><span class="hljs-comment">// Always runs without a P, so write barriers are not allowed.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//go:nowritebarrierrec</span>
<span class="hljs-keyword">func</span> sysmon() {
    lock(&amp;sched.lock)
    sched.nmsys++ <span class="hljs-comment">//&#x589E;&#x52A0;&#x8BB0;&#x5F55;&#x7CFB;&#x7EDF;&#x7EBF;&#x7A0B;&#x7684;&#x503C;&#x7684;&#x4E2A;&#x6570;</span>
    checkdead()
    unlock(&amp;sched.lock)

    lasttrace := <span class="hljs-keyword">int64</span>(<span class="hljs-number">0</span>)
    idle := <span class="hljs-number">0</span> <span class="hljs-comment">// how many cycles in succession we had not wokeup somebody</span>
    delay := <span class="hljs-keyword">uint32</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">for</span> {
        <span class="hljs-keyword">if</span> idle == <span class="hljs-number">0</span> { <span class="hljs-comment">// start with 20us sleep...</span>
            delay = <span class="hljs-number">20</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> idle &gt; <span class="hljs-number">50</span> { <span class="hljs-comment">// start doubling the sleep after 1ms...</span>
            delay *= <span class="hljs-number">2</span>
        }
        <span class="hljs-keyword">if</span> delay &gt; <span class="hljs-number">10</span>*<span class="hljs-number">1000</span> { <span class="hljs-comment">// up to 10ms</span>
            delay = <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>
        }
        usleep(delay)

        <span class="hljs-comment">//...</span>

        <span class="hljs-comment">// retake P&apos;s blocked in syscalls</span>
        <span class="hljs-comment">// and preempt long running G&apos;s</span>
        <span class="hljs-comment">// &#x62A2;&#x5360;&#x88AB;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x963B;&#x585E;&#x7684;P&#x548C;&#x62A2;&#x5360;&#x957F;&#x671F;&#x8FD0;&#x884C;&#x7684;G</span>
        <span class="hljs-keyword">if</span> retake(now) != <span class="hljs-number">0</span> {
            idle = <span class="hljs-number">0</span>
        } <span class="hljs-keyword">else</span> {
            idle++
        }
        <span class="hljs-comment">// check if we need to force a GC</span>
        <span class="hljs-comment">//...</span>
    }
}
</code></pre>
<h2 id="retake"><a name="retake" class="anchor-navigation-ex-anchor" href="#retake"><i class="fa fa-link" aria-hidden="true"></i></a>1.3. retake</h2>
<ul>
<li>&#x53EA;&#x6709;P&#x662F;<code>_Prunning or _Psyscall</code>,&#x624D;&#x4F1A;&#x8FDB;&#x884C;&#x62A2;&#x5360;<ul>
<li><code>_Prunning</code><ul>
<li>&#x8FDE;&#x7EED;&#x8FD0;&#x884C;&#x8D85;&#x8FC7;10&#x6BEB;&#x79D2;&#x4E86;&#xFF0C;&#x8BBE;&#x7F6E;&#x62A2;&#x5360;&#x8BF7;&#x6C42;.</li>
</ul>
</li>
<li><code>_Psyscall</code>: &#x5F53;&#x7A0B;&#x5E8F;&#x6CA1;&#x6709;&#x5DE5;&#x4F5C;&#x9700;&#x8981;&#x505A;,&#x4E14;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6CA1;&#x6709;&#x8D85;&#x8FC7;10ms&#x5C31;&#x4E0D;&#x8FDB;&#x884C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x62A2;&#x5360;.<ul>
<li>1&#x548C;2&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#x6CA1;&#x6709;&#x5DE5;&#x4F5C;&#x9700;&#x8981;&#x505A;;</li>
<li>3&#x8BF4;&#x660E;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8FD8;&#x6CA1;&#x8D85;&#x8FC7;10m</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> retake(now <span class="hljs-keyword">int64</span>) <span class="hljs-keyword">uint32</span> {
    n := <span class="hljs-number">0</span>
    <span class="hljs-comment">// Prevent allp slice changes. This lock will be completely</span>
    <span class="hljs-comment">// uncontended unless we&apos;re already stopping the world.</span>
    lock(&amp;allpLock)
    <span class="hljs-comment">// We can&apos;t use a range loop over allp because we may</span>
    <span class="hljs-comment">// temporarily drop the allpLock. Hence, we need to re-fetch</span>
    <span class="hljs-comment">// allp each time around the loop.</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(allp); i++ { <span class="hljs-comment">//&#x904D;&#x5386;&#x6240;&#x6709;&#x7684;P</span>
        _p_ := allp[i]
        <span class="hljs-keyword">if</span> _p_ == <span class="hljs-literal">nil</span> {
            <span class="hljs-comment">// This can happen if procresize has grown</span>
            <span class="hljs-comment">// allp but not yet created new Ps.</span>
            <span class="hljs-keyword">continue</span>
        }
        pd := &amp;_p_.sysmontick <span class="hljs-comment">// &#x6700;&#x540E;&#x4E00;&#x6B21;&#x88AB;sysmon&#x89C2;&#x5BDF;&#x5230;&#x7684;tick</span>
        s := _p_.status
        sysretake := <span class="hljs-literal">false</span>
        <span class="hljs-keyword">if</span> s == _Prunning || s == _Psyscall { <span class="hljs-comment">//&#x53EA;&#x6709;&#x5F53;p&#x5904;&#x4E8E; _Prunning &#x6216; _Psyscall &#x72B6;&#x6001;&#x65F6;&#x624D;&#x4F1A;&#x8FDB;&#x884C;&#x62A2;&#x5360;</span>
            <span class="hljs-comment">// Preempt G if it&apos;s running for too long.</span>
            t := <span class="hljs-keyword">int64</span>(_p_.schedtick)  <span class="hljs-comment">// _p_.schedtick&#xFF1A;&#x6BCF;&#x53D1;&#x751F;&#x4E00;&#x6B21;&#x8C03;&#x5EA6;&#xFF0C;&#x8C03;&#x5EA6;&#x5668;&#x5BF9;&#x8BE5;&#x503C;&#x52A0;&#x4E00;</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">int64</span>(pd.schedtick) != t { <span class="hljs-comment">// &#x76D1;&#x63A7;&#x7EBF;&#x7A0B;&#x76D1;&#x63A7;&#x5230;&#x4E00;&#x6B21;&#x65B0;&#x7684;&#x8C03;&#x5EA6;&#xFF0C;&#x6240;&#x4EE5;&#x91CD;&#x7F6E;&#x8DDF;sysmon&#x76F8;&#x5173;&#x7684;schedtick&#x548C;schedwhen&#x53D8;&#x91CF;</span>
                pd.schedtick = <span class="hljs-keyword">uint32</span>(t)
                pd.schedwhen = now
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> pd.schedwhen+forcePreemptNS &lt;= now { <span class="hljs-comment">//  1. &#x6CA1;&#x6709;&#x8FDB;&#x7B2C;&#x4E00;&#x4E2A;if&#x8BED;&#x53E5;&#x5185;,&#x8BF4;&#x660E;:pd.schedtick == t; &#x8BF4;&#x660E;(pd.schedwhen &#xFF5E; now)&#x8FD9;&#x6BB5;&#x65F6;&#x95F4;&#x672A;&#x53D1;&#x751F;&#x8FC7;&#x8C03;&#x5EA6;;</span>
                preemptone(_p_)                            <span class="hljs-comment">//  2. &#x4F46;&#x662F;&#x8FD9;&#x4E2A;_P_&#x4E0A;&#x9762;&#x7684;&#x67D0;&#x4E2A;Goroutine&#x88AB;&#x6267;&#x884C;,&#x4E00;&#x76F4;&#x5728;&#x6267;&#x884C;&#x8FD9;&#x4E2A;Goroutiine; &#x4E2D;&#x95F4;&#x6CA1;&#x6709;&#x5207;&#x6362;&#x5176;&#x4ED6;Goroutine,&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x5207;&#x4F1A;&#x5BFC;&#x81F4;_P_.schedtick&#x589E;&#x957F;,&#x5BFC;&#x81F4;&#x8FDB;&#x5165;&#x7B2C;&#x4E00;&#x4E2A;if&#x8BED;&#x53E5;&#x5185;;</span>
                <span class="hljs-comment">// In case of syscall, preemptone() doesn&apos;t // 3. &#x8FDE;&#x7EED;&#x8FD0;&#x884C;&#x8D85;&#x8FC7;10&#x6BEB;&#x79D2;&#x4E86;&#xFF0C;&#x8BBE;&#x7F6E;&#x62A2;&#x5360;&#x8BF7;&#x6C42;.</span>
                <span class="hljs-comment">// work, because there is no M wired to P.</span>
                sysretake = <span class="hljs-literal">true</span>   <span class="hljs-comment">// &#x9700;&#x8981;&#x7CFB;&#x7EDF;&#x62A2;&#x5360;</span>
            }
        }
        <span class="hljs-keyword">if</span> s == _Psyscall { <span class="hljs-comment">// P&#x5904;&#x4E8E;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4E4B;&#x4E2D;&#xFF0C;&#x9700;&#x8981;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x9700;&#x8981;&#x62A2;&#x5360;</span>
            <span class="hljs-comment">// Retake P from syscall if it&apos;s there for more than 1 sysmon tick (at least 20us).</span>
            t := <span class="hljs-keyword">int64</span>(_p_.syscalltick) <span class="hljs-comment">// &#x7528;&#x4E8E;&#x8BB0;&#x5F55;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x6B21;&#x6570;&#xFF0C;&#x4E3B;&#x8981;&#x7531;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x5728;&#x5B8C;&#x6210;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4E4B;&#x540E;&#x52A0;&#x4E00;</span>
            <span class="hljs-keyword">if</span> !sysretake &amp;&amp; <span class="hljs-keyword">int64</span>(pd.syscalltick) != t { <span class="hljs-comment">// &#x4E0D;&#x76F8;&#x7B49;---&#x8BF4;&#x660E;&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;&#x4E0A;&#x6B21;&#x89C2;&#x5BDF;&#x5230;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;,&#x5F00;&#x59CB;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;,&#x6240;&#x4EE5;&#x91CD;&#x7F6E;&#x4E00;&#x4E0B;</span>
                pd.syscalltick = <span class="hljs-keyword">uint32</span>(t)
                pd.syscallwhen = now
                <span class="hljs-keyword">continue</span>
            }
            <span class="hljs-comment">// On the one hand we don&apos;t want to retake Ps if there is no other work to do,</span>
            <span class="hljs-comment">// but on the other hand we want to retake them eventually</span>
            <span class="hljs-comment">// because they can prevent the sysmon thread from deep sleep.</span>

            <span class="hljs-comment">// 1.  _p_&#x7684;&#x672C;&#x5730;&#x8FD0;&#x884C;&#x961F;&#x5217;&#x6CA1;&#x6709;Gs; runqempty(_p_)&#x8FD4;&#x56DE;true</span>
            <span class="hljs-comment">// 2. &#x6709;&#x7A7A;&#x95F2;&#x7684;P,&#x6216;&#x8005;&#x6709;&#x6B63;&#x5728;&#x81EA;&#x65CB;&#x72B6;&#x6001;&#x7684;M(&#x6B63;&#x5728;&#x5077;&#x5176;&#x4ED6;P&#x961F;&#x5217;&#x7684;Gs); atomic.Load(&amp;sched.nmspinning)+atomic.Load(&amp;sched.npidle) &gt; 0&#x8FD4;&#x56DE;true</span>
            <span class="hljs-comment">// 3. &#x4E0A;&#x6B21;&#x89C2;&#x6D4B;&#x5230;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8FD8;&#x6CA1;&#x6709;&#x8D85;&#x8FC7;10&#x6BEB;&#x79D2;; pd.syscallwhen+10*1000*1000 &gt; now&#x8FD4;&#x56DE;true</span>
            <span class="hljs-comment">// - concluing: &#x5F53;&#x7A0B;&#x5E8F;&#x6CA1;&#x6709;&#x5DE5;&#x4F5C;&#x9700;&#x8981;&#x505A;,&#x4E14;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6CA1;&#x6709;&#x8D85;&#x8FC7;10ms&#x5C31;&#x4E0D;&#x8FDB;&#x884C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x62A2;&#x5360;.</span>
            <span class="hljs-comment">//   - 1&#x548C;2&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;&#x7A0B;&#x5E8F;&#x6CA1;&#x6709;&#x5DE5;&#x4F5C;&#x9700;&#x8981;&#x505A;;</span>
            <span class="hljs-comment">//   - 3&#x8BF4;&#x660E;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8FD8;&#x6CA1;&#x8D85;&#x8FC7;10ms</span>
            <span class="hljs-keyword">if</span> runqempty(_p_) &amp;&amp; atomic.Load(&amp;sched.nmspinning)+atomic.Load(&amp;sched.npidle) &gt; <span class="hljs-number">0</span> &amp;&amp; pd.syscallwhen+<span class="hljs-number">10</span>*<span class="hljs-number">1000</span>*<span class="hljs-number">1000</span> &gt; now {
                <span class="hljs-keyword">continue</span>
            }
            <span class="hljs-comment">// Drop allpLock so we can take sched.lock.</span>
            unlock(&amp;allpLock)
            <span class="hljs-comment">// Need to decrement number of idle locked M&apos;s</span>
            <span class="hljs-comment">// (pretending that one more is running) before the CAS.</span>
            <span class="hljs-comment">// Otherwise the M from which we retake can exit the syscall,</span>
            <span class="hljs-comment">// increment nmidle and report deadlock.</span>
            incidlelocked(<span class="hljs-number">-1</span>)
            <span class="hljs-keyword">if</span> atomic.Cas(&amp;_p_.status, s, _Pidle) { <span class="hljs-comment">// &#x9700;&#x8981;&#x62A2;&#x5360;&#xFF0C;&#x5219;&#x901A;&#x8FC7;&#x4F7F;&#x7528;cas&#x4FEE;&#x6539;p&#x7684;&#x72B6;&#x6001;&#x6765;&#x83B7;&#x53D6;p&#x7684;&#x4F7F;&#x7528;&#x6743;</span>
                <span class="hljs-keyword">if</span> trace.enabled {                  <span class="hljs-comment">// CAS: &#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x6B64;&#x65F6;&#x6B64;&#x523B;&#x53EF;&#x80FD;&#x6B63;&#x597D;&#x4ECE;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8FD4;&#x56DE;&#x4E86;&#xFF0C;&#x4E5F;&#x6B63;&#x5728;&#x83B7;&#x53D6;p&#x7684;&#x4F7F;&#x7528;&#x6743;</span>
                    traceGoSysBlock(_p_)
                    traceProcStop(_p_)
                }
                n++
                _p_.syscalltick++
                handoffp(_p_)  <span class="hljs-comment">// &#x5BFB;&#x627E;&#x4E00;&#x4E2A;&#x65B0;&#x7684;m&#x51FA;&#x6765;&#x63A5;&#x7BA1;P</span>
            }
            incidlelocked(<span class="hljs-number">1</span>)
            lock(&amp;allpLock)
        }
    }
    unlock(&amp;allpLock)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">uint32</span>(n)
}
</code></pre>
<h4 id="&#x6267;&#x884C;&#x7528;&#x6237;&#x4EE3;&#x7801;&#x62A2;&#x5360;"><a name="&#x6267;&#x884C;&#x7528;&#x6237;&#x4EE3;&#x7801;&#x62A2;&#x5360;" class="anchor-navigation-ex-anchor" href="#&#x6267;&#x884C;&#x7528;&#x6237;&#x4EE3;&#x7801;&#x62A2;&#x5360;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6267;&#x884C;&#x7528;&#x6237;&#x4EE3;&#x7801;&#x62A2;&#x5360;</h4>
<blockquote>
<p><code>preemptone</code>&#x8BBE;&#x7F6E;&#x4E86;&#x88AB;&#x62A2;&#x5360;goroutine&#x5BF9;&#x5E94;&#x7684;g&#x7ED3;&#x6784;&#x4F53;&#x4E2D;&#x7684; preempt&#x6210;&#x5458;&#x4E3A;true&#x548C;stackguard0&#x6210;&#x5458;&#x4E3A;stackPreempt.</p>
</blockquote>
<pre><code class="lang-go"><span class="hljs-comment">// Tell the goroutine running on processor P to stop.</span>
<span class="hljs-comment">// This function is purely best-effort. It can incorrectly fail to inform the</span>
<span class="hljs-comment">// goroutine. It can send inform the wrong goroutine. Even if it informs the</span>
<span class="hljs-comment">// correct goroutine, that goroutine might ignore the request if it is</span>
<span class="hljs-comment">// simultaneously executing newstack.</span>
<span class="hljs-comment">// No lock needs to be held.</span>
<span class="hljs-comment">// Returns true if preemption request was issued.</span>
<span class="hljs-comment">// The actual preemption will happen at some point in the future</span>
<span class="hljs-comment">// and will be indicated by the gp-&gt;status no longer being</span>
<span class="hljs-comment">// Grunning</span>
<span class="hljs-keyword">func</span> preemptone(_p_ *p) <span class="hljs-keyword">bool</span> {
    mp := _p_.m.ptr()
    <span class="hljs-keyword">if</span> mp == <span class="hljs-literal">nil</span> || mp == getg().m {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    gp := mp.curg <span class="hljs-comment">// gp == &#x88AB;&#x62A2;&#x5360;&#x7684;goroutine</span>
    <span class="hljs-keyword">if</span> gp == <span class="hljs-literal">nil</span> || gp == mp.g0 {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }

    gp.preempt = <span class="hljs-literal">true</span> <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x62A2;&#x5360;&#x4FE1;&#x53F7;preempt == true</span>

    <span class="hljs-comment">// Every call in a go routine checks for stack overflow by</span>
    <span class="hljs-comment">// comparing the current stack pointer to gp-&gt;stackguard0.</span>
    <span class="hljs-comment">// Setting gp-&gt;stackguard0 to StackPreempt folds</span>
    <span class="hljs-comment">// preemption into the normal stack overflow check.</span>

    <span class="hljs-comment">// (1&lt;&lt;(8*sys.PtrSize) - 1) &amp; -1314 ---&gt; 0xfffffffffffffade, &#x5F88;&#x5927;&#x7684;&#x6570;</span>
    gp.stackguard0 = stackPreempt <span class="hljs-comment">//stackguard0==&#x5F88;&#x5927;&#x7684;&#x6570;; &#x4F7F;&#x88AB;&#x62A2;&#x5360;&#x7684;goroutine;&#x5728;&#x8FDB;&#x884C;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x4F1A;&#x53BB;&#x68C0;&#x67E5;&#x6808;&#x6EA2;&#x51FA;;&#x53BB;&#x5904;&#x7406;&#x62A2;&#x5360;&#x8BF7;&#x6C42;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}
</code></pre>
<h4 id="&#x5982;&#x4F55;&#x8BFB;&#x53D6;&#x6807;&#x5FD7;&#x7136;&#x540E;&#x8FDB;&#x884C;&#x62A2;&#x5360;"><a name="&#x5982;&#x4F55;&#x8BFB;&#x53D6;&#x6807;&#x5FD7;&#x7136;&#x540E;&#x8FDB;&#x884C;&#x62A2;&#x5360;" class="anchor-navigation-ex-anchor" href="#&#x5982;&#x4F55;&#x8BFB;&#x53D6;&#x6807;&#x5FD7;&#x7136;&#x540E;&#x8FDB;&#x884C;&#x62A2;&#x5360;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5982;&#x4F55;&#x8BFB;&#x53D6;&#x6807;&#x5FD7;,&#x7136;&#x540E;&#x8FDB;&#x884C;&#x62A2;&#x5360;</h4>
<blockquote>
<p>&#x901A;&#x8FC7;<code>stackguard0</code>&#x4EE5;&#x53CA;<code>preempt</code>&#x53EF;&#x4EE5;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x94FE;&#x8DEF;:<code>morestack_noctxt()-&gt;morestack()-&gt;newstack()</code>.</p>
</blockquote>
<p>// TODO zxc: reference part0:&#x6C47;&#x7F16;&#x57FA;&#x7840;.md/go&#x7F16;&#x8BD1;&#x5668;&#x52A0;&#x7684;&#x51FD;&#x6570;&#x5934;&#x7684;&#x90E8;&#x5206;.</p>
<h5 id="runtime&#xB7;morestack"><a name="runtime&#xB7;morestack" class="anchor-navigation-ex-anchor" href="#runtime&#xB7;morestack"><i class="fa fa-link" aria-hidden="true"></i></a>runtime&#xB7;morestack</h5>
<pre><code>// morestack but not preserving ctxt.
TEXT runtime&#xB7;morestack_noctxt(SB),NOSPLIT,$0
    MOVL    $0, DX
    JMP    runtime&#xB7;morestack(SB)



/*
 * support for morestack
 */

// Called during function prolog when more stack is needed.
//
// The traceback routines see morestack on a g0 as being
// the top of a stack (for example, morestack calling newstack
// calling the scheduler calling newm calling gc), so we must
// record an argument size. For that purpose, it has no arguments.
TEXT runtime&#xB7;morestack(SB),NOSPLIT,$0-0    
//&#x5F00;&#x59CB;&#x662F;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x5224;&#x65AD;
    // Cannot grow scheduler stack (m-&gt;g0).
    //...
    // Cannot grow signal stack (m-&gt;gsignal).
    //...

//&#x8BBE;&#x7F6E;m-&gt;morebuf&#x7684;PC&#xFF0C;SP&#xFF0C;g&#x4E3A;&#x76F8;&#x5BF9;&#x5E94;&#x7684;&apos;main&apos;
    // Called from f.
    // Set m-&gt;morebuf to f&apos;s caller.
    NOP    SP    // tell vet SP changed - stop checking offsets
    MOVQ    8(SP), AX    // f&apos;s caller&apos;s PC // &#x8FD9;&#x91CC;&#x7684;&#x8DEF;&#x5F84;&#x6BD4;&#x5982;&#x6211;&#x7684;&#xFF1A;  &apos;main&apos;---&gt;&apos;sub_function&apos;&#x3002;
                                           // &#x4F46;&#x662F;&#x62A2;&#x5360;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x8D70;&#x4E0B;&#x9762;&#x7684;&#x8DEF;&#x5F84;:-&gt;morestack_noctxt()-&gt;morestack()-&gt;newstack()
                                           // &#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x7684;f&#x5728;&#x6211;&#x8FD9;&#x91CC;&#x5E94;&#x8BE5;&#x662F;main.
                                           // &#x9700;&#x8981;&#x6CE8;&#x610F;morestack_noctxt&#x4E0E;morestack&#x4F7F;&#x7528;&#x7684;&#x6808;&#x5927;&#x5C0F;&#x90FD;&#x662F;0&#xFF0C;&#x4E14;&#x4ED6;&#x4EEC;&#x7684;&#x8DF3;&#x8F6C;&#x6CA1;&#x7528;call&#x6307;&#x4EE4;&#xFF0C;&#x4F7F;&#x7528;&#x7684;&#x662F;JMP
    MOVQ    AX, (m_morebuf+gobuf_pc)(BX)
    LEAQ    16(SP), AX    // f&apos;s caller&apos;s SP
    MOVQ    AX, (m_morebuf+gobuf_sp)(BX)
    get_tls(CX)  //...
    MOVQ    g(CX), SI
    MOVQ    SI, (m_morebuf+gobuf_g)(BX)

//&#x4FDD;&#x5B58;&#x5F53;&#x524D;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x4FE1;&#x606F;&#x5230;g-&gt;sched&#x4E2D;
    // Set g-&gt;sched to context in f.
    MOVQ    0(SP), AX // f&apos;s PC
    MOVQ    AX, (g_sched+gobuf_pc)(SI)
    MOVQ    SI, (g_sched+gobuf_g)(SI)
    LEAQ    8(SP), AX // f&apos;s SP
    MOVQ    AX, (g_sched+gobuf_sp)(SI) // &#x5728;morestack&#x91CC;&#x9762;&#x5C31;&#x5DF2;&#x7ECF;&#x4FDD;&#x5B58;&#x4E86;sp&#x7684;&#x503C;&#x3002;
    MOVQ    BP, (g_sched+gobuf_bp)(SI)
    MOVQ    DX, (g_sched+gobuf_ctxt)(SI)

//&#x628A;g0&#x8BBE;&#x7F6E;&#x4E3A;m&#x5F53;&#x524D;&#x8FD0;&#x884C;&#x7684;G; &#x628A;g0-&gt;sched-&gt;sp&#x6062;&#x590D;&#x5230;SP&#x5BC4;&#x5B58;&#x5668;&#x4E2D;;
    // Call newstack on m-&gt;g0&apos;s stack.
    MOVQ    m_g0(BX), BX
    MOVQ    BX, g(CX)
    MOVQ    (g_sched+gobuf_sp)(BX), SP // &#x628A;g0&#x7684;&#x6808;SP&#x5BC4;&#x5B58;&#x5668;&#x6062;&#x590D;&#x5230;&#x5B9E;&#x9645;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x4E2D;&#x3002;&#x6240;&#x4EE5;&#x4E0B;&#x9762;&#x5C31;&#x4F7F;&#x7528;&#x4E86;g0&#x7684;&#x6808;&#x3002;
//&#x8C03;&#x7528;newstack
    CALL    runtime&#xB7;newstack(SB)
    CALL    runtime&#xB7;abort(SB)    // crash if newstack returns
    RET
</code></pre><ul>
<li>&#x603B;&#x7ED3;&#x5C31;&#x662F;&#xFF1A;<ul>
<li>&#x5982;&#x679C;&#x5B83;&#x4E0B;&#x4E00;&#x6B21;&#x88AB;&#x8C03;&#x5EA6;&#x8D77;&#x6765;&#x4E86;&#xFF0C;&#x90A3;&#x4E48;&#x6267;&#x884C;PC&#xFF0C;&#x53C8;&#x4F1A;&#x91CD;&#x65B0;&#x5230;&#x672C;&#x51FD;&#x6570;&#x5934;&#x90E8;&#x6267;&#x884C;&#xFF0C;&#x4ECE;&#x4E0A;&#x9762;&#x5206;&#x6790;&#x4E5F;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x98CE;&#x9669;&#x5C31;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x6CA1;&#x6709;&#x8C03;&#x7528;&#x5176;&#x4ED6;&#x51FD;&#x6570;&#xFF0C;&#x90A3;&#x4E48;&#x65E0;&#x6CD5;&#x8FDB;&#x884C;&#x62A2;&#x5360;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C31;&#x662F;&#x57FA;&#x4E8E;&#x63D2;&#x5165;&#x62A2;&#x5360;&#xFF0C;1.14&#x57FA;&#x4E8E;&#x4FE1;&#x53F7;&#x62A2;&#x5360;&#x3002;</li>
<li>morestack&#x7C7B;&#x4F3C;&#x4E8E;mcall<ul>
<li>&#x4FDD;&#x5B58;&#x8C03;&#x7528;morestack&#x51FD;&#x6570;&#x7684;goroutine&#x5230;&#x5B83;&#x7684;sched&#x6210;&#x5458;&#x3002;</li>
<li>&#x5C06;&#x5F53;&#x524D;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x7684;g0&#x4E0E;&#x7EBF;&#x7A0B;TLS&#x5173;&#x8054;&#xFF1B;</li>
<li>&#x5C06;&#x5F53;&#x524D;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x7684;g0&#x6808;&#x6062;&#x590D;&#x5230;CPU&#x5BC4;&#x5B58;&#x5668;&#x3002;</li>
<li>&#x5728;g0&#x6808;&#x4E2D;&#x6267;&#x884C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x3002;---&gt;&#x8FD9;&#x91CC;&#x662F;<code>runtime&#xB7;newstack(SB)</code>&#x51FD;&#x6570;&#x3002;</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="newstacksb"><a name="newstacksb" class="anchor-navigation-ex-anchor" href="#newstacksb"><i class="fa fa-link" aria-hidden="true"></i></a>newstack(SB)</h5>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> newstack() {
    thisg := getg() <span class="hljs-comment">//&#x5230;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53C8;&#x662F;&#x5728;g0&#x6808;&#x91CC;&#x9762;&#x3002;</span>

    <span class="hljs-comment">//...</span>

    gp := thisg.m.curg <span class="hljs-comment">//&#x8FD9;&#x4E2A;&#x5C31;&#x662F;&#x539F;&#x6765;&#x7684;Goroutine.</span>

    <span class="hljs-comment">//...</span>

    <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> stackguard0 may change underfoot, if another thread</span>
    <span class="hljs-comment">// is about to try to preempt gp. Read it just once and use that same</span>
    <span class="hljs-comment">// value now and below.</span>
    preempt := atomic.Loaduintptr(&amp;gp.stackguard0) == stackPreempt <span class="hljs-comment">//&#x8FD9;&#x91CC;&#x5224;&#x65AD;&#x662F;&#x5426;&#x662F;&#x62A2;&#x5360; &#x6253;&#x4E86;stackguard0;</span>

    <span class="hljs-comment">// Be conservative about where we preempt.</span>
    <span class="hljs-comment">// We are interested in preempting user Go code, not runtime code.</span>
    <span class="hljs-comment">// If we&apos;re holding locks, mallocing, or preemption is disabled, don&apos;t</span>
    <span class="hljs-comment">// preempt.</span>
    <span class="hljs-comment">// This check is very early in newstack so that even the status change</span>
    <span class="hljs-comment">// from Grunning to Gwaiting and back doesn&apos;t happen in this case.</span>
    <span class="hljs-comment">// That status change by itself can be viewed as a small preemption,</span>
    <span class="hljs-comment">// because the GC might change Gwaiting to Gscanwaiting, and then</span>
    <span class="hljs-comment">// this goroutine has to wait for the GC to finish before continuing.</span>
    <span class="hljs-comment">// If the GC is in some way dependent on this goroutine (for example,</span>
    <span class="hljs-comment">// it needs a lock held by the goroutine), that small preemption turns</span>
    <span class="hljs-comment">// into a real deadlock.</span>
    <span class="hljs-keyword">if</span> preempt {
        <span class="hljs-comment">// &#x8FD9;&#x91CC;&#x8FD8;&#x68C0;&#x67E5;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x5982;&#x679C;&#x6EE1;&#x8DB3;&#x5C31;&#x4E0D;&#x62A2;&#x5360;&#x5B83;&#x4E86;&#xFF0C; &#x8BA9;&#x5B83;&#x7EE7;&#x7EED;&#x6267;&#x884C;&#x3002;</span>
        <span class="hljs-keyword">if</span> thisg.m.locks != <span class="hljs-number">0</span> || thisg.m.mallocing != <span class="hljs-number">0</span> || thisg.m.preemptoff != <span class="hljs-string">&quot;&quot;</span> || thisg.m.p.ptr().status != _Prunning {
            <span class="hljs-comment">// Let the goroutine keep running for now.</span>
            <span class="hljs-comment">// gp-&gt;preempt is set, so it will be preempted next time.</span>
            gp.stackguard0 = gp.stack.lo + _StackGuard <span class="hljs-comment">//&#x8FD8;&#x539F;stackguard0&#x4E3A;&#x6B63;&#x5E38;&#x503C;&#xFF0C;&#x8868;&#x793A;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x5904;&#x7406;&#x8FC7;&#x62A2;&#x5360;&#x8BF7;&#x6C42;&#x4E86;</span>
            gogo(&amp;gp.sched) <span class="hljs-comment">// never return</span>
        }
    }

    <span class="hljs-keyword">if</span> gp.stack.lo == <span class="hljs-number">0</span> {
        throw(<span class="hljs-string">&quot;missing stack in newstack&quot;</span>)
    }
    sp := gp.sched.sp
    <span class="hljs-keyword">if</span> sys.ArchFamily == sys.AMD64 || sys.ArchFamily == sys.I386 || sys.ArchFamily == sys.WASM {
        <span class="hljs-comment">// The call to morestack cost a word.</span>
        sp -= sys.PtrSize
    }
    <span class="hljs-keyword">if</span> stackDebug &gt;= <span class="hljs-number">1</span> || sp &lt; gp.stack.lo {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;runtime: newstack sp=&quot;</span>, hex(sp), <span class="hljs-string">&quot; stack=[&quot;</span>, hex(gp.stack.lo), <span class="hljs-string">&quot;, &quot;</span>, hex(gp.stack.hi), <span class="hljs-string">&quot;]\n&quot;</span>,
            <span class="hljs-string">&quot;\tmorebuf={pc:&quot;</span>, hex(morebuf.pc), <span class="hljs-string">&quot; sp:&quot;</span>, hex(morebuf.sp), <span class="hljs-string">&quot; lr:&quot;</span>, hex(morebuf.lr), <span class="hljs-string">&quot;}\n&quot;</span>,
            <span class="hljs-string">&quot;\tsched={pc:&quot;</span>, hex(gp.sched.pc), <span class="hljs-string">&quot; sp:&quot;</span>, hex(gp.sched.sp), <span class="hljs-string">&quot; lr:&quot;</span>, hex(gp.sched.lr), <span class="hljs-string">&quot; ctxt:&quot;</span>, gp.sched.ctxt, <span class="hljs-string">&quot;}\n&quot;</span>)
    }
    <span class="hljs-keyword">if</span> sp &lt; gp.stack.lo {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;runtime: gp=&quot;</span>, gp, <span class="hljs-string">&quot;, goid=&quot;</span>, gp.goid, <span class="hljs-string">&quot;, gp-&gt;status=&quot;</span>, hex(readgstatus(gp)), <span class="hljs-string">&quot;\n &quot;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;runtime: split stack overflow: &quot;</span>, hex(sp), <span class="hljs-string">&quot; &lt; &quot;</span>, hex(gp.stack.lo), <span class="hljs-string">&quot;\n&quot;</span>)
        throw(<span class="hljs-string">&quot;runtime: split stack overflow&quot;</span>)
    }

    <span class="hljs-keyword">if</span> preempt {
        <span class="hljs-keyword">if</span> gp == thisg.m.g0 {
            throw(<span class="hljs-string">&quot;runtime: preempt g0&quot;</span>)
        }
        <span class="hljs-keyword">if</span> thisg.m.p == <span class="hljs-number">0</span> &amp;&amp; thisg.m.locks == <span class="hljs-number">0</span> {
            throw(<span class="hljs-string">&quot;runtime: g is running but p is not&quot;</span>)
        }
        <span class="hljs-comment">// Synchronize with scang.</span>
        casgstatus(gp, _Grunning, _Gwaiting) <span class="hljs-comment">// &#x8BBE;&#x7F6E;gp&#x72B6;&#x6001;&#x53D8;&#x4E3A;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#x3002;&#x5904;&#x7406;gc&#x65F6;&#x628A;gp&#x7684;&#x72B6;&#x6001;&#x4FEE;&#x6539;&#x6210;_Gwaiting</span>
        <span class="hljs-keyword">if</span> gp.preemptscan { <span class="hljs-comment">//gc&#x76F8;&#x5173;&#xFF0C;&#x6682;&#x65F6;&#x5FFD;&#x7565;&#x3002;</span>
            <span class="hljs-keyword">for</span> !castogscanstatus(gp, _Gwaiting, _Gscanwaiting) {
                <span class="hljs-comment">// Likely to be racing with the GC as</span>
                <span class="hljs-comment">// it sees a _Gwaiting and does the</span>
                <span class="hljs-comment">// stack scan. If so, gcworkdone will</span>
                <span class="hljs-comment">// be set and gcphasework will simply</span>
                <span class="hljs-comment">// return.</span>
            }
            <span class="hljs-keyword">if</span> !gp.gcscandone {
                <span class="hljs-comment">// gcw is safe because we&apos;re on the</span>
                <span class="hljs-comment">// system stack.</span>
                gcw := &amp;gp.m.p.ptr().gcw
                scanstack(gp, gcw)
                gp.gcscandone = <span class="hljs-literal">true</span>
            }
            gp.preemptscan = <span class="hljs-literal">false</span>
            gp.preempt = <span class="hljs-literal">false</span>
            casfrom_Gscanstatus(gp, _Gscanwaiting, _Gwaiting)
            <span class="hljs-comment">// This clears gcscanvalid.</span>
            casgstatus(gp, _Gwaiting, _Grunning)
            gp.stackguard0 = gp.stack.lo + _StackGuard
            gogo(&amp;gp.sched) <span class="hljs-comment">// never return</span>
        }

        <span class="hljs-comment">// Act like goroutine called runtime.Gosched.</span>
        casgstatus(gp, _Gwaiting, _Grunning) <span class="hljs-comment">//&#x6062;&#x590D;&#x72B6;&#x6001;&#x3002;</span>
        gopreempt_m(gp) <span class="hljs-comment">// &#x653E;&#x5165;&#x5168;&#x5C40;&#x961F;&#x5217;&#xFF0C;&#x91CD;&#x65B0;schedule(); never return === gopreempt_m(gp)---call---&gt;goschedImpl(gp)----call--&gt;globrunqput()&#x653E;&#x5165;&#x5168;&#x5C40;&#x961F;&#x5217;/schedule()</span>
    }

    <span class="hljs-comment">//...</span>
}
</code></pre>
<blockquote>
<p>&#x8FD9;&#x91CC;&#x5C31;&#x7EE7;&#x7EED;&#x4E0A;&#x9762;&#x7684;&#xFF0C;&#x628A;&#x66FF;&#x6362;&#x6389;&#x7684;Goroutine&#x91CD;&#x65B0;&#x653E;&#x5165;&#x5168;&#x5C40;&#x961F;&#x5217;&#xFF1A;</p>
<blockquote>
<p><code>gopreempt_m(gp)---call---&gt;goschedImpl(gp)----call--&gt;globrunqput()&#x653E;&#x5165;&#x5168;&#x5C40;&#x961F;&#x5217;/schedule()</code></p>
</blockquote>
</blockquote>
<h2 id="&#x6808;&#x589E;&#x957F;&#x76F8;&#x5173;&#x4EE3;&#x7801;"><a name="&#x6808;&#x589E;&#x957F;&#x76F8;&#x5173;&#x4EE3;&#x7801;" class="anchor-navigation-ex-anchor" href="#&#x6808;&#x589E;&#x957F;&#x76F8;&#x5173;&#x4EE3;&#x7801;"><i class="fa fa-link" aria-hidden="true"></i></a>1.4. &#x6808;&#x589E;&#x957F;&#x76F8;&#x5173;&#x4EE3;&#x7801;</h2>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> newstack() {
    <span class="hljs-comment">//...&#x7701;&#x7565;&#x62A2;&#x5360;&#x7684;&#x4EE3;&#x7801;</span>

    <span class="hljs-comment">// Allocate a bigger segment and move the stack.</span>
    oldsize := gp.stack.hi - gp.stack.lo
    newsize := oldsize * <span class="hljs-number">2</span>  <span class="hljs-comment">// &#x65B0;&#x7684;&#x6808;&#x5927;&#x5C0F;&#x76F4;&#x63A5;*2</span>
    <span class="hljs-keyword">if</span> newsize &gt; maxstacksize {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;runtime: goroutine stack exceeds &quot;</span>, maxstacksize, <span class="hljs-string">&quot;-byte limit\n&quot;</span>)
        throw(<span class="hljs-string">&quot;stack overflow&quot;</span>)
    }

    <span class="hljs-comment">// The goroutine must be executing in order to call newstack,</span>
    <span class="hljs-comment">// so it must be Grunning (or Gscanrunning).</span>
    casgstatus(gp, _Grunning, _Gcopystack)

    <span class="hljs-comment">// The concurrent GC will not scan the stack while we are doing the copy since</span>
    <span class="hljs-comment">// the gp is in a Gcopystack status.</span>
    copystack(gp, newsize, <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">if</span> stackDebug &gt;= <span class="hljs-number">1</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;stack grow done\n&quot;</span>)
    }
    casgstatus(gp, _Gcopystack, _Grunning)
    gogo(&amp;gp.sched)
}
</code></pre>
<pre><code class="lang-go"><span class="hljs-keyword">func</span> copystack(gp *g, newsize <span class="hljs-keyword">uintptr</span>, sync <span class="hljs-keyword">bool</span>) {
    <span class="hljs-comment">//...</span>

    <span class="hljs-comment">// allocate new stack</span>
    <span class="hljs-built_in">new</span> := stackalloc(<span class="hljs-keyword">uint32</span>(newsize))

    <span class="hljs-comment">//...</span>
}
</code></pre>
<ul>
<li>stackalloc</li>
</ul>
<pre><code class="lang-go"><span class="hljs-comment">// stackalloc allocates an n byte stack.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// stackalloc must run on the system stack because it uses per-P</span>
<span class="hljs-comment">// resources and must not split the stack.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//go:systemstack</span>
<span class="hljs-keyword">func</span> stackalloc(n <span class="hljs-keyword">uint32</span>) stack {

    <span class="hljs-comment">// Small stacks are allocated with a fixed-size free-list allocator.</span>
    <span class="hljs-comment">// If we need a stack of a bigger size, we fall back on allocating</span>
    <span class="hljs-comment">// a dedicated span.</span>
    <span class="hljs-keyword">var</span> v unsafe.Pointer
    <span class="hljs-keyword">if</span> n &lt; _FixedStack&lt;&lt;_NumStackOrders &amp;&amp; n &lt; _StackCacheSize {
        <span class="hljs-comment">//&#x5C0F;&#x5806;&#x6808;&#x7528;&#x56FA;&#x5B9A;&#x5927;&#x5C0F;&#x7684;&#x81EA;&#x7531;&#x5217;&#x8868;&#x5206;&#x914D;&#x5668;&#x8FDB;&#x884C;&#x5206;&#x914D;&#x3002;</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">//...</span>
        <span class="hljs-keyword">if</span> s == <span class="hljs-literal">nil</span> {
            <span class="hljs-comment">// &#x5982;&#x679C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x66F4;&#x5927;&#x7684;&#x5806;&#x6808;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x91CD;&#x65B0;&#x5206;&#x914D;&#x4E00;&#x4E2A;span.</span>
            <span class="hljs-comment">// Allocate a new stack from the heap.</span>
            s = mheap_.allocManual(npage, &amp;memstats.stacks_inuse)
            <span class="hljs-keyword">if</span> s == <span class="hljs-literal">nil</span> {
                throw(<span class="hljs-string">&quot;out of memory&quot;</span>)
            }
            osStackAlloc(s)
            s.elemsize = <span class="hljs-keyword">uintptr</span>(n)
        }
        <span class="hljs-comment">//...</span>
    }
    <span class="hljs-comment">//...</span>
}
</code></pre>
<p><a href="https://medium.com/a-journey-with-go/go-how-does-the-goroutine-stack-size-evolve-447fc02085e5#id_token=eyJhbGciOiJSUzI1NiIsImtpZCI6IjAzYjJkMjJjMmZlY2Y4NzNlZDE5ZTViOGNmNzA0YWZiN2UyZWQ0YmUiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJuYmYiOjE2MTIxNjkyMDEsImF1ZCI6IjIxNjI5NjAzNTgzNC1rMWs2cWUwNjBzMnRwMmEyamFtNGxqZGNtczAwc3R0Zy5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsInN1YiI6IjEwMzk2OTgxODc3ODk3MjQyMjU0OSIsImVtYWlsIjoiZmZ6eGMuZG9AZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImF6cCI6IjIxNjI5NjAzNTgzNC1rMWs2cWUwNjBzMnRwMmEyamFtNGxqZGNtczAwc3R0Zy5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsIm5hbWUiOiJ0aW0gWmhhbyIsInBpY3R1cmUiOiJodHRwczovL2xoNS5nb29nbGV1c2VyY29udGVudC5jb20vLVVrRk9jak5NWUJzL0FBQUFBQUFBQUFJL0FBQUFBQUFBQUFBL0FNWnV1Y25LajAwY21MVkhuZGpYakxGVVZWX1JHWnJ0OXcvczk2LWMvcGhvdG8uanBnIiwiZ2l2ZW5fbmFtZSI6InRpbSIsImZhbWlseV9uYW1lIjoiWmhhbyIsImlhdCI6MTYxMjE2OTUwMSwiZXhwIjoxNjEyMTczMTAxLCJqdGkiOiI5ZWZhMzYwMDUwOGNhZjg0MWMyYjQ5YmE1NDQxMWNkMGQzNmE0YzliIn0.qaSr0IXzZ3BXiIndb18-qLZpwNMDi3fEGlR-OtbQryxR8MkhONlgB-BTN5vHjYuvmWdCdGywJn26T71jPqBRVuIXMNlriZLFwPvHKdTBRrvpkPoFs8LprEpsCyZbTN7qNU5-CfDzcC1fHZji2j7992Ngo3XVd9v-6LiKCGUeolZ7CGH6KvT1e67ckiCzEN2oG5q6v7zKW32FmF7cajuOHl12p2pn6LaHxlYm3o38N3O9c96cO04meQ7WzZKn6QVoZeDIvmzq1iIKYOCbU0edZiOXgRgGHkBeBOowi-DHCz9kSJ1HkNrdzyjEC2nKUqerVGTCAc08w9BjtA8o_RmA8g" target="_blank">https://medium.com/a-journey-with-go/go-how-does-the-goroutine-stack-size-evolve-447fc02085e5#id_token=eyJhbGciOiJSUzI1NiIsImtpZCI6IjAzYjJkMjJjMmZlY2Y4NzNlZDE5ZTViOGNmNzA0YWZiN2UyZWQ0YmUiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJuYmYiOjE2MTIxNjkyMDEsImF1ZCI6IjIxNjI5NjAzNTgzNC1rMWs2cWUwNjBzMnRwMmEyamFtNGxqZGNtczAwc3R0Zy5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsInN1YiI6IjEwMzk2OTgxODc3ODk3MjQyMjU0OSIsImVtYWlsIjoiZmZ6eGMuZG9AZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImF6cCI6IjIxNjI5NjAzNTgzNC1rMWs2cWUwNjBzMnRwMmEyamFtNGxqZGNtczAwc3R0Zy5hcHBzLmdvb2dsZXVzZXJjb250ZW50LmNvbSIsIm5hbWUiOiJ0aW0gWmhhbyIsInBpY3R1cmUiOiJodHRwczovL2xoNS5nb29nbGV1c2VyY29udGVudC5jb20vLVVrRk9jak5NWUJzL0FBQUFBQUFBQUFJL0FBQUFBQUFBQUFBL0FNWnV1Y25LajAwY21MVkhuZGpYakxGVVZWX1JHWnJ0OXcvczk2LWMvcGhvdG8uanBnIiwiZ2l2ZW5fbmFtZSI6InRpbSIsImZhbWlseV9uYW1lIjoiWmhhbyIsImlhdCI6MTYxMjE2OTUwMSwiZXhwIjoxNjEyMTczMTAxLCJqdGkiOiI5ZWZhMzYwMDUwOGNhZjg0MWMyYjQ5YmE1NDQxMWNkMGQzNmE0YzliIn0.qaSr0IXzZ3BXiIndb18-qLZpwNMDi3fEGlR-OtbQryxR8MkhONlgB-BTN5vHjYuvmWdCdGywJn26T71jPqBRVuIXMNlriZLFwPvHKdTBRrvpkPoFs8LprEpsCyZbTN7qNU5-CfDzcC1fHZji2j7992Ngo3XVd9v-6LiKCGUeolZ7CGH6KvT1e67ckiCzEN2oG5q6v7zKW32FmF7cajuOHl12p2pn6LaHxlYm3o38N3O9c96cO04meQ7WzZKn6QVoZeDIvmzq1iIKYOCbU0edZiOXgRgGHkBeBOowi-DHCz9kSJ1HkNrdzyjEC2nKUqerVGTCAc08w9BjtA8o_RmA8g</a></p>
<h4 id="&#x6267;&#x884C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x62A2;&#x5360;"><a name="&#x6267;&#x884C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x62A2;&#x5360;" class="anchor-navigation-ex-anchor" href="#&#x6267;&#x884C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x62A2;&#x5360;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6267;&#x884C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x62A2;&#x5360;</h4>
<blockquote>
<p>handoffp&#x51FD;&#x6570;:&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x542F;&#x52A8;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x6765;&#x63A5;&#x7BA1;<em>p</em>&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x9700;&#x8981;&#x5219;&#x628A;<em>p</em>&#x653E;&#x5165;P&#x7684;&#x5168;&#x5C40;&#x7A7A;&#x95F2;&#x961F;&#x5217;.</p>
</blockquote>
<pre><code class="lang-go"><span class="hljs-comment">// Hands off P from syscall or locked M.</span>
<span class="hljs-comment">// Always runs without a P, so write barriers are not allowed.</span>
<span class="hljs-comment">//go:nowritebarrierrec</span>
<span class="hljs-keyword">func</span> handoffp(_p_ *p) {
    <span class="hljs-comment">// handoffp must start an M in any situation where</span>
    <span class="hljs-comment">// findrunnable would return a G to run on _p_.</span>

    <span class="hljs-comment">// if it has local work, start it straight away</span>
    <span class="hljs-keyword">if</span> !runqempty(_p_) || sched.runqsize != <span class="hljs-number">0</span> {  <span class="hljs-comment">// &#x8FD0;&#x884C;&#x961F;&#x5217;&#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x9700;&#x8981;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;m&#x6765;&#x63A5;&#x7BA1;,&#x800C;&#x4E0D;&#x662F;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;M&#x7ED3;&#x6784;&#x4F53;,&#x548C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;;</span>
        startm(_p_, <span class="hljs-literal">false</span>) <span class="hljs-comment">// &#x8FD9;&#x4E2A;&#x6211;&#x4EEC;&#x524D;&#x9762;&#x8BA8;&#x8BBA;&#x8FC7;,</span>
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// if it has GC work, start it straight away</span>
    <span class="hljs-keyword">if</span> gcBlackenEnabled != <span class="hljs-number">0</span> &amp;&amp; gcMarkWorkAvailable(_p_) {  <span class="hljs-comment">// &#x5982;&#x679C;&#x6709;GC&#x5DE5;&#x4F5C;&#xFF0C;&#x5C31;&#x7ACB;&#x5373;&#x5F00;&#x59CB;</span>
        startm(_p_, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// no local work, check that there are no spinning/idle M&apos;s,</span>
    <span class="hljs-comment">// otherwise our help is not required</span>
    <span class="hljs-comment">// &#x6CA1;&#x6709;&#x7A7A;&#x95F2;&#x7684;P,&#x6CA1;&#x6709;&#x81EA;&#x65CB;&#x72B6;&#x6001;&#x7684;Ms;&#x6240;&#x6709;&#x5176;&#x5B83;p&#x90FD;&#x5728;&#x8FD0;&#x884C;goroutine&#xFF0C;&#x8BF4;&#x660E;&#x7CFB;&#x7EDF;&#x6BD4;&#x8F83;&#x5FD9;&#xFF0C;&#x9700;&#x8981;&#x542F;&#x52A8;m</span>
    <span class="hljs-keyword">if</span> atomic.Load(&amp;sched.nmspinning)+atomic.Load(&amp;sched.npidle) == <span class="hljs-number">0</span> &amp;&amp; atomic.Cas(&amp;sched.nmspinning, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) { <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> fast atomic</span>
        startm(_p_, <span class="hljs-literal">true</span>)
        <span class="hljs-keyword">return</span>
    }
    lock(&amp;sched.lock)
    <span class="hljs-keyword">if</span> sched.gcwaiting != <span class="hljs-number">0</span> {
        _p_.status = _Pgcstop
        sched.stopwait--
        <span class="hljs-keyword">if</span> sched.stopwait == <span class="hljs-number">0</span> {
            notewakeup(&amp;sched.stopnote)
        }
        unlock(&amp;sched.lock)
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> _p_.runSafePointFn != <span class="hljs-number">0</span> &amp;&amp; atomic.Cas(&amp;_p_.runSafePointFn, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) {
        sched.safePointFn(_p_)
        sched.safePointWait--
        <span class="hljs-keyword">if</span> sched.safePointWait == <span class="hljs-number">0</span> {
            notewakeup(&amp;sched.safePointNote)
        }
    }
    <span class="hljs-keyword">if</span> sched.runqsize != <span class="hljs-number">0</span> { <span class="hljs-comment">// &#x5168;&#x5C40;&#x8FD0;&#x884C;&#x961F;&#x5217;&#x5927;&#x5C0F;&#x4E0D;&#x662F;0; &#x8BF4;&#x660E;Goroutine&#x9700;&#x8981;&#x8FD0;&#x884C;,&#x6709;&#x5DE5;&#x4F5C;&#x8981;&#x505A;.</span>
        unlock(&amp;sched.lock)
        startm(_p_, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// If this is the last running P and nobody is polling network,</span>
    <span class="hljs-comment">// need to wakeup another M to poll network.</span>
    <span class="hljs-comment">// &#x6240;&#x6709;&#x5176;&#x5B83;P&#x90FD;&#x5DF2;&#x7ECF;&#x5904;&#x4E8E;&#x7A7A;&#x95F2;&#x72B6;&#x6001;,&#x53EA;&#x6709;&#x81EA;&#x5DF1;&#x4E00;&#x4E2A;P&#x8FD8;&#x5728;&#x8FD0;&#x884C;;</span>
    <span class="hljs-comment">// &#x4E14;&#x8FD9;&#x65F6;&#x5019;&#x9700;&#x8981;&#x76D1;&#x63A7;&#x7F51;&#x7EDC;&#x8FDE;&#x63A5;&#x8BFB;&#x5199;&#x4E8B;&#x4EF6;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x542F;&#x52A8;&#x65B0;&#x7684;m&#x6765;poll&#x7F51;&#x7EDC;&#x8FDE;&#x63A5;</span>
    <span class="hljs-keyword">if</span> sched.npidle == <span class="hljs-keyword">uint32</span>(gomaxprocs<span class="hljs-number">-1</span>) &amp;&amp; atomic.Load64(&amp;sched.lastpoll) != <span class="hljs-number">0</span> {
        unlock(&amp;sched.lock)
        startm(_p_, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span>
    }
    pidleput(_p_)  <span class="hljs-comment">// &#x65E0;&#x4E8B;&#x53EF;&#x505A;&#xFF0C;&#x628A;p&#x653E;&#x5165;&#x5168;&#x5C40;&#x7A7A;&#x95F2;&#x961F;&#x5217;</span>
    unlock(&amp;sched.lock)
}
</code></pre>
<blockquote>
<p>&#x9700;&#x8981;&#x542F;&#x52A8;&#x5DE5;&#x4F5C;&#x7EBF;&#x7A0B;&#x6765;&#x63A5;&#x7BA1;P.</p>
<ol>
<li><em>p</em>&#x7684;&#x672C;&#x5730;&#x8FD0;&#x884C;&#x961F;&#x5217;&#x6216;&#x5168;&#x5C40;&#x8FD0;&#x884C;&#x961F;&#x5217;&#x91CC;&#x9762;&#x6709;&#x5F85;&#x8FD0;&#x884C;&#x7684;goroutine&#xFF1B;</li>
<li>&#x9700;&#x8981;&#x5E2E;&#x52A9;gc&#x5B8C;&#x6210;&#x6807;&#x8BB0;&#x5DE5;&#x4F5C;&#xFF1B;</li>
<li>&#x7CFB;&#x7EDF;&#x6BD4;&#x8F83;&#x5FD9;&#xFF0C;&#x6240;&#x6709;&#x5176;&#x5B83;<em>p</em>&#x90FD;&#x5728;&#x8FD0;&#x884C;goroutine&#xFF0C;&#x9700;&#x8981;&#x5E2E;&#x5FD9;&#xFF1B;</li>
<li>&#x6240;&#x6709;&#x5176;&#x5B83;P&#x90FD;&#x5DF2;&#x7ECF;&#x5904;&#x4E8E;&#x7A7A;&#x95F2;&#x72B6;&#x6001;&#xFF0C;&#x5982;&#x679C;&#x9700;&#x8981;&#x76D1;&#x63A7;&#x7F51;&#x7EDC;&#x8FDE;&#x63A5;&#x8BFB;&#x5199;&#x4E8B;&#x4EF6;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x542F;&#x52A8;&#x65B0;&#x7684;m&#x6765;poll&#x7F51;&#x7EDC;&#x8FDE;&#x63A5;&#x3002;</li>
</ol>
</blockquote>
<p>&#x5176;&#x4E2D;startm&#x51FD;&#x6570;&#x6211;&#x4EEC;&#x524D;&#x9762;&#x4ECB;&#x7ECD;&#x8FC7;.
<img src="https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200917153130.png" alt="startm"></p>
<h2 id="&#x989D;&#x5916;&#x7684;&#x4F8B;&#x5B50;"><a name="&#x989D;&#x5916;&#x7684;&#x4F8B;&#x5B50;" class="anchor-navigation-ex-anchor" href="#&#x989D;&#x5916;&#x7684;&#x4F8B;&#x5B50;"><i class="fa fa-link" aria-hidden="true"></i></a>1.5. &#x989D;&#x5916;&#x7684;&#x4F8B;&#x5B50;</h2>
<h3 id="&#x5B9A;&#x4E49;&#x7A0B;&#x5E8F;"><a name="&#x5B9A;&#x4E49;&#x7A0B;&#x5E8F;" class="anchor-navigation-ex-anchor" href="#&#x5B9A;&#x4E49;&#x7A0B;&#x5E8F;"><i class="fa fa-link" aria-hidden="true"></i></a>1.5.1. &#x5B9A;&#x4E49;&#x7A0B;&#x5E8F;</h3>
<blockquote>
<p>main.go</p>
</blockquote>
<pre><code class="lang-go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span>

<span class="hljs-keyword">func</span> call_some_job() {

    fmt.Println(<span class="hljs-string">&quot;complete this job&quot;</span>)
}

<span class="hljs-keyword">func</span> main() {
    <span class="hljs-keyword">for</span> i:=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">100000</span>; i++{
        i=i
    }
    call_some_job()
}
</code></pre>
<h3 id="gdb&#x8C03;&#x8BD5;&#x524D;&#x51C6;&#x5907;"><a name="gdb&#x8C03;&#x8BD5;&#x524D;&#x51C6;&#x5907;" class="anchor-navigation-ex-anchor" href="#gdb&#x8C03;&#x8BD5;&#x524D;&#x51C6;&#x5907;"><i class="fa fa-link" aria-hidden="true"></i></a>1.5.2. gdb&#x8C03;&#x8BD5;&#x524D;&#x51C6;&#x5907;</h3>
<h3 id="&#x7F16;&#x8BD1;&#x7A0B;&#x5E8F;"><a name="&#x7F16;&#x8BD1;&#x7A0B;&#x5E8F;" class="anchor-navigation-ex-anchor" href="#&#x7F16;&#x8BD1;&#x7A0B;&#x5E8F;"><i class="fa fa-link" aria-hidden="true"></i></a>1.5.3. &#x7F16;&#x8BD1;&#x7A0B;&#x5E8F;</h3>
<p>&#x7F16;&#x8BD1;&#x4E00;&#x4E0B;&#x6E90;&#x4EE3;&#x7801;: <code>go build  -gcflags &quot;-N -l&quot; -o test .</code>.</p>
<h4 id="&#x51C6;&#x5907;mcall&#x51FD;&#x6570;&#x65AD;&#x70B9;&#x7684;&#x6587;&#x4EF6;"><a name="&#x51C6;&#x5907;mcall&#x51FD;&#x6570;&#x65AD;&#x70B9;&#x7684;&#x6587;&#x4EF6;" class="anchor-navigation-ex-anchor" href="#&#x51C6;&#x5907;mcall&#x51FD;&#x6570;&#x65AD;&#x70B9;&#x7684;&#x6587;&#x4EF6;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x51C6;&#x5907;mcall&#x51FD;&#x6570;&#x65AD;&#x70B9;&#x7684;&#x6587;&#x4EF6;</h4>
<ul>
<li>gdb<ul>
<li><code>list /usr/lib/golang/src/runtime/proc.go:267</code></li>
<li><code>list /tmp/kubernets/test_preempt/main.go:1</code></li>
<li><code>list /usr/lib/golang/src/runtime/asm_amd64.s:454</code></li>
</ul>
</li>
</ul>
<h4 id="gdb&#x8C03;&#x8BD5;&#x81EA;&#x5B9A;&#x4E49;&#x51FD;&#x6570;"><a name="gdb&#x8C03;&#x8BD5;&#x81EA;&#x5B9A;&#x4E49;&#x51FD;&#x6570;" class="anchor-navigation-ex-anchor" href="#gdb&#x8C03;&#x8BD5;&#x81EA;&#x5B9A;&#x4E49;&#x51FD;&#x6570;"><i class="fa fa-link" aria-hidden="true"></i></a>gdb&#x8C03;&#x8BD5;&#x81EA;&#x5B9A;&#x4E49;&#x51FD;&#x6570;</h4>
<pre><code class="lang-gdb">define zxc
info threads
info register rbp rsp pc
end
</code></pre>
<h4 id="gdb"><a name="gdb" class="anchor-navigation-ex-anchor" href="#gdb"><i class="fa fa-link" aria-hidden="true"></i></a>gdb</h4>
<pre><code class="lang-test">[root@gitlab test_preempt]# gdb ./test
GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7
Copyright (C) 2013 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;
and &quot;show warranty&quot; for details.
This GDB was configured as &quot;x86_64-redhat-linux-gnu&quot;.
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;...
Reading symbols from /tmp/kubernets/test_preempt/test...done.
Loading Go Runtime support.
(gdb) list
1    package main
2
3    import &quot;fmt&quot;
4
5    func call_some_job() {
6
7        fmt.Println(&quot;complete this job&quot;)
8    }
9
10    func main() {
(gdb)
11        call_some_job()
12    }
(gdb) b 10
Breakpoint 1 at 0x48cf90: file /tmp/kubernets/test_preempt/main.go, line 10.
(gdb) run
Starting program: /tmp/kubernets/test_preempt/./test

Breakpoint 1, main.main () at /tmp/kubernets/test_preempt/main.go:10
10    func main() {
(gdb) disas
Dump of assembler code for function main.main:
=&gt; 0x000000000048cf90 &lt;+0&gt;:        mov    %fs:0xfffffffffffffff8,%rcx     --------------------------------here
   0x000000000048cf99 &lt;+9&gt;:     cmp    0x10(%rcx),%rsp                     --------------------------------here
   0x000000000048cf9d &lt;+13&gt;:    jbe    0x48cfb9 &lt;main.main+41&gt;
   0x000000000048cf9f &lt;+15&gt;:    sub    $0x8,%rsp
   0x000000000048cfa3 &lt;+19&gt;:    mov    %rbp,(%rsp)
   0x000000000048cfa7 &lt;+23&gt;:    lea    (%rsp),%rbp
   0x000000000048cfab &lt;+27&gt;:    callq  0x48cef0 &lt;main.call_some_job&gt;
   0x000000000048cfb0 &lt;+32&gt;:    mov    (%rsp),%rbp
   0x000000000048cfb4 &lt;+36&gt;:    add    $0x8,%rsp
   0x000000000048cfb8 &lt;+40&gt;:    retq
   0x000000000048cfb9 &lt;+41&gt;:    callq  0x4517d0 &lt;runtime.morestack_noctxt&gt; --------------------------------here
   0x000000000048cfbe &lt;+46&gt;:    jmp    0x48cf90 &lt;main.main&gt;
End of assembler dump.
</code></pre>
<p>&#x4E0A;&#x9762;&#x4E09;&#x4E2A;<code>--------------------------------here</code>,&#x524D;&#x9762;&#x6211;&#x4EEC;&#x8BF4;&#x7684;&#x5F88;&#x6E05;&#x695A;,&#x5C31;&#x662F;g.stack.stackguard0&#x4E0E;sp&#x5BC4;&#x5B58;&#x5668;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;,&#x5982;&#x679C;sp&#x5C0F;&#x4E8E;g.stack.stackguard0
&#x5C31;&#x8DF3;&#x8F6C;&#x5230;<code>runtime.morestack_noctxt</code>;&#x800C;&#x6211;&#x4EEC;&#x524D;&#x9762;&#x8BBE;&#x7F6E;preempt:<code>gp.stackguard0 = stackPreempt //stackguard0==&#x5F88;&#x5927;&#x7684;&#x6570;; &#x4F7F;&#x88AB;&#x62A2;&#x5360;&#x7684;goroutine;&#x5728;&#x8FDB;&#x884C;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x4F1A;&#x53BB;&#x68C0;&#x67E5;&#x6808;&#x6EA2;&#x51FA;;&#x53BB;&#x5904;&#x7406;&#x62A2;&#x5360;&#x8BF7;&#x6C42;</code>,&#x5B83;&#x5FC5;&#x5B9A;&#x6BD4;sp&#x8981;&#x5927;,&#x6240;&#x4EE5;&#x80AF;&#x5B9A;&#x8DF3;&#x8F6C;&#x5230;&#x4E86;<code>runtime.morestack_noctxt</code></p>
<blockquote>
<p><code>MOVQ    0(SP), AX // f&apos;s PC</code>,&#x5C31;&#x662F;caller&apos;s pc&#x662F;&#x56E0;&#x4E3A;&#x5B83;&#x7684;rbp&#x5728;&#x90A3;&#x4E00;&#x6B65;&#x8FD8;&#x6CA1;&#x6709;&#x4FDD;&#x5B58;&#x5230;callee&#x2018;s stack&#x7A7A;&#x95F4;.</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200918212350.png" alt="MOVQ    0(SP), AX // f&apos;s PC"></p>
<p>&#x90A3;&#x7EE7;&#x7EED;&#x6765;&#x770B;&#x5982;&#x679C;&#x5982;&#x679C;&#x8C03;&#x7528;<code>&lt;runtime.morestack_noctxt&gt;</code>,&#x5B83;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;PC&#x5C31;&#x662F;<code>jmp    0x48cf90 &lt;main.main&gt;</code>&#x53C8;&#x91CD;&#x65B0;&#x8DF3;&#x56DE;&#x6765;&#x4E86;.
&#x770B;&#x8FD9;&#x4E2A;
<img src="https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200921193622.png" alt="disas"></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="2.2.被动调度.html" class="navigation navigation-prev " aria-label="Previous page: 被动调度">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="2.3.2.系统调用收尾,如果从系统调用返回,如何重新得到P.html" class="navigation navigation-next " aria-label="Next page: 系统调用收尾,如果从系统调用返回,如何重新得到P">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"运行用户代码时间过长调度","date":"2020-05-04T12:35:00.000Z","tags":["golang","goroutine"],"categories":["golang调度"],"toc":true,"level":"1.6.2.3","depth":3,"next":{"title":"系统调用收尾,如果从系统调用返回,如何重新得到P","level":"1.6.2.4","depth":3,"path":"part3.调度/2.调度的时机/2.3.2.系统调用收尾,如果从系统调用返回,如何重新得到P.md","ref":"part3.调度/2.调度的时机/2.3.2.系统调用收尾,如果从系统调用返回,如何重新得到P.md","articles":[]},"previous":{"title":"被动调度","level":"1.6.2.2","depth":3,"path":"part3.调度/2.调度的时机/2.2.被动调度.md","ref":"part3.调度/2.调度的时机/2.2.被动调度.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-page-toc-button","-toc2","anchor-navigation-ex"],"styles":{"website":"./styles/website.css"},"pluginsConfig":{"search":{},"toc2":{"addClass":true,"className":"toc"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"anchor-navigation-ex":{"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"fa fa-hand-o-right","level2Icon":"fa fa-hand-o-right","level3Icon":"fa fa-hand-o-right","showLevelIcon":false},"mode":"float","multipleH1":true,"pageTop":{"level1Icon":"fa fa-hand-o-right","level2Icon":"fa fa-hand-o-right","level3Icon":"fa fa-hand-o-right","showLevelIcon":false},"printLog":false,"showGoTop":true,"showLevel":true},"page-toc-button":{"maxTocDepth":2,"minTocSize":2},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"zput","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"golang goroutine详解","language":"zh-hans","links":{"sidebar":{"zput|堆排序":"https://zput.github.io"}},"gitbook":"3.2.3","description":"select * from learn"},"file":{"path":"part3.调度/2.调度的时机/2.3.1.运行用户代码时间过长调度.md","mtime":"2021-03-28T09:04:44.796Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-03-28T09:05:35.583Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

