<!doctype html><html lang=zh dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='看下这个调用图
digraph cacheSpan { rankdir=TB; node[shape=box]; start[label="开始"]; end[label="结束"]; sg[label="获取当前 sweepgen 值"]; nonempty[label="遍历非空 span 列表"]; sweepgen[label="如果内存单元的 sweepgen 等于 mheap.sweepgen - 2， 那么意味着当前单元需要清理 \n如果等于 mheap.sweepgen - 1，那么当前管理单元就正在清理";shape=plain; ] empty[label="遍历空 span 列表"]; sweep[label="清理 span 并将其添加到空 span 列表"]; free[label="释放部分空间"]; grow[label="创建新的 span 并添加到空 span 列表"]; cache[label="重新填充 span 的分配缓存"]; have[label="返回 span 指针"]; // 处理mspan subgraph cluster_span { style = dotted margin = 10 "块(span)" [shape = plaintext;fontsize = 24] "mheap.alloc_m" "notice1" [shape=plain;label="在这里才设置mspan中的spanclass"] {rank=same; "notice1" -> "mheap.alloc_m"[dir=none]; } } start -> sg; {rank=same; sweepgen -> nonempty[style=invis];} sg -> nonempty -> sweep -> empty -> free -> have; nonempty -> empty; empty -> grow -> cache -> have; have->end; } mcentral中有六个mspan列表，分别是:'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://zput.github.io/go-goroutine/docs/runtime/heap/ch0_prespective_of_uses/alloc_middle_object/"><meta property="og:site_name" content="go调度源码分析"><meta property="og:title" content="概述"><meta property="og:description" content='看下这个调用图
digraph cacheSpan { rankdir=TB; node[shape=box]; start[label="开始"]; end[label="结束"]; sg[label="获取当前 sweepgen 值"]; nonempty[label="遍历非空 span 列表"]; sweepgen[label="如果内存单元的 sweepgen 等于 mheap.sweepgen - 2， 那么意味着当前单元需要清理 \n如果等于 mheap.sweepgen - 1，那么当前管理单元就正在清理";shape=plain; ] empty[label="遍历空 span 列表"]; sweep[label="清理 span 并将其添加到空 span 列表"]; free[label="释放部分空间"]; grow[label="创建新的 span 并添加到空 span 列表"]; cache[label="重新填充 span 的分配缓存"]; have[label="返回 span 指针"]; // 处理mspan subgraph cluster_span { style = dotted margin = 10 "块(span)" [shape = plaintext;fontsize = 24] "mheap.alloc_m" "notice1" [shape=plain;label="在这里才设置mspan中的spanclass"] {rank=same; "notice1" -> "mheap.alloc_m"[dir=none]; } } start -> sg; {rank=same; sweepgen -> nonempty[style=invis];} sg -> nonempty -> sweep -> empty -> free -> have; nonempty -> empty; empty -> grow -> cache -> have; have->end; } mcentral中有六个mspan列表，分别是:'><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>概述 | go调度源码分析</title>
<link rel=manifest href=/go-goroutine/manifest.json><link rel=icon href=/go-goroutine/favicon.png><link rel=stylesheet href=/go-goroutine/book.min.a7d3a43391e1f7eb43ae94bcae6354b739c49cba56473620924ec707afe0864d.css integrity="sha256-p9OkM5Hh9+tDrpS8rmNUtznEnLpWRzYgkk7HB6/ghk0=" crossorigin=anonymous><script defer src=/go-goroutine/flexsearch.min.js></script><script defer src=/go-goroutine/en.search.min.24545fbdbe0e07719c61e8e255136712ddc868686118f891f5aa7aaec854635b.js integrity="sha256-JFRfvb4OB3GcYejiVRNnEt3IaGhhGPiR9ap6rshUY1s=" crossorigin=anonymous></script><script defer src=/go-goroutine/sw.min.ec96d6e09af3075a94dd4de723a2edddf2ef138381c7e1e5b5a1f2c0578ee8bd.js integrity="sha256-7JbW4JrzB1qU3U3nI6Lt3fLvE4OBx+HltaHywFeO6L0=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/go-goroutine/><span>go调度源码分析</span></a></h2><div class=magic><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64><div class="book-search-spinner spinner hidden"></div><ul id=book-search-results></ul></div><div class=book-switch><label class=switch><input id=dark-mode-checkbox type=checkbox onchange=darkmode()>
<span class=slider></span></label></div></div><ul><li><a href=https://zput.github.io target=_blank rel=noopener>Zput博客</a></li><li><a href=https://github.com/zput target=_blank rel=noopener>GitHub</a></li></ul><hr><ul><li><span>基础知识</span><ul><li><a href=/go-goroutine/docs/foundation/golang_basic/>基本用法</a></li><li><a href=/go-goroutine/docs/foundation/slice/>slice</a></li><li><a href=/go-goroutine/docs/foundation/map/>map</a></li><li><a href=/go-goroutine/docs/foundation/sort/>sort</a></li><li><a href=/go-goroutine/docs/foundation/directory/>Directory</a></li></ul></li><li><span>鲁棒和性能</span><ul><li><a href=/go-goroutine/docs/robustness_and_performance/golang_test/>测试相关函数</a></li></ul></li><li><span>运行时</span><ul><li><a href=/go-goroutine/docs/runtime/golang_gmp/>GMP</a></li><li><span>堆分配原理</span><ul><li><a href=/go-goroutine/docs/runtime/heap/ch0_prespective_of_uses/1_summarize/>概述</a></li><li><a href=/go-goroutine/docs/runtime/heap/ch0_prespective_of_uses/alloc_big_object/>分配大对象</a></li><li><a href=/go-goroutine/docs/runtime/heap/ch0_prespective_of_uses/alloc_middle_object/ class=active>概述</a></li><li><a href=/go-goroutine/docs/runtime/heap/ch0_prespective_of_uses/alloc_small_object/>概述</a></li></ul></li><li><a href=/go-goroutine/docs/runtime/complement-source-reverse/>源码-反码-补码</a></li><li><a href=/go-goroutine/docs/runtime/golang_memery/>内存分配器</a></li><li><a href=/go-goroutine/docs/runtime/golang_gc/>垃圾回收</a></li><li><a href=/go-goroutine/docs/runtime/schedule/>调度</a><ul><li><span>前置知识</span><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/memory/>内存大小端</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/register_functionstack/>伪寄存器与函数栈帧</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/similar_assemble/>类汇编</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch0-preknowledge/go_underlying_struct/>底层重要结构</a></li></ul></li><li><a href=/go-goroutine/docs/runtime/schedule/2_init_before_enter_main_function/>初始化</a></li><li><a href=/go-goroutine/docs/runtime/schedule/3_exit_goroutine/>退出</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/>调度挑选策略</a><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/take_goroutine_from_globalorlocal_p/>从全局/本P队列</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch1-scheduling_selection_strategy/steal_goroutine_from_other_p/>从其他P队列</a></li></ul></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/>调度到达时机</a><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/active_scheduling/>主动调度</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/passive_scheduling/>被动调度</a></li><li><input type=checkbox id=section-740657f38f0c4de9a986bda642ff0388 class=toggle>
<label for=section-740657f38f0c4de9a986bda642ff0388 class="flex justify-between"><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/>剥夺调度</a></label><ul><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/start_sysmon/>开启系统监控</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/user_code_preemption/>代码执行过久</a></li><li><a href=/go-goroutine/docs/runtime/schedule/ch2-Scheduling_arrival_time/deprivation_of_scheduling/system_call_preemption/>陷入系统调用</a></li></ul></li></ul></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script><script src=/go-goroutine/magic.js></script><script src=/go-goroutine/dark.js></script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/go-goroutine/svg/menu.svg class=book-icon alt=Menu>
</label><strong>概述</strong>
<label for=toc-control><img src=/go-goroutine/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#cachespan>cacheSpan</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><p>看下这个调用图</p><pre tabindex=0><code class=language-graphviz data-lang=graphviz>
digraph cacheSpan {
    rankdir=TB;
    node[shape=box];

    start[label=&#34;开始&#34;];
    end[label=&#34;结束&#34;];

    sg[label=&#34;获取当前 sweepgen 值&#34;];

    nonempty[label=&#34;遍历非空 span 列表&#34;];

    sweepgen[label=&#34;如果内存单元的 sweepgen 等于 mheap.sweepgen - 2， 那么意味着当前单元需要清理 \n如果等于 mheap.sweepgen - 1，那么当前管理单元就正在清理&#34;;shape=plain; ]

    empty[label=&#34;遍历空 span 列表&#34;];

    sweep[label=&#34;清理 span 并将其添加到空 span 列表&#34;];
    free[label=&#34;释放部分空间&#34;];
    grow[label=&#34;创建新的 span 并添加到空 span 列表&#34;];
    cache[label=&#34;重新填充 span 的分配缓存&#34;];

    have[label=&#34;返回 span 指针&#34;];



    // 处理mspan
	subgraph cluster_span {
		style = dotted
		margin = 10
		&#34;块(span)&#34; [shape = plaintext;fontsize = 24]

        &#34;mheap.alloc_m&#34;
        &#34;notice1&#34; [shape=plain;label=&#34;在这里才设置mspan中的spanclass&#34;] 
        {rank=same; &#34;notice1&#34; -&gt; &#34;mheap.alloc_m&#34;[dir=none]; }
	}

    start -&gt; sg;

    {rank=same; sweepgen -&gt; nonempty[style=invis];}

    sg -&gt; nonempty -&gt; sweep -&gt; empty -&gt; free -&gt; have;


    nonempty -&gt; empty;
    empty -&gt; grow -&gt; cache -&gt; have;

    have-&gt;end;

}
</code></pre><p>mcentral中有六个mspan列表，分别是:</p><ul><li>有空闲空间<ul><li>尚未清扫</li><li>正在清扫</li><li>已经清扫</li></ul></li><li>没有空闲空间<ul><li>尚未清扫</li><li>正在清扫</li><li>已经清扫
当需要从mcentral中取走一个mspan时，优先级如上述，不过，不会从最后一种（已经清扫且没有空闲空间）mspan的列表中取mspan。</li></ul></li></ul><h3 id=cachespan>cacheSpan
<a class=anchor href=#cachespan>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Allocate a span to use in an mcache.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mcentral</span>) <span style=color:#a6e22e>cacheSpan</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>mspan</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>sweepgen</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>retry</span>:
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mspan</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nonempty</span>.<span style=color:#a6e22e>first</span>; <span style=color:#a6e22e>s</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>; <span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>next</span> { <span style=color:#75715e>// 非空mspan列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// 如果内存单元的 sweepgen 等于 mheap.sweepgen - 2， 那么意味着当前单元需要清理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// 如果等于 mheap.sweepgen - 1，那么当前管理单元就正在清理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweepgen</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Cas</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweepgen</span>, <span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nonempty</span>.<span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>empty</span>.<span style=color:#a6e22e>insertBack</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweep</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>havespan</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweepgen</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// the span is being swept by background sweeper, skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// we have a nonempty span that does not require sweeping, allocate from it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nonempty</span>.<span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>empty</span>.<span style=color:#a6e22e>insertBack</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>havespan</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>empty</span>.<span style=color:#a6e22e>first</span>; <span style=color:#a6e22e>s</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>; <span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>next</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweepgen</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Cas</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweepgen</span>, <span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) { <span style=color:#75715e>// 需要清理，然后就先看下是否有空闲的空间。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// we have an empty span that requires sweeping,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// sweep it and see if we can free some space in it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>empty</span>.<span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>			<span style=color:#75715e>// swept spans are at the end of the list
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>empty</span>.<span style=color:#a6e22e>insertBack</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweep</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>freeIndex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>nextFreeIndex</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>freeIndex</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>nelems</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>freeindex</span> = <span style=color:#a6e22e>freeIndex</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>havespan</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#75715e>// the span is still empty after sweep
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// it is already in the empty list, so just retry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>retry</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweepgen</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>sg</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// the span is being swept by background sweeper, skip
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// already swept empty span,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// all subsequent ones must also be either swept or in process of sweeping
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Replenish central list if empty.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>grow</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>empty</span>.<span style=color:#a6e22e>insertBack</span>(<span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// At this point s is a non-empty span, queued at the end of the empty list,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// c is unlocked.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>havespan</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>nelems</span>) <span style=color:#f92672>-</span> int(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>allocCount</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>freeindex</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>nelems</span> <span style=color:#f92672>||</span> uintptr(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>allocCount</span>) <span style=color:#f92672>==</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>nelems</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;span has no free objects&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Assume all objects from this span will be allocated in the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// mcache. If it gets uncached, we&#39;ll adjust this.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Xadd64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nmalloc</span>, int64(<span style=color:#a6e22e>n</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>usedBytes</span> <span style=color:#f92672>:=</span> uintptr(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>allocCount</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>elemsize</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Xadd64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>memstats</span>.<span style=color:#a6e22e>heap_live</span>, int64(<span style=color:#a6e22e>spanBytes</span>)<span style=color:#f92672>-</span>int64(<span style=color:#a6e22e>usedBytes</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>freeByteBase</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>freeindex</span> <span style=color:#f92672>&amp;^</span> (<span style=color:#ae81ff>64</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>whichByte</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>freeByteBase</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>refillAllocCache</span>(<span style=color:#a6e22e>whichByte</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//调整allocCache，使s.freeindex对应于s.allocCache。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>allocCache</span> <span style=color:#f92672>&gt;&gt;=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>freeindex</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=zput/utterances-comments data-repo-id=R_kgDOHhATGQ data-category=Announcements data-category-id=DIC_kwDOHhATGc4CPxca data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#cachespan>cacheSpan</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html><script type=text/javascript src=https://cdn.bootcss.com/viz.js/1.8.2/viz.js></script><script type=text/javascript>(function(){var e="language-viz-";Array.prototype.forEach.call(document.querySelectorAll("[class^="+e+"]"),function(t){console.log(t),t.getAttribute("class").split(" ").forEach(function(t){t.startsWith(e)&&(s=t.substr(e.length))}),console.log("------------MIDDLE--------");var s,o=Viz(t.innerText,{format:"svg",engine:s}),n=(new DOMParser).parseFromString(o,"image/svg+xml");n.documentElement.setAttribute("style","max-width:100%; max-height:100%;"),t.parentNode.insertBefore(n.documentElement,t),t.style.display="none",t.parentNode.style.backgroundColor="white",t.style.width=n.documentElement.getAttribute("width")+"px",t.style.height=n.documentElement.getAttribute("height")+"px",console.log("--------------END------")})})()</script>