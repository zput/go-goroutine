<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="当go程序初始化到运行package main里面的main函数,g0已经被初始化,g.sched和stack被赋值,当下次切换Goroutine的时候,或者说再次调度的时候, 必然要重新使用g0,那么会重新使用g.sched.PC,g.sched.SP? g0栈是否重新使用初始时候mstart1函数的栈 # main.go
package main import &#34;fmt&#34; // the function's body is empty func add(x, y int64) int64 func main() { gg:=add(2, 3) fmt.Println(gg) } add_amd.s
TEXT ·add(SB),$0-24 MOVQ x+0(FP), BX MOVQ y+8(FP), BP ADDQ BP, BX MOVQ BX, ret+16(FP) RET 编译一下源代码: go build -gcflags &#34;-N -l&#34; -o test ..
[root@gitlab kubernets]# gdb test GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7 Copyright (C) 2013 Free Software Foundation, Inc."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="4.3.1 调度循环"><meta property="og:description" content="当go程序初始化到运行package main里面的main函数,g0已经被初始化,g.sched和stack被赋值,当下次切换Goroutine的时候,或者说再次调度的时候, 必然要重新使用g0,那么会重新使用g.sched.PC,g.sched.SP? g0栈是否重新使用初始时候mstart1函数的栈 # main.go
package main import &#34;fmt&#34; // the function's body is empty func add(x, y int64) int64 func main() { gg:=add(2, 3) fmt.Println(gg) } add_amd.s
TEXT ·add(SB),$0-24 MOVQ x+0(FP), BX MOVQ y+8(FP), BP ADDQ BP, BX MOVQ BX, ret+16(FP) RET 编译一下源代码: go build -gcflags &#34;-N -l&#34; -o test ..
[root@gitlab kubernets]# gdb test GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7 Copyright (C) 2013 Free Software Foundation, Inc."><meta property="og:type" content="article"><meta property="og:url" content="https://example.com/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%B8%89-%E8%B0%83%E5%BA%A6%E5%BE%AA%E7%8E%AF/4.3.1-%E8%B0%83%E5%BA%A6%E5%BE%AA%E7%8E%AF/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2020-03-21T14:14:00+00:00"><meta property="article:modified_time" content="2020-03-21T14:14:00+00:00"><title>4.3.1 调度循环 | go调度源码分析</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.3d89b421e6b838a0994a918daaecd083aefa9523faabd023944479b99694353b.js integrity="sha256-PYm0Iea4OKCZSpGNquzQg676lSP6q9AjlER5uZaUNTs=" crossorigin=anonymous></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>go调度源码分析</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><span>第一章 基础知识</span><ul><li><a href=/docs/%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1.1-%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/>1.1 底层类汇编函数</a></li><li><a href=/docs/%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1.2-%E5%86%85%E5%AD%98/>1.2 内存大小端概念</a></li></ul></li><li><span>第二章 进入main函数之前的初始化</span><ul><li><a href=/docs/%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E8%BF%9B%E5%85%A5main%E5%87%BD%E6%95%B0%E4%B9%8B%E5%89%8D%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/2.1-%E8%BF%9B%E5%85%A5main%E5%87%BD%E6%95%B0%E4%B9%8B%E5%89%8D%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/>2.1 进入main函数之前的初始化</a></li></ul></li><li><span>第三章 退出goroutine</span><ul><li><a href=/docs/%E7%AC%AC%E4%B8%89%E7%AB%A0-%E9%80%80%E5%87%BAgoroutine/3.1-%E9%80%80%E5%87%BAgoroutine/>3.1 goroutine退出过程</a></li></ul></li><li><span>第四章 调度</span><ul><li><span>一 调度策略</span><ul><li><a href=/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%B8%80-%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/4.1.2-%E7%9B%97%E5%8F%96goroutine%E4%BB%8E%E5%85%B6%E4%BB%96%E9%98%9F%E5%88%97/>4.1.2 盗取goroutine从其他队列</a></li><li><a href=/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%B8%80-%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/4.1.1-%E4%BB%8E%E6%9C%AC%E5%9C%B0%E9%98%9F%E5%88%97%E6%88%96%E5%85%A8%E5%B1%80%E9%98%9F%E5%88%97%E8%8E%B7%E5%8F%96goroutine/>4.1.1 从本地队列或全局队列获取goroutine</a></li></ul></li><li><a href=/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/>二 调度的时机</a><ul><li><a href=/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.1-%E4%B8%BB%E5%8A%A8%E8%B0%83%E5%BA%A6/>4.2.1 goroutine主动调度</a></li><li><a href=/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.2-%E8%A2%AB%E5%8A%A8%E8%B0%83%E5%BA%A6/>4.2.2 goroutine被动调度</a></li><li><span>4.2.3 剥夺调度</span><ul><li><a href=/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.3-%E5%89%A5%E5%A4%BA%E8%B0%83%E5%BA%A6/4.2.3.1-%E8%BF%90%E8%A1%8C%E7%94%A8%E6%88%B7%E4%BB%A3%E7%A0%81%E6%97%B6%E9%97%B4%E8%BF%87%E9%95%BF%E8%B0%83%E5%BA%A6/>4.2.3.1 运行用户代码时间过长调度</a></li><li><a href=/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.3-%E5%89%A5%E5%A4%BA%E8%B0%83%E5%BA%A6/4.2.3.2-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%94%B6%E5%B0%BE%E5%A6%82%E6%9E%9C%E4%BB%8E%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E8%BF%94%E5%9B%9E%E5%A6%82%E4%BD%95%E9%87%8D%E6%96%B0%E5%BE%97%E5%88%B0P/>4.2.3.2 系统调用收尾,如从系统调用返回,如何重新得到P</a></li></ul></li></ul></li><li><span>三 调度循环</span><ul><li><a href=/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%B8%89-%E8%B0%83%E5%BA%A6%E5%BE%AA%E7%8E%AF/4.3.1-%E8%B0%83%E5%BA%A6%E5%BE%AA%E7%8E%AF/ class=active>4.3.1 调度循环</a></li></ul></li></ul></li></ul><ul><li><a href=https://github.com/zput target=_blank rel=noopener>Github</a></li><li><a href=https://zput.github.io target=_blank rel=noopener>blog</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>4.3.1 调度循环</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#g0栈是否重新使用初始时候mstart1函数的栈>g0栈是否重新使用初始时候mstart1函数的栈</a></li><li><a href=#每个线程对应g0中g0schedsp会一直改变>每个线程对应g0中g0.sched.SP会一直改变?</a><ul><li><a href=#示例>示例:</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><ul><li>当go程序初始化到运行<code>package main</code>里面的<code>main</code>函数,<code>g0</code>已经被初始化,g.sched和stack被赋值,当下次切换<code>Goroutine</code>的时候,或者说再次调度的时候,<ul><li>必然要重新使用g0,那么会重新使用g.sched.PC,g.sched.SP?</li></ul></li></ul><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200910134925.png alt=修正后调度图></p><h2 id=g0栈是否重新使用初始时候mstart1函数的栈>g0栈是否重新使用初始时候mstart1函数的栈
<a class=anchor href=#g0%e6%a0%88%e6%98%af%e5%90%a6%e9%87%8d%e6%96%b0%e4%bd%bf%e7%94%a8%e5%88%9d%e5%a7%8b%e6%97%b6%e5%80%99mstart1%e5%87%bd%e6%95%b0%e7%9a%84%e6%a0%88>#</a></h2><blockquote><p>main.go</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// the function&#39;s body is empty
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gg</span><span style=color:#f92672>:=</span><span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>gg</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>add_amd.s</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>TEXT</span> <span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>y</span><span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ADDQ</span> <span style=color:#a6e22e>BP</span>, <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>BX</span>, <span style=color:#a6e22e>ret</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span>(<span style=color:#a6e22e>FP</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><p>编译一下源代码: <code>go build -gcflags "-N -l" -o test .</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>[<span style=color:#a6e22e>root</span><span style=color:#960050;background-color:#1e0010>@</span><span style=color:#a6e22e>gitlab</span> <span style=color:#a6e22e>kubernets</span>]<span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>gdb</span> <span style=color:#a6e22e>test</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>GNU</span> <span style=color:#a6e22e>gdb</span> (<span style=color:#a6e22e>GDB</span>) <span style=color:#a6e22e>Red</span> <span style=color:#a6e22e>Hat</span> <span style=color:#a6e22e>Enterprise</span> <span style=color:#a6e22e>Linux</span> <span style=color:#ae81ff>7.6.1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>119.</span><span style=color:#a6e22e>el7</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Copyright</span> (<span style=color:#a6e22e>C</span>) <span style=color:#ae81ff>2013</span> <span style=color:#a6e22e>Free</span> <span style=color:#a6e22e>Software</span> <span style=color:#a6e22e>Foundation</span>, <span style=color:#a6e22e>Inc</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>License</span> <span style=color:#a6e22e>GPLv3</span><span style=color:#f92672>+</span>: <span style=color:#a6e22e>GNU</span> <span style=color:#a6e22e>GPL</span> <span style=color:#a6e22e>version</span> <span style=color:#ae81ff>3</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>later</span> &lt;<span style=color:#a6e22e>http</span>:<span style=color:#75715e>//gnu.org/licenses/gpl.html&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>This</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>free</span> <span style=color:#a6e22e>software</span>: <span style=color:#a6e22e>you</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>free</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>change</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>redistribute</span> <span style=color:#a6e22e>it</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>There</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>NO</span> <span style=color:#a6e22e>WARRANTY</span>, <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>extent</span> <span style=color:#a6e22e>permitted</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>law</span>.  <span style=color:#a6e22e>Type</span> <span style=color:#e6db74>&#34;show copying&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>and</span> <span style=color:#e6db74>&#34;show warranty&#34;</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>details</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>This</span> <span style=color:#a6e22e>GDB</span> <span style=color:#a6e22e>was</span> <span style=color:#a6e22e>configured</span> <span style=color:#a6e22e>as</span> <span style=color:#e6db74>&#34;x86_64-redhat-linux-gnu&#34;</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>For</span> <span style=color:#a6e22e>bug</span> <span style=color:#a6e22e>reporting</span> <span style=color:#a6e22e>instructions</span>, <span style=color:#a6e22e>please</span> <span style=color:#a6e22e>see</span>:
</span></span><span style=display:flex><span>&lt;<span style=color:#a6e22e>http</span>:<span style=color:#75715e>//www.gnu.org/software/gdb/bugs/&gt;...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>Reading</span> <span style=color:#a6e22e>symbols</span> <span style=color:#a6e22e>from</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>tmp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>kubernets</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span><span style=color:#f92672>...</span><span style=color:#a6e22e>done</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>Loading</span> <span style=color:#a6e22e>Go</span> <span style=color:#a6e22e>Runtime</span> <span style=color:#a6e22e>support</span>.
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>list</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>294</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>289</span>	<span style=color:#75715e>// func mcall(fn func(*g))
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>290</span>	<span style=color:#75715e>// Switch to m-&gt;g0&#39;s stack, call fn(g).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>291</span>	<span style=color:#75715e>// Fn must never return. It should gogo(&amp;g-&gt;sched)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>292</span>	<span style=color:#75715e>// to keep running g.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>293</span>	<span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>mcall</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>NOSPLIT</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>294</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>fn</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>DI</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>295</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>296</span>		<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>CX</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>297</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>), <span style=color:#a6e22e>AX</span>	<span style=color:#75715e>// save state in g-&gt;sched
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>298</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>BX</span>	<span style=color:#75715e>// caller&#39;s PC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>299</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_pc</span>)(<span style=color:#a6e22e>AX</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>300</span>		<span style=color:#a6e22e>LEAQ</span>	<span style=color:#a6e22e>fn</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BX</span>	<span style=color:#75715e>// caller&#39;s SP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>301</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_sp</span>)(<span style=color:#a6e22e>AX</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>302</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>AX</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_g</span>)(<span style=color:#a6e22e>AX</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>303</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BP</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_bp</span>)(<span style=color:#a6e22e>AX</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>304</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>305</span>		<span style=color:#75715e>// switch to m-&gt;g0 &amp; its stack, call fn
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>306</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>307</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>g_m</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>308</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>m_g0</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>SI</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>309</span>		<span style=color:#a6e22e>CMPQ</span>	<span style=color:#a6e22e>SI</span>, <span style=color:#a6e22e>AX</span>	<span style=color:#75715e>// if g == m-&gt;g0 call badmcall
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>310</span>		<span style=color:#a6e22e>JNE</span>	<span style=color:#ae81ff>3</span>(<span style=color:#a6e22e>PC</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>311</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>badmcall</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>312</span>		<span style=color:#a6e22e>JMP</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>313</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>SI</span>, <span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>)	<span style=color:#75715e>// g = m-&gt;g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>314</span>		<span style=color:#a6e22e>MOVQ</span>	(<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_sp</span>)(<span style=color:#a6e22e>SI</span>), <span style=color:#a6e22e>SP</span>	<span style=color:#75715e>// sp = m-&gt;g0-&gt;sched.sp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>315</span>		<span style=color:#a6e22e>PUSHQ</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>316</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>DI</span>, <span style=color:#a6e22e>DX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>317</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>DI</span>), <span style=color:#a6e22e>DI</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>318</span>		<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>DI</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>319</span>		<span style=color:#a6e22e>POPQ</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>320</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>badmcall2</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>321</span>		<span style=color:#a6e22e>JMP</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>322</span>		<span style=color:#a6e22e>RET</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>323</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>324</span>	<span style=color:#75715e>// systemstack_switch is a dummy routine that systemstack leaves at the bottom
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>325</span>	<span style=color:#75715e>// of the G stack. We need to distinguish the routine that
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>326</span>	<span style=color:#75715e>// lives at the bottom of the G stack from the one that lives
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>327</span>	<span style=color:#75715e>// at the top of the system stack because the one at the top of
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>328</span>	<span style=color:#75715e>// the system stack terminates the stack walk (see topofstack()).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>b</span> <span style=color:#ae81ff>318</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span> <span style=color:#a6e22e>at</span> <span style=color:#ae81ff>0x44b229</span>: <span style=color:#a6e22e>file</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>line</span> <span style=color:#ae81ff>318.</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>The</span> <span style=color:#a6e22e>program</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>not</span> <span style=color:#a6e22e>being</span> <span style=color:#a6e22e>run</span>.
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>run</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Starting</span> <span style=color:#a6e22e>program</span>: <span style=color:#f92672>/</span><span style=color:#a6e22e>tmp</span><span style=color:#f92672>/</span><span style=color:#a6e22e>kubernets</span><span style=color:#f92672>/</span><span style=color:#a6e22e>test</span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>New</span> <span style=color:#a6e22e>LWP</span> <span style=color:#ae81ff>29827</span>]
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Switching</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>LWP</span> <span style=color:#ae81ff>29827</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mcall</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>318</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>318</span>		<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>DI</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>register</span> <span style=color:#a6e22e>rbp</span> <span style=color:#a6e22e>rsp</span> <span style=color:#a6e22e>pc</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0xc000030fa0</span>	<span style=color:#ae81ff>0xc000030fa0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0xc000045fd0</span>	<span style=color:#ae81ff>0xc000045fd0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x44b229</span>	<span style=color:#ae81ff>0x44b229</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mcall</span><span style=color:#f92672>+</span><span style=color:#ae81ff>89</span>&gt;
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>disas</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Dump</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>assembler</span> <span style=color:#a6e22e>code</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>function</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mcall</span>:
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b1d0</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#ae81ff>0x8</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rdi</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b1d5</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>5</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>fs</span>:<span style=color:#ae81ff>0xfffffffffffffff8</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b1de</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>14</span>&gt;:	<span style=color:#a6e22e>mov</span>    (<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b1e2</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>18</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>,<span style=color:#ae81ff>0x40</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b1e6</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>22</span>&gt;:	<span style=color:#a6e22e>lea</span>    <span style=color:#ae81ff>0x8</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b1eb</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>27</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>,<span style=color:#ae81ff>0x38</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b1ef</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>31</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>,<span style=color:#ae81ff>0x48</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b1f3</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>35</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rbp</span>,<span style=color:#ae81ff>0x68</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b1f7</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>39</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>fs</span>:<span style=color:#ae81ff>0xfffffffffffffff8</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b200</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>48</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#ae81ff>0x30</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b204</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>52</span>&gt;:	<span style=color:#a6e22e>mov</span>    (<span style=color:#f92672>%</span><span style=color:#a6e22e>rbx</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rsi</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b207</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>55</span>&gt;:	<span style=color:#a6e22e>cmp</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rsi</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b20a</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>58</span>&gt;:	<span style=color:#a6e22e>jne</span>    <span style=color:#ae81ff>0x44b215</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mcall</span><span style=color:#f92672>+</span><span style=color:#ae81ff>69</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b20c</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>60</span>&gt;:	<span style=color:#a6e22e>lea</span>    <span style=color:#f92672>-</span><span style=color:#ae81ff>0x23343</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rip</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>        <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#ae81ff>0x427ed0</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>badmcall</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b213</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>67</span>&gt;:	<span style=color:#a6e22e>jmpq</span>   <span style=color:#f92672>*%</span><span style=color:#a6e22e>rax</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b215</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>69</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rsi</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>fs</span>:<span style=color:#ae81ff>0xfffffffffffffff8</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b21e</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>78</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#ae81ff>0x38</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsi</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b222</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>82</span>&gt;:	<span style=color:#a6e22e>push</span>   <span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b223</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>83</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rdi</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rdx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b226</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>86</span>&gt;:	<span style=color:#a6e22e>mov</span>    (<span style=color:#f92672>%</span><span style=color:#a6e22e>rdi</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rdi</span>
</span></span><span style=display:flex><span>=&gt; <span style=color:#ae81ff>0x000000000044b229</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>89</span>&gt;:	<span style=color:#a6e22e>callq</span>  <span style=color:#f92672>*%</span><span style=color:#a6e22e>rdi</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b22b</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>91</span>&gt;:	<span style=color:#a6e22e>pop</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span> <span style=color:#75715e>// callq的下一个指令 0x000000000044b22b -------------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000044b22c</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>92</span>&gt;:	<span style=color:#a6e22e>lea</span>    <span style=color:#f92672>-</span><span style=color:#ae81ff>0x23323</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rip</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>        <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#ae81ff>0x427f10</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>badmcall2</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b233</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>99</span>&gt;:	<span style=color:#a6e22e>jmpq</span>   <span style=color:#f92672>*%</span><span style=color:#a6e22e>rax</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000044b235</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>101</span>&gt;:	<span style=color:#a6e22e>retq</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>End</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>assembler</span> <span style=color:#a6e22e>dump</span>.
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>step</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>park_m</span> (<span style=color:#a6e22e>gp</span>=<span style=color:#ae81ff>0xc000000780</span>) <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>2594</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2594</span>	<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>park_m</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>) {
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>info</span> <span style=color:#a6e22e>register</span> <span style=color:#a6e22e>rbp</span> <span style=color:#a6e22e>rsp</span> <span style=color:#a6e22e>pc</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0xc000030fa0</span>	<span style=color:#ae81ff>0xc000030fa0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0xc000045fc8</span>	<span style=color:#ae81ff>0xc000045fc8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x42d490</span>	<span style=color:#ae81ff>0x42d490</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>park_m</span>&gt;
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>x</span><span style=color:#f92672>/</span><span style=color:#ae81ff>32</span><span style=color:#a6e22e>xb</span> <span style=color:#ae81ff>0xc000045fc0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xc000045fc0</span>:	<span style=color:#ae81ff>0x80</span>	<span style=color:#ae81ff>0x0a</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0xc0</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xc000045fc8</span>:	<span style=color:#ae81ff>0x2b</span>	<span style=color:#ae81ff>0xb2</span>	<span style=color:#ae81ff>0x44</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span> <span style=color:#75715e>// 0x000000000044b22b -------------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>0xc000045fd0</span>:	<span style=color:#ae81ff>0x80</span>	<span style=color:#ae81ff>0x07</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0xc0</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0xc000045fd8</span>:	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>) <span style=color:#a6e22e>disas</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Dump</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>assembler</span> <span style=color:#a6e22e>code</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>function</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>park_m</span>:
</span></span><span style=display:flex><span>=&gt; <span style=color:#ae81ff>0x000000000042d490</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>&gt;:	    <span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>fs</span>:<span style=color:#ae81ff>0xfffffffffffffff8</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042d499</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>9</span>&gt;:	    <span style=color:#a6e22e>cmp</span>    <span style=color:#ae81ff>0x10</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rcx</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042d49d</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>13</span>&gt;:	<span style=color:#a6e22e>jbe</span>    <span style=color:#ae81ff>0x42d642</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>park_m</span><span style=color:#f92672>+</span><span style=color:#ae81ff>434</span>&gt; <span style=color:#75715e>//判断是否越界
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#ae81ff>0x000000000042d4a3</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>19</span>&gt;:	<span style=color:#a6e22e>sub</span>    <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x28</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042d4a7</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>23</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rbp</span>,<span style=color:#ae81ff>0x20</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042d4ac</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>28</span>&gt;:	<span style=color:#a6e22e>lea</span>    <span style=color:#ae81ff>0x20</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>),<span style=color:#f92672>%</span><span style=color:#a6e22e>rbp</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042d4b1</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>33</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>fs</span>:<span style=color:#ae81ff>0xfffffffffffffff8</span>,<span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042d4ba</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>42</span>&gt;:	<span style=color:#a6e22e>mov</span>    <span style=color:#f92672>%</span><span style=color:#a6e22e>rax</span>,<span style=color:#ae81ff>0x18</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rsp</span>)
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042d4bf</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>47</span>&gt;:	<span style=color:#a6e22e>cmpb</span>   <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x0</span>,<span style=color:#ae81ff>0xaf4ca</span>(<span style=color:#f92672>%</span><span style=color:#a6e22e>rip</span>)        <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#ae81ff>0x4dc990</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>trace</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span>&gt;
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>0x000000000042d4c6</span> &lt;<span style=color:#f92672>+</span><span style=color:#ae81ff>54</span>&gt;:	<span style=color:#a6e22e>jne</span>    <span style=color:#ae81ff>0x42d61e</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>park_m</span><span style=color:#f92672>+</span><span style=color:#ae81ff>398</span>&gt;
</span></span><span style=display:flex><span><span style=color:#f92672>---</span><span style=color:#a6e22e>Type</span> &lt;<span style=color:#66d9ef>return</span>&gt; <span style=color:#a6e22e>to</span> <span style=color:#66d9ef>continue</span>, <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>q</span> &lt;<span style=color:#66d9ef>return</span>&gt; <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>quit</span><span style=color:#f92672>---</span><span style=color:#a6e22e>q</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Quit</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>gdb</span>)
</span></span></code></pre></div><p>从&mdash;-here可以看出来,当使用mcall<switch to m->g0&rsquo;s stack>,只是使用了g0的栈,没有用g.sched.pc,而是用的mcall里面的<code>callq的下一个指令 0x000000000044b22b -------------------here</code></p><blockquote><p>文件<code>src/runtime/proc.go</code></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// park continuation on g0.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>park_m</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>traceGoPark</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>waittraceev</span>, <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>waittraceskip</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Grunning</span>, <span style=color:#a6e22e>_Gwaiting</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dropg</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>waitunlockf</span>; <span style=color:#a6e22e>fn</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fn</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>waitlock</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>waitunlockf</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>waitlock</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>traceGoUnpark</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Gwaiting</span>, <span style=color:#a6e22e>_Grunnable</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#66d9ef>true</span>) <span style=color:#75715e>// Schedule it back, never returns.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>schedule</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=每个线程对应g0中g0schedsp会一直改变>每个线程对应g0中g0.sched.SP会一直改变?
<a class=anchor href=#%e6%af%8f%e4%b8%aa%e7%ba%bf%e7%a8%8b%e5%af%b9%e5%ba%94g0%e4%b8%adg0schedsp%e4%bc%9a%e4%b8%80%e7%9b%b4%e6%94%b9%e5%8f%98>#</a></h2><blockquote><p>在初始化后就不会改变了,下次调度,直接把<code>g0.sched.SP</code>重新赋值给寄存器<code>SP</code>.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>g</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sched</span>          <span style=color:#a6e22e>gobuf</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>gobuf</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sp</span>   <span style=color:#66d9ef>uintptr</span>   <span style=color:#f92672>-------------------------------</span><span style=color:#a6e22e>here</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pc</span>   <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span>    <span style=color:#a6e22e>guintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctxt</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ret</span>  <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>Uintreg</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lr</span>   <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bp</span>   <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// for GOEXPERIMENT=framepointer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h3 id=示例>示例:
<a class=anchor href=#%e7%a4%ba%e4%be%8b>#</a></h3><h4 id=实践想法>实践想法
<a class=anchor href=#%e5%ae%9e%e8%b7%b5%e6%83%b3%e6%b3%95>#</a></h4><ul><li>有两个go关键字运行起来的Goroutine<ul><li>当main goroutine睡眠的时候&mdash;-[切换到g0栈]&mdash;&ndash;>其中一个Goroutine&mdash;-[切换到g0栈]&ndash;>另一个Goroutine或者main goroutine<ul><li>所以只要看下这个切换的时候,mcall函数中(具体可看part2中:非main goroutine退出)<code>MOVQ (g_sched+gobuf_sp)(SI), SP</code>是否一直不变</li></ul></li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// func mcall(fn func(*g))   
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Switch to m-&gt;g0&#39;s stack, call fn(g).    ------------------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>mcall</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>NOSPLIT</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>fn</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>DI</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>CX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>), <span style=color:#a6e22e>AX</span>	<span style=color:#75715e>// save state in g-&gt;sched
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>BX</span>	<span style=color:#75715e>// caller&#39;s PC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_pc</span>)(<span style=color:#a6e22e>AX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LEAQ</span>	<span style=color:#a6e22e>fn</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BX</span>	<span style=color:#75715e>// caller&#39;s SP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_sp</span>)(<span style=color:#a6e22e>AX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>AX</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_g</span>)(<span style=color:#a6e22e>AX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BP</span>, (<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_bp</span>)(<span style=color:#a6e22e>AX</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// switch to m-&gt;g0 &amp; its stack, call fn
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>g_m</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>m_g0</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>SI</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CMPQ</span>	<span style=color:#a6e22e>SI</span>, <span style=color:#a6e22e>AX</span>	<span style=color:#75715e>// if g == m-&gt;g0 call badmcall
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>JNE</span>	<span style=color:#ae81ff>3</span>(<span style=color:#a6e22e>PC</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>badmcall</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JMP</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>SI</span>, <span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>)	<span style=color:#75715e>// g = m-&gt;g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	(<span style=color:#a6e22e>g_sched</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_sp</span>)(<span style=color:#a6e22e>SI</span>), <span style=color:#a6e22e>SP</span>	<span style=color:#75715e>// sp = m-&gt;g0-&gt;sched.sp   -------------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>PUSHQ</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>DI</span>, <span style=color:#a6e22e>DX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>DI</span>), <span style=color:#a6e22e>DI</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>DI</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>POPQ</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>badmcall2</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JMP</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><h4 id=定义程序>定义程序
<a class=anchor href=#%e5%ae%9a%e4%b9%89%e7%a8%8b%e5%ba%8f>#</a></h4><blockquote><p>main.go</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;runtime&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;sync/atomic&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>existFlag</span> <span style=color:#66d9ef>int32</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// the function&#39;s body is empty
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>addAssemble</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>a</span> <span style=color:#66d9ef>int64</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>addAssemble</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>a</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>existFlag</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>GOMAXPROCS</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>existFlag</span>) <span style=color:#f92672>&lt;=</span><span style=color:#ae81ff>0</span>{
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Gosched</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>add_amd.s</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>TEXT</span> <span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>addAssemble</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>y</span><span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ADDQ</span> <span style=color:#a6e22e>BP</span>, <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>BX</span>, <span style=color:#a6e22e>ret</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span>(<span style=color:#a6e22e>FP</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><h4 id=gdb调试前准备>gdb调试前准备
<a class=anchor href=#gdb%e8%b0%83%e8%af%95%e5%89%8d%e5%87%86%e5%a4%87>#</a></h4><h5 id=编译程序>编译程序
<a class=anchor href=#%e7%bc%96%e8%af%91%e7%a8%8b%e5%ba%8f>#</a></h5><p>编译一下源代码: <code>go build -gcflags "-N -l" -o test .</code>.</p><h5 id=准备mcall函数断点的文件>准备mcall函数断点的文件
<a class=anchor href=#%e5%87%86%e5%a4%87mcall%e5%87%bd%e6%95%b0%e6%96%ad%e7%82%b9%e7%9a%84%e6%96%87%e4%bb%b6>#</a></h5><ul><li>gdb<ul><li><code>list /usr/lib/golang/src/runtime/asm_amd64.s:300</code></li><li><code>list /tmp/kubernets/test_goroutine/add_amd.s:1</code></li></ul></li></ul><h5 id=gdb调试自定义函数>gdb调试自定义函数
<a class=anchor href=#gdb%e8%b0%83%e8%af%95%e8%87%aa%e5%ae%9a%e4%b9%89%e5%87%bd%e6%95%b0>#</a></h5><pre tabindex=0><code class=language-gdb data-lang=gdb>define zxc
info threads
info register rbp rsp pc
step
continue
end
</code></pre><h4 id=gdb>gdb
<a class=anchor href=#gdb>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@gitlab test_goroutine<span style=color:#f92672>]</span><span style=color:#75715e># gdb ./test</span>
</span></span><span style=display:flex><span>GNU gdb <span style=color:#f92672>(</span>GDB<span style=color:#f92672>)</span> Red Hat Enterprise Linux 7.6.1-119.el7
</span></span><span style=display:flex><span>Copyright <span style=color:#f92672>(</span>C<span style=color:#f92672>)</span> <span style=color:#ae81ff>2013</span> Free Software Foundation, Inc.
</span></span><span style=display:flex><span>License GPLv3+: GNU GPL version <span style=color:#ae81ff>3</span> or later &lt;http://gnu.org/licenses/gpl.html&gt;
</span></span><span style=display:flex><span>This is free software: you are free to change and redistribute it.
</span></span><span style=display:flex><span>There is NO WARRANTY, to the extent permitted by law.  Type <span style=color:#e6db74>&#34;show copying&#34;</span>
</span></span><span style=display:flex><span>and <span style=color:#e6db74>&#34;show warranty&#34;</span> <span style=color:#66d9ef>for</span> details.
</span></span><span style=display:flex><span>This GDB was configured as <span style=color:#e6db74>&#34;x86_64-redhat-linux-gnu&#34;</span>.
</span></span><span style=display:flex><span>For bug reporting instructions, please see:
</span></span><span style=display:flex><span>&lt;http://www.gnu.org/software/gdb/bugs/&gt;...
</span></span><span style=display:flex><span>Reading symbols from /tmp/kubernets/test_goroutine/test...done.
</span></span><span style=display:flex><span>Loading Go Runtime support.
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> list /usr/lib/golang/src/runtime/asm_amd64.s:300
</span></span><span style=display:flex><span><span style=color:#ae81ff>295</span>
</span></span><span style=display:flex><span>296		get_tls<span style=color:#f92672>(</span>CX<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>297		MOVQ	g<span style=color:#f92672>(</span>CX<span style=color:#f92672>)</span>, AX	// save state in g-&gt;sched
</span></span><span style=display:flex><span>298		MOVQ	0<span style=color:#f92672>(</span>SP<span style=color:#f92672>)</span>, BX	// caller<span style=color:#e6db74>&#39;s PC
</span></span></span><span style=display:flex><span><span style=color:#e6db74>299		MOVQ	BX, (g_sched+gobuf_pc)(AX)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>300		LEAQ	fn+0(FP), BX	// caller&#39;</span>s SP
</span></span><span style=display:flex><span>301		MOVQ	BX, <span style=color:#f92672>(</span>g_sched+gobuf_sp<span style=color:#f92672>)(</span>AX<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>302		MOVQ	AX, <span style=color:#f92672>(</span>g_sched+gobuf_g<span style=color:#f92672>)(</span>AX<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>303		MOVQ	BP, <span style=color:#f92672>(</span>g_sched+gobuf_bp<span style=color:#f92672>)(</span>AX<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>304</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>305		// switch to m-&gt;g0 &amp; its stack, call fn
</span></span><span style=display:flex><span>306		MOVQ	g<span style=color:#f92672>(</span>CX<span style=color:#f92672>)</span>, BX
</span></span><span style=display:flex><span>307		MOVQ	g_m<span style=color:#f92672>(</span>BX<span style=color:#f92672>)</span>, BX
</span></span><span style=display:flex><span>308		MOVQ	m_g0<span style=color:#f92672>(</span>BX<span style=color:#f92672>)</span>, SI
</span></span><span style=display:flex><span>309		CMPQ	SI, AX	// <span style=color:#66d9ef>if</span> g <span style=color:#f92672>==</span> m-&gt;g0 call badmcall
</span></span><span style=display:flex><span>310		JNE	3<span style=color:#f92672>(</span>PC<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>311		MOVQ	$runtime·badmcall<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>, AX
</span></span><span style=display:flex><span>312		JMP	AX
</span></span><span style=display:flex><span>313		MOVQ	SI, g<span style=color:#f92672>(</span>CX<span style=color:#f92672>)</span>	// g <span style=color:#f92672>=</span> m-&gt;g0
</span></span><span style=display:flex><span>314		MOVQ	<span style=color:#f92672>(</span>g_sched+gobuf_sp<span style=color:#f92672>)(</span>SI<span style=color:#f92672>)</span>, SP	// sp <span style=color:#f92672>=</span> m-&gt;g0-&gt;sched.sp
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>315		PUSHQ	AX
</span></span><span style=display:flex><span>316		MOVQ	DI, DX
</span></span><span style=display:flex><span>317		MOVQ	0<span style=color:#f92672>(</span>DI<span style=color:#f92672>)</span>, DI
</span></span><span style=display:flex><span>318		CALL	DI
</span></span><span style=display:flex><span>319		POPQ	AX
</span></span><span style=display:flex><span>320		MOVQ	$runtime·badmcall2<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>, AX
</span></span><span style=display:flex><span>321		JMP	AX
</span></span><span style=display:flex><span>322		RET
</span></span><span style=display:flex><span><span style=color:#ae81ff>323</span>
</span></span><span style=display:flex><span>324	// systemstack_switch is a dummy routine that systemstack leaves at the bottom
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> b <span style=color:#ae81ff>318</span>
</span></span><span style=display:flex><span>Breakpoint <span style=color:#ae81ff>1</span> at 0x44a2c9: file /usr/lib/golang/src/runtime/asm_amd64.s, line 318.
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> define zxc
</span></span><span style=display:flex><span>Type commands <span style=color:#66d9ef>for</span> definition of <span style=color:#e6db74>&#34;zxc&#34;</span>.
</span></span><span style=display:flex><span>End with a line saying just <span style=color:#e6db74>&#34;end&#34;</span>.
</span></span><span style=display:flex><span>&gt;info threads
</span></span><span style=display:flex><span>&gt;info register rbp rsp pc
</span></span><span style=display:flex><span>&gt;step
</span></span><span style=display:flex><span>&gt;continue
</span></span><span style=display:flex><span>&gt;end
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> zxc
</span></span><span style=display:flex><span>No threads.
</span></span><span style=display:flex><span>The program has no registers now.
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> run
</span></span><span style=display:flex><span>Starting program: /tmp/kubernets/test_goroutine/./test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>318		CALL	DI
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> zxc
</span></span><span style=display:flex><span>  Id   Target Id         Frame
</span></span><span style=display:flex><span>* <span style=color:#ae81ff>1</span>    LWP <span style=color:#ae81ff>18958</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>rbp            0xc000030660	0xc000030660
</span></span><span style=display:flex><span>rsp            0x7fffffffe440	0x7fffffffe440
</span></span><span style=display:flex><span>pc             0x44a2c9	0x44a2c9 &lt;runtime.mcall+89&gt;
</span></span><span style=display:flex><span>runtime.park_m <span style=color:#f92672>(</span>gp<span style=color:#f92672>=</span>0xc000000300<span style=color:#f92672>)</span> at /usr/lib/golang/src/runtime/proc.go:2594
</span></span><span style=display:flex><span>2594	func park_m<span style=color:#f92672>(</span>gp *g<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>New LWP 19129<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Switching to LWP 19129<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>318		CALL	DI
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Id   Target Id         Frame
</span></span><span style=display:flex><span>* <span style=color:#ae81ff>2</span>    LWP <span style=color:#ae81ff>19129</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318                ------------------here
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>    LWP <span style=color:#ae81ff>18958</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>rbp            0xc000031f30	0xc000031f30
</span></span><span style=display:flex><span>rsp            0xc00003ffd0	0xc00003ffd0         ------------------here
</span></span><span style=display:flex><span>pc             0x44a2c9	0x44a2c9 &lt;runtime.mcall+89&gt;
</span></span><span style=display:flex><span>runtime.park_m <span style=color:#f92672>(</span>gp<span style=color:#f92672>=</span>0xc000000d80<span style=color:#f92672>)</span> at /usr/lib/golang/src/runtime/proc.go:2594
</span></span><span style=display:flex><span>2594	func park_m<span style=color:#f92672>(</span>gp *g<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Switching to LWP 18958<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>318		CALL	DI
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Id   Target Id         Frame
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>    LWP <span style=color:#ae81ff>19129</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>* <span style=color:#ae81ff>1</span>    LWP <span style=color:#ae81ff>18958</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>rbp            0xc000030660	0xc000030660
</span></span><span style=display:flex><span>rsp            0x7fffffffe440	0x7fffffffe440
</span></span><span style=display:flex><span>pc             0x44a2c9	0x44a2c9 &lt;runtime.mcall+89&gt;
</span></span><span style=display:flex><span>runtime.park_m <span style=color:#f92672>(</span>gp<span style=color:#f92672>=</span>0xc000000300<span style=color:#f92672>)</span> at /usr/lib/golang/src/runtime/proc.go:2594
</span></span><span style=display:flex><span>2594	func park_m<span style=color:#f92672>(</span>gp *g<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Switching to LWP 19129<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>318		CALL	DI
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Id   Target Id         Frame
</span></span><span style=display:flex><span>* <span style=color:#ae81ff>2</span>    LWP <span style=color:#ae81ff>19129</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318               ------------------here
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>    LWP <span style=color:#ae81ff>18958</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>rbp            0xc000031798	0xc000031798
</span></span><span style=display:flex><span>rsp            0xc00003ffd0	0xc00003ffd0                           ------------------here
</span></span><span style=display:flex><span>pc             0x44a2c9	0x44a2c9 &lt;runtime.mcall+89&gt;
</span></span><span style=display:flex><span>runtime.park_m <span style=color:#f92672>(</span>gp<span style=color:#f92672>=</span>0xc000000c00<span style=color:#f92672>)</span> at /usr/lib/golang/src/runtime/proc.go:2594
</span></span><span style=display:flex><span>2594	func park_m<span style=color:#f92672>(</span>gp *g<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>New LWP 18963<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Switching to LWP 18963<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>318		CALL	DI
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Id   Target Id         Frame
</span></span><span style=display:flex><span>* <span style=color:#ae81ff>3</span>    LWP <span style=color:#ae81ff>18963</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>    LWP <span style=color:#ae81ff>19129</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>    LWP <span style=color:#ae81ff>18958</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>rbp            0xc000030fa0	0xc000030fa0
</span></span><span style=display:flex><span>rsp            0xc000045fd0	0xc000045fd0
</span></span><span style=display:flex><span>pc             0x44a2c9	0x44a2c9 &lt;runtime.mcall+89&gt;
</span></span><span style=display:flex><span>runtime.park_m <span style=color:#f92672>(</span>gp<span style=color:#f92672>=</span>0xc000000780<span style=color:#f92672>)</span> at /usr/lib/golang/src/runtime/proc.go:2594
</span></span><span style=display:flex><span>2594	func park_m<span style=color:#f92672>(</span>gp *g<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Switching to LWP 18958<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>318		CALL	DI
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Id   Target Id         Frame
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>3</span>    LWP <span style=color:#ae81ff>18963</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>    LWP <span style=color:#ae81ff>19129</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>* <span style=color:#ae81ff>1</span>    LWP <span style=color:#ae81ff>18958</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>rbp            0xc000030720	0xc000030720
</span></span><span style=display:flex><span>rsp            0x7fffffffe440	0x7fffffffe440
</span></span><span style=display:flex><span>pc             0x44a2c9	0x44a2c9 &lt;runtime.mcall+89&gt;
</span></span><span style=display:flex><span>runtime.gosched_m <span style=color:#f92672>(</span>gp<span style=color:#f92672>=</span>0xc000000300<span style=color:#f92672>)</span> at /usr/lib/golang/src/runtime/proc.go:2635
</span></span><span style=display:flex><span>2635	func gosched_m<span style=color:#f92672>(</span>gp *g<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>318		CALL	DI
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Id   Target Id         Frame
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>3</span>    LWP <span style=color:#ae81ff>18963</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>    LWP <span style=color:#ae81ff>19129</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>* <span style=color:#ae81ff>1</span>    LWP <span style=color:#ae81ff>18958</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>rbp            0xc000032fc8	0xc000032fc8
</span></span><span style=display:flex><span>rsp            0x7fffffffe440	0x7fffffffe440
</span></span><span style=display:flex><span>pc             0x44a2c9	0x44a2c9 &lt;runtime.mcall+89&gt;
</span></span><span style=display:flex><span>runtime.goexit0 <span style=color:#f92672>(</span>gp<span style=color:#f92672>=</span>0xc000001380<span style=color:#f92672>)</span> at /usr/lib/golang/src/runtime/proc.go:2674
</span></span><span style=display:flex><span>2674	func goexit0<span style=color:#f92672>(</span>gp *g<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>318		CALL	DI
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  Id   Target Id         Frame
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>3</span>    LWP <span style=color:#ae81ff>18963</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>    LWP <span style=color:#ae81ff>19129</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.futex <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/sys_linux_amd64.s:536
</span></span><span style=display:flex><span>* <span style=color:#ae81ff>1</span>    LWP <span style=color:#ae81ff>18958</span> <span style=color:#e6db74>&#34;test&#34;</span>  runtime.mcall <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:318
</span></span><span style=display:flex><span>rbp            0xc0000327c8	0xc0000327c8
</span></span><span style=display:flex><span>rsp            0x7fffffffe440	0x7fffffffe440
</span></span><span style=display:flex><span>pc             0x44a2c9	0x44a2c9 &lt;runtime.mcall+89&gt;
</span></span><span style=display:flex><span>runtime.goexit0 <span style=color:#f92672>(</span>gp<span style=color:#f92672>=</span>0xc000001200<span style=color:#f92672>)</span> at /usr/lib/golang/src/runtime/proc.go:2674
</span></span><span style=display:flex><span>2674	func goexit0<span style=color:#f92672>(</span>gp *g<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>LWP <span style=color:#ae81ff>19129</span> exited<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>LWP <span style=color:#ae81ff>18963</span> exited<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Inferior <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>process 18958<span style=color:#f92672>)</span> exited normally<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span></code></pre></div><ul><li>观察<code>------------------here</code>,可以知道每个M有自己的g0,其中的g.sched.SP初始化以后就不会改变<ul><li>都是<code>rsp 0xc00003ffd0 0xc00003ffd0</code></li></ul></li><li>如果不清楚可以看下线程1<code>* 1 LWP 18958 "test"</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Id</span>   <span style=color:#a6e22e>Target</span> <span style=color:#a6e22e>Id</span>         <span style=color:#a6e22e>Frame</span>
</span></span><span style=display:flex><span><span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>    <span style=color:#a6e22e>LWP</span> <span style=color:#ae81ff>19129</span> <span style=color:#e6db74>&#34;test&#34;</span>  <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mcall</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>318</span>                <span style=color:#f92672>------------------</span><span style=color:#a6e22e>here</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>    <span style=color:#a6e22e>LWP</span> <span style=color:#ae81ff>18958</span> <span style=color:#e6db74>&#34;test&#34;</span>  <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>futex</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>sys_linux_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>536</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0xc000031f30</span>	<span style=color:#ae81ff>0xc000031f30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0xc00003ffd0</span>	<span style=color:#ae81ff>0xc00003ffd0</span>         <span style=color:#f92672>------------------</span><span style=color:#a6e22e>here</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x44a2c9</span>	<span style=color:#ae81ff>0x44a2c9</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mcall</span><span style=color:#f92672>+</span><span style=color:#ae81ff>89</span>&gt;
</span></span><span style=display:flex><span><span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>park_m</span> (<span style=color:#a6e22e>gp</span>=<span style=color:#ae81ff>0xc000000d80</span>) <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>2594</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2594</span>	<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>park_m</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>) {
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Switching</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>LWP</span> <span style=color:#ae81ff>18958</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mcall</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>318</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>318</span>		<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>DI</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Id</span>   <span style=color:#a6e22e>Target</span> <span style=color:#a6e22e>Id</span>         <span style=color:#a6e22e>Frame</span>
</span></span><span style=display:flex><span><span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>    <span style=color:#a6e22e>LWP</span> <span style=color:#ae81ff>19129</span> <span style=color:#e6db74>&#34;test&#34;</span>  <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mcall</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>318</span>               <span style=color:#f92672>------------------</span><span style=color:#a6e22e>here</span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>    <span style=color:#a6e22e>LWP</span> <span style=color:#ae81ff>18958</span> <span style=color:#e6db74>&#34;test&#34;</span>  <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>futex</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>sys_linux_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>536</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0xc000031798</span>	<span style=color:#ae81ff>0xc000031798</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0xc00003ffd0</span>	<span style=color:#ae81ff>0xc00003ffd0</span>                           <span style=color:#f92672>------------------</span><span style=color:#a6e22e>here</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x44a2c9</span>	<span style=color:#ae81ff>0x44a2c9</span> &lt;<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mcall</span><span style=color:#f92672>+</span><span style=color:#ae81ff>89</span>&gt;
</span></span><span style=display:flex><span><span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>park_m</span> (<span style=color:#a6e22e>gp</span>=<span style=color:#ae81ff>0xc000000c00</span>) <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>proc</span>.<span style=color:#66d9ef>go</span>:<span style=color:#ae81ff>2594</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2594</span>	<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>park_m</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>) {
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>New</span> <span style=color:#a6e22e>LWP</span> <span style=color:#ae81ff>18963</span>]
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Switching</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>LWP</span> <span style=color:#ae81ff>18963</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>mcall</span> () <span style=color:#a6e22e>at</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>usr</span><span style=color:#f92672>/</span><span style=color:#a6e22e>lib</span><span style=color:#f92672>/</span><span style=color:#a6e22e>golang</span><span style=color:#f92672>/</span><span style=color:#a6e22e>src</span><span style=color:#f92672>/</span><span style=color:#a6e22e>runtime</span><span style=color:#f92672>/</span><span style=color:#a6e22e>asm_amd64</span>.<span style=color:#a6e22e>s</span>:<span style=color:#ae81ff>318</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>318</span>		<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>DI</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//...
</span></span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200910134925.png alt=修正后调度图></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/alex-shpak/hugo-book/edit/main/exampleSite/content/docs/%e7%ac%ac%e5%9b%9b%e7%ab%a0%20%e8%b0%83%e5%ba%a6/%e4%b8%89%20%e8%b0%83%e5%ba%a6%e5%be%aa%e7%8e%af/4.3.1%20%e8%b0%83%e5%ba%a6%e5%be%aa%e7%8e%af.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#g0栈是否重新使用初始时候mstart1函数的栈>g0栈是否重新使用初始时候mstart1函数的栈</a></li><li><a href=#每个线程对应g0中g0schedsp会一直改变>每个线程对应g0中g0.sched.SP会一直改变?</a><ul><li><a href=#示例>示例:</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>