<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="例子 # 我们首先来gdb调试一下这个程序
main.go
package main import &#34;fmt&#34; // the function's body is empty func add(x, y int64) int64 func main() { gg:=add(2, 3) fmt.Println(gg) } add_amd.s
TEXT ·add(SB),$0-24 MOVQ x+0(FP), BX MOVQ y+8(FP), BP ADDQ BP, BX MOVQ BX, ret+16(FP) RET 编译一下源代码: go build -gcflags &#34;-N -l&#34; -o test ..
程序加载到内存入口 # (gdb) info files Symbols from &#34;/tmp/kubernets/test&#34;. Local exec file: `/tmp/kubernets/test', file type elf64-x86-64. Entry point: 0x454e00 0x0000000000401000 - 0x000000000048cfd3 is ."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="2.1 进入main函数之前的初始化"><meta property="og:description" content="例子 # 我们首先来gdb调试一下这个程序
main.go
package main import &#34;fmt&#34; // the function's body is empty func add(x, y int64) int64 func main() { gg:=add(2, 3) fmt.Println(gg) } add_amd.s
TEXT ·add(SB),$0-24 MOVQ x+0(FP), BX MOVQ y+8(FP), BP ADDQ BP, BX MOVQ BX, ret+16(FP) RET 编译一下源代码: go build -gcflags &#34;-N -l&#34; -o test ..
程序加载到内存入口 # (gdb) info files Symbols from &#34;/tmp/kubernets/test&#34;. Local exec file: `/tmp/kubernets/test', file type elf64-x86-64. Entry point: 0x454e00 0x0000000000401000 - 0x000000000048cfd3 is ."><meta property="og:type" content="article"><meta property="og:url" content="https://zput.github.io/go-goroutine/docs/%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E8%BF%9B%E5%85%A5main%E5%87%BD%E6%95%B0%E4%B9%8B%E5%89%8D%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/2.1-%E8%BF%9B%E5%85%A5main%E5%87%BD%E6%95%B0%E4%B9%8B%E5%89%8D%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2020-01-20T10:03:00+00:00"><meta property="article:modified_time" content="2020-01-20T10:03:00+00:00"><title>2.1 进入main函数之前的初始化 | go调度源码分析</title><link rel=manifest href=/go-goroutine/manifest.json><link rel=icon href=/go-goroutine/favicon.png type=image/x-icon><link rel=stylesheet href=/go-goroutine/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/go-goroutine/flexsearch.min.js></script>
<script defer src=/go-goroutine/en.search.min.c584b10c4d7027e11c69523e3cf2f45ba91951867158bb7c614873cc437dc4f7.js integrity="sha256-xYSxDE1wJ+EcaVI+PPL0W6kZUYZxWLt8YUhzzEN9xPc=" crossorigin=anonymous></script>
<script defer src=/go-goroutine/sw.min.ec96d6e09af3075a94dd4de723a2edddf2ef138381c7e1e5b5a1f2c0578ee8bd.js integrity="sha256-7JbW4JrzB1qU3U3nI6Lt3fLvE4OBx+HltaHywFeO6L0=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/go-goroutine/><span>go调度源码分析</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://zput.github.io target=_blank rel=noopener>zput博客</a></li><li><a href=https://github.com/zput target=_blank rel=noopener>GitHub</a></li></ul><ul><li><span>第一章 基础知识</span><ul><li><a href=/go-goroutine/docs/%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1.1-%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/>1.1 底层类汇编函数</a></li><li><a href=/go-goroutine/docs/%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1.2-%E5%86%85%E5%AD%98/>1.2 内存大小端概念</a></li></ul></li><li><span>第二章 进入main函数之前的初始化</span><ul><li><a href=/go-goroutine/docs/%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E8%BF%9B%E5%85%A5main%E5%87%BD%E6%95%B0%E4%B9%8B%E5%89%8D%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/2.1-%E8%BF%9B%E5%85%A5main%E5%87%BD%E6%95%B0%E4%B9%8B%E5%89%8D%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/ class=active>2.1 进入main函数之前的初始化</a></li></ul></li><li><span>第三章 退出goroutine</span><ul><li><a href=/go-goroutine/docs/%E7%AC%AC%E4%B8%89%E7%AB%A0-%E9%80%80%E5%87%BAgoroutine/3.1-%E9%80%80%E5%87%BAgoroutine/>3.1 goroutine退出过程</a></li></ul></li><li><span>第四章 调度</span><ul><li><span>一 调度策略</span><ul><li><a href=/go-goroutine/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%B8%80-%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/4.1.2-%E7%9B%97%E5%8F%96goroutine%E4%BB%8E%E5%85%B6%E4%BB%96%E9%98%9F%E5%88%97/>4.1.2 盗取goroutine从其他队列</a></li><li><a href=/go-goroutine/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%B8%80-%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/4.1.1-%E4%BB%8E%E6%9C%AC%E5%9C%B0%E9%98%9F%E5%88%97%E6%88%96%E5%85%A8%E5%B1%80%E9%98%9F%E5%88%97%E8%8E%B7%E5%8F%96goroutine/>4.1.1 从本地队列或全局队列获取goroutine</a></li></ul></li><li><a href=/go-goroutine/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/>二 调度的时机</a><ul><li><a href=/go-goroutine/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.1-%E4%B8%BB%E5%8A%A8%E8%B0%83%E5%BA%A6/>4.2.1 goroutine主动调度</a></li><li><a href=/go-goroutine/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.2-%E8%A2%AB%E5%8A%A8%E8%B0%83%E5%BA%A6/>4.2.2 goroutine被动调度</a></li><li><span>4.2.3 剥夺调度</span><ul><li><a href=/go-goroutine/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.3-%E5%89%A5%E5%A4%BA%E8%B0%83%E5%BA%A6/4.2.3.1-%E8%BF%90%E8%A1%8C%E7%94%A8%E6%88%B7%E4%BB%A3%E7%A0%81%E6%97%B6%E9%97%B4%E8%BF%87%E9%95%BF%E8%B0%83%E5%BA%A6/>4.2.3.1 运行用户代码时间过长调度</a></li><li><a href=/go-goroutine/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.3-%E5%89%A5%E5%A4%BA%E8%B0%83%E5%BA%A6/4.2.3.2-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%94%B6%E5%B0%BE%E5%A6%82%E6%9E%9C%E4%BB%8E%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E8%BF%94%E5%9B%9E%E5%A6%82%E4%BD%95%E9%87%8D%E6%96%B0%E5%BE%97%E5%88%B0P/>4.2.3.2 系统调用收尾,如从系统调用返回,如何重新得到P</a></li></ul></li></ul></li><li><span>三 调度循环</span><ul><li><a href=/go-goroutine/docs/%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E8%B0%83%E5%BA%A6/%E4%B8%89-%E8%B0%83%E5%BA%A6%E5%BE%AA%E7%8E%AF/4.3.1-%E8%B0%83%E5%BA%A6%E5%BE%AA%E7%8E%AF/>4.3.1 调度循环</a></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/go-goroutine/svg/menu.svg class=book-icon alt=Menu></label>
<strong>2.1 进入main函数之前的初始化</strong>
<label for=toc-control><img src=/go-goroutine/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#例子>例子</a><ul><li><a href=#程序加载到内存入口>程序加载到内存入口</a></li><li><a href=#进行初始化全局变量>进行初始化全局变量</a></li><li><a href=#进入main函数>进入main函数</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h2 id=例子>例子
<a class=anchor href=#%e4%be%8b%e5%ad%90>#</a></h2><p>我们首先来gdb调试一下这个程序</p><blockquote><p>main.go</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// the function&#39;s body is empty
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gg</span><span style=color:#f92672>:=</span><span style=color:#a6e22e>add</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>gg</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>add_amd.s</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>TEXT</span> <span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>x</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>y</span><span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ADDQ</span> <span style=color:#a6e22e>BP</span>, <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>BX</span>, <span style=color:#a6e22e>ret</span><span style=color:#f92672>+</span><span style=color:#ae81ff>16</span>(<span style=color:#a6e22e>FP</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><p>编译一下源代码: <code>go build -gcflags "-N -l" -o test .</code>.</p><h3 id=程序加载到内存入口>程序加载到内存入口
<a class=anchor href=#%e7%a8%8b%e5%ba%8f%e5%8a%a0%e8%bd%bd%e5%88%b0%e5%86%85%e5%ad%98%e5%85%a5%e5%8f%a3>#</a></h3><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200907142246.png alt=20200907142246></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> info files
</span></span><span style=display:flex><span>Symbols from <span style=color:#e6db74>&#34;/tmp/kubernets/test&#34;</span>.
</span></span><span style=display:flex><span>Local exec file:
</span></span><span style=display:flex><span>	<span style=color:#e6db74>`</span>/tmp/kubernets/test<span style=color:#960050;background-color:#1e0010>&#39;</span>, file type elf64-x86-64.
</span></span><span style=display:flex><span>	Entry point: 0x454e00
</span></span><span style=display:flex><span>	0x0000000000401000 - 0x000000000048cfd3 is .text
</span></span><span style=display:flex><span>	0x000000000048d000 - 0x00000000004dc550 is .rodata
</span></span><span style=display:flex><span>	0x00000000004dc720 - 0x00000000004dd38c is .typelink
</span></span><span style=display:flex><span>	0x00000000004dd390 - 0x00000000004dd3e0 is .itablink
</span></span><span style=display:flex><span>	0x00000000004dd3e0 - 0x00000000004dd3e0 is .gosymtab
</span></span><span style=display:flex><span>	0x00000000004dd3e0 - 0x0000000000548adf is .gopclntab
</span></span><span style=display:flex><span>	0x0000000000549000 - 0x0000000000549020 is .go.buildinfo
</span></span><span style=display:flex><span>	0x0000000000549020 - 0x0000000000556118 is .noptrdata
</span></span><span style=display:flex><span>	0x0000000000556120 - 0x000000000055d110 is .data
</span></span><span style=display:flex><span>	0x000000000055d120 - 0x0000000000578990 is .bss
</span></span><span style=display:flex><span>	0x00000000005789a0 - 0x000000000057b108 is .noptrbss
</span></span><span style=display:flex><span>	0x0000000000400f9c - 0x0000000000401000 is .note.go.buildid
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> b *0x454e00
</span></span><span style=display:flex><span>Breakpoint <span style=color:#ae81ff>1</span> at 0x454e00: file /usr/lib/golang/src/runtime/rt0_linux_amd64.s, line 8. //跳到这个文件来了
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> list /usr/lib/golang/src/runtime/rt0_linux_amd64.s:1
</span></span><span style=display:flex><span>1	// Copyright <span style=color:#ae81ff>2009</span> The Go Authors. All rights reserved.
</span></span><span style=display:flex><span>2	// Use of this source code is governed by a BSD-style
</span></span><span style=display:flex><span>3	// license that can be found in the LICENSE file.
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>5	<span style=color:#75715e>#include &#34;textflag.h&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>7	TEXT _rt0_amd64_linux<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>,NOSPLIT,$-<span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>8		JMP	_rt0_amd64<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> run
</span></span><span style=display:flex><span>Starting program: /tmp/kubernets/test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Breakpoint 1, _rt0_amd64_linux <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/rt0_linux_amd64.s:8 //跳到这个文件来了
</span></span><span style=display:flex><span>8		JMP	_rt0_amd64<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> info registers bp
</span></span><span style=display:flex><span>bp             0x0	<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> info registers sp
</span></span><span style=display:flex><span>sp             0x7fffffffe4d0	0x7fffffffe4d0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> next
</span></span><span style=display:flex><span>16		LEAQ	8<span style=color:#f92672>(</span>SP<span style=color:#f92672>)</span>, SI	// argv
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> list
</span></span><span style=display:flex><span>11	// internal linking. This is the entry point <span style=color:#66d9ef>for</span> the program from the
</span></span><span style=display:flex><span>12	// kernel <span style=color:#66d9ef>for</span> an ordinary -buildmode<span style=color:#f92672>=</span>exe program. The stack holds the
</span></span><span style=display:flex><span>13	// number of arguments and the C-style argv.
</span></span><span style=display:flex><span>14	TEXT _rt0_amd64<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>,NOSPLIT,$-<span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>15		MOVQ	0<span style=color:#f92672>(</span>SP<span style=color:#f92672>)</span>, DI	// argc
</span></span><span style=display:flex><span>16		LEAQ	8<span style=color:#f92672>(</span>SP<span style=color:#f92672>)</span>, SI	// argv
</span></span><span style=display:flex><span>17		JMP	runtime·rt0_go<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> next
</span></span><span style=display:flex><span>runtime.rt0_go <span style=color:#f92672>()</span> at /usr/lib/golang/src/runtime/asm_amd64.s:89 //跳到这个文件来了
</span></span><span style=display:flex><span>89		MOVQ	DI, AX		// argc
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> list
</span></span><span style=display:flex><span>84	DATA _rt0_amd64_lib_argv&lt;&gt;<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>/8, $0
</span></span><span style=display:flex><span>85	GLOBL _rt0_amd64_lib_argv&lt;&gt;<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>,NOPTR, $8
</span></span><span style=display:flex><span><span style=color:#ae81ff>86</span>
</span></span><span style=display:flex><span>87	TEXT runtime·rt0_go<span style=color:#f92672>(</span>SB<span style=color:#f92672>)</span>,NOSPLIT,$0
</span></span><span style=display:flex><span>88		// copy arguments forward on an even stack
</span></span><span style=display:flex><span>89		MOVQ	DI, AX		// argc
</span></span><span style=display:flex><span>90		MOVQ	SI, BX		// argv
</span></span><span style=display:flex><span>91		SUBQ	<span style=color:#66d9ef>$(</span>4*8+7<span style=color:#66d9ef>)</span>, SP		// 2args 2auto
</span></span><span style=display:flex><span>92		ANDQ	$~15, SP
</span></span><span style=display:flex><span>93		MOVQ	AX, 16<span style=color:#f92672>(</span>SP<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>从上面的调试来看,最终到到达了<code>src/runtime/asm_amd64.s:89</code>的
<a href=https://github.com/golang/go/blob/93810ac1f4574e1e2a79ea156781bafaf8b8ebe0/src/runtime/asm_amd64.s#L87>runtime.rt0_go</a>函数.</p><pre tabindex=0><code class=language-file data-lang=file>file /usr/lib/golang/src/runtime/rt0_linux_amd64.s, line 8. //跳到这个文件来
_rt0_amd64_linux () at /usr/lib/golang/src/runtime/rt0_linux_amd64.s:8 //跳到这个文件来
runtime.rt0_go () at /usr/lib/golang/src/runtime/asm_amd64.s:89 //跳到这个文件来
</code></pre><h3 id=进行初始化全局变量>进行初始化全局变量
<a class=anchor href=#%e8%bf%9b%e8%a1%8c%e5%88%9d%e5%a7%8b%e5%8c%96%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8f>#</a></h3><p>主要是<code>rt0_go()</code>函数</p><h4 id=初始化全局变量g0>初始化全局变量g0
<a class=anchor href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e5%85%a8%e5%b1%80%e5%8f%98%e9%87%8fg0>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>rt0_go</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#a6e22e>NOSPLIT</span>,<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// copy arguments forward on an even stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>DI</span>, <span style=color:#a6e22e>AX</span>		<span style=color:#75715e>// argc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>SI</span>, <span style=color:#a6e22e>BX</span>		<span style=color:#75715e>// argv
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>SUBQ</span>	<span style=color:#960050;background-color:#1e0010>$</span>(<span style=color:#ae81ff>4</span><span style=color:#f92672>*</span><span style=color:#ae81ff>8</span><span style=color:#f92672>+</span><span style=color:#ae81ff>7</span>), <span style=color:#a6e22e>SP</span>		<span style=color:#75715e>// 2args 2auto
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ANDQ</span>	<span style=color:#960050;background-color:#1e0010>$~</span><span style=color:#ae81ff>15</span>, <span style=color:#a6e22e>SP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#ae81ff>16</span>(<span style=color:#a6e22e>SP</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, <span style=color:#ae81ff>24</span>(<span style=color:#a6e22e>SP</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>//TODO zxc 调整栈顶寄存器使其按16字节对齐; argc放在SP + 16字节处; argv放在SP + 24字节处
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// create istack out of the given (operating system) stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// _cgo_init may update stackguard.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>g0</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>DI</span>     <span style=color:#75715e>//全局的变量g0的地址放入DI寄存器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>LEAQ</span>	(<span style=color:#f92672>-</span><span style=color:#ae81ff>64</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1024</span><span style=color:#f92672>+</span><span style=color:#ae81ff>104</span>)(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, <span style=color:#a6e22e>g_stackguard0</span>(<span style=color:#a6e22e>DI</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, <span style=color:#a6e22e>g_stackguard1</span>(<span style=color:#a6e22e>DI</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>BX</span>, (<span style=color:#a6e22e>g_stack</span><span style=color:#f92672>+</span><span style=color:#a6e22e>stack_lo</span>)(<span style=color:#a6e22e>DI</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>SP</span>, (<span style=color:#a6e22e>g_stack</span><span style=color:#f92672>+</span><span style=color:#a6e22e>stack_hi</span>)(<span style=color:#a6e22e>DI</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO zxc 始初始化全局变量g0, g0的栈大约有64K，地址范围为 SP - 64*1024 + 104 ～ SP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>    ...省略一些CPU相关的汇编
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LEAQ</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>m0</span><span style=color:#f92672>+</span><span style=color:#a6e22e>m_tls</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>DI</span>  <span style=color:#75715e>// //DI = &amp;m0.tls，取m0的tls成员的地址到DI寄存器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>settls</span>(<span style=color:#a6e22e>SB</span>)        <span style=color:#75715e>// 调用settls设置线程本地存储，settls函数的参数在DI寄存器中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// store through it, to make sure it works // 可以看做是单元测试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x123</span>, <span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>m0</span><span style=color:#f92672>+</span><span style=color:#a6e22e>m_tls</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CMPQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x123</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JEQ</span> <span style=color:#ae81ff>2</span>(<span style=color:#a6e22e>PC</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>abort</span>(<span style=color:#a6e22e>SB</span>)
</span></span></code></pre></div><p>分析下这个<code>runtime·settls()</code>函数,因为这个ELF需要-8,所以提前+8,那么最终执行完这个函数,它是设置在全局的m0的tls[0]里面,还是tls[1]里面呢?
观察下这个<code>MOVQ runtime·m0+m_tls(SB), AX</code>,可以知道就是m0中的tls[0]的地址</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// set tls base to DI
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>settls</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#a6e22e>NOSPLIT</span>,<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>32</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ADDQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>8</span>, <span style=color:#a6e22e>DI</span>	<span style=color:#75715e>// ELF wants to use -8(FS) //因为后面要-8,所以先加+8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>DI</span>, <span style=color:#a6e22e>SI</span>  <span style=color:#75715e>// is SI parameter?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x1002</span>, <span style=color:#a6e22e>DI</span>	<span style=color:#75715e>// ARCH_SET_FS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>SYS_arch_prctl</span>, <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SYSCALL</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CMPQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0xfffffffffffff001</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JLS</span>	<span style=color:#ae81ff>2</span>(<span style=color:#a6e22e>PC</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVL</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0xf1</span>, <span style=color:#ae81ff>0xf1</span>  <span style=color:#75715e>// crash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><blockquote><p>只是一个宏定义<code>src/runtime/go_tls.h</code>,<code>get_tls(BX)</code>把TLS地址放入BX寄存器.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>ifdef</span> <span style=color:#a6e22e>GOARCH_amd64</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>define</span>	<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>r</span>)	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>TLS</span>, <span style=color:#a6e22e>r</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>define</span>	<span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>r</span>)	<span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>r</span>)(<span style=color:#a6e22e>TLS</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>endif</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#75715e>// Thread-local storage references use the TLS pseudo-register.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// As a register, TLS refers to the thread-local storage base, and it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// can only be loaded into another register:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//         MOVQ TLS, AX
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// An offset from the thread-local storage base is written off(reg)(TLS*1).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Semantically it is off(reg), but the (TLS*1) annotation marks this as
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// indexing from the loaded TLS base. This emits a relocation so that
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// if the linker needs to adjust the offset, it can. For example:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//         MOVQ TLS, AX
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//         MOVQ 0(AX)(TLS*1), CX // load g into CX
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// On systems that support direct access to the TLS memory, this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// pair of instructions can be reduced to a direct TLS memory reference:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//         MOVQ 0(TLS), CX // load g into CX
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// The 2-instruction and 1-instruction forms correspond to the two code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// sequences for loading a TLS variable in the local exec model given in &#34;ELF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Handling For Thread-Local Storage&#34;.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// When building for inclusion into a shared library, an instruction of the form
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>//     MOV off(CX)(TLS*1), AX
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// becomes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>//     mov %fs:off(%rcx), %rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// which assumes that the correct TLS offset has been loaded into %rcx (today
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// there is only one TLS variable -- g -- so this is OK). When not building for
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// a shared library the instruction does not require a prefix.
</span></span></span></code></pre></div><h4 id=m0和g0绑定在一起>m0和g0绑定在一起
<a class=anchor href=#m0%e5%92%8cg0%e7%bb%91%e5%ae%9a%e5%9c%a8%e4%b8%80%e8%b5%b7>#</a></h4><p>我们继续下面的<code>runtime·rt0_go</code>函数.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ok</span>:
</span></span><span style=display:flex><span>	<span style=color:#75715e>// set the per-goroutine and per-mach &#34;registers&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LEAQ</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>g0</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>CX</span> <span style=color:#75715e>//取的g0的在堆上的地址放入CX--&gt;CX = g0的地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>CX</span>, <span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>BX</span>)          <span style=color:#75715e>//把g0的地址保存在线程本地存储里面，也就是*TLS=&amp;g0 --&gt; m0.tls[0]=&amp;g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>LEAQ</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>m0</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span> <span style=color:#75715e>//AX=&amp;m0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// save m-&gt;g0 = g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>CX</span>, <span style=color:#a6e22e>m_g0</span>(<span style=color:#a6e22e>AX</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// save m0 to g0-&gt;m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#a6e22e>g_m</span>(<span style=color:#a6e22e>CX</span>)
</span></span></code></pre></div><p>m0和g0绑定在一起，这样，之后在主线程中通过get_tls可以获取到g0，通过g0的m成员又可以找到m0，于是这里就实现了m0和g0与主线程之间的关联。
从这里还可以看到，保存在主线程本地存储中的值是g0的地址，也就是说工作线程的私有全局变量其实是一个指向g的指针而不是指向m的指针</p><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200907151844.png alt=20200907151844></p><h4 id=设置一些ncpucpu核数-mp的个数-初始化m0>设置一些ncpu(CPU核数), M,P的个数, 初始化m0
<a class=anchor href=#%e8%ae%be%e7%bd%ae%e4%b8%80%e4%ba%9bncpucpu%e6%a0%b8%e6%95%b0-mp%e7%9a%84%e4%b8%aa%e6%95%b0-%e5%88%9d%e5%a7%8b%e5%8c%96m0>#</a></h4><p>我们继续下面的<code>runtime·rt0_go</code>函数.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>  	<span style=color:#a6e22e>CLD</span>				<span style=color:#75715e>// convention is D is always left cleared 不需要关心
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>check</span>(<span style=color:#a6e22e>SB</span>) <span style=color:#75715e>//不需要关心
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVL</span>	<span style=color:#ae81ff>16</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>AX</span>		<span style=color:#75715e>// copy argc;  AX = argc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVL</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>SP</span>)       <span style=color:#75715e>// argc放在栈顶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>24</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>AX</span>		<span style=color:#75715e>// copy argv;  AX = argv
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#ae81ff>8</span>(<span style=color:#a6e22e>SP</span>)       <span style=color:#75715e>// argv放在SP + 8的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>args</span>(<span style=color:#a6e22e>SB</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>osinit</span>(<span style=color:#a6e22e>SB</span>) <span style=color:#75715e>//全局变量 ncpu = CPU核数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>schedinit</span>(<span style=color:#a6e22e>SB</span>)
</span></span></code></pre></div><h5 id=schedinit>schedinit
<a class=anchor href=#schedinit>#</a></h5><p>schedinit主要是进行一些初始化工作, 必过设置M的最大个数,P的个数,还有初始化这m0,另外这个getg()也很有趣,分为our G, system G</p><blockquote><p><a href=https://github.com/golang/go/blob/5c2c6d3fbf4f0a1299b5e41463847d242eae19ca/src/runtime/proc.go#L535>sr/runtime/proc.go</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// The bootstrap sequence is:
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//	call osinit
</span></span></span><span style=display:flex><span><span style=color:#75715e>//	call schedinit
</span></span></span><span style=display:flex><span><span style=color:#75715e>//	make &amp; queue new G
</span></span></span><span style=display:flex><span><span style=color:#75715e>//	call runtime·mstart
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// The new G calls runtime·main.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>schedinit</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// raceinit must be the first call to race detector.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// In particular, it must be done before mallocinit below calls racemapshadow.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>    getg函数在源代码中没有对应的定义，由编译器插入类似下面两行代码
</span></span></span><span style=display:flex><span><span style=color:#75715e>    get_tls(CX) // CX=TLS
</span></span></span><span style=display:flex><span><span style=color:#75715e>    MOVQ g(CX), BX; BX存器里面现在放的是当前g结构体对象的地址
</span></span></span><span style=display:flex><span><span style=color:#75715e>    可以参考这个,根据https://github.com/golang/go/blob/d029058b5912312963225c40ae4bf44e3cb4be76/src/runtime/HACKING.md
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>maxmcount</span> = <span style=color:#ae81ff>10000</span> <span style=color:#75715e>// 最多启动10000个操作系统线程，也是最多10000个M
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mcommoninit</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>) <span style=color:#75715e>//初始化m0，因为从前面的代码我们知道g0-&gt;m = &amp;m0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>procs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ncpu</span>  <span style=color:#75715e>//系统中有多少核，就创建和初始化多少个p结构体对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>atoi32</span>(<span style=color:#a6e22e>gogetenv</span>(<span style=color:#e6db74>&#34;GOMAXPROCS&#34;</span>)); <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>n</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>procs</span> = <span style=color:#a6e22e>n</span>  <span style=color:#75715e>//如果指定了GOMAXPROCS大于0，则创建指定数量的p
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>procresize</span>(<span style=color:#a6e22e>procs</span>) <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;unknown runnable goroutine during bootstrap&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h6 id=mcommoninit>mcommoninit
<a class=anchor href=#mcommoninit>#</a></h6><p>mcommoninit主要是判断m是否超过个数,然后放入全局m链表,防止垃圾回收</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>m0</span>.<span style=color:#a6e22e>p</span> = <span style=color:#a6e22e>allp</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>allp</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>m</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m0</span>
</span></span></code></pre></div><blockquote><p><a href=https://github.com/golang/go/blob/5c2c6d3fbf4f0a1299b5e41463847d242eae19ca/src/runtime/proc.go#L641>sr/runtime/proc.go</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mcommoninit</span>(<span style=color:#a6e22e>mp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>m</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// g0 stack won&#39;t make sense for user (and is not necessary unwindable).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>g0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>callers</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>createstack</span>[:])
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>mnext</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> &lt; <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>mnext</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;runtime: thread ID overflow&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>id</span> = <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>mnext</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>mnext</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>checkmcount</span>() <span style=color:#75715e>//检查m的个数是否超过sched.maxmcoun
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Add to allm so garbage collector doesn&#39;t free g-&gt;m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// when it is just in a register or thread-local storage.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>alllink</span> = <span style=color:#a6e22e>allm</span> <span style=color:#75715e>//m放入全局链表allm, 防止垃圾回收
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// NumCgoCall() iterates over allm w/o schedlock,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// so we need to publish it safely.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>atomicstorep</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>allm</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>mp</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h6 id=初始化allp-m0和allp0绑定>初始化allp, m0和allp[0]绑定
<a class=anchor href=#%e5%88%9d%e5%a7%8b%e5%8c%96allp-m0%e5%92%8callp0%e7%bb%91%e5%ae%9a>#</a></h6><blockquote><p>procresize函数，我们先看下初始化时会执行的代码路径.</p><blockquote><p>考虑到初始化完成之后, 用户代码还可以通过<code>GOMAXPROCS()</code>函数调用它重新创建和初始化p结构体对象，我们首先只考虑初始化.</p></blockquote></blockquote><ul><li>使用<code>make([]*p, nprocs)</code>初始化全局变量<code>allp</code>，把旧的allp拷贝到新的nallp里面,然后<code>allp = make([]*p, nprocs)</code></li><li>循环<code>allp</code>中的每个p,如果是nill的就进行创建, 然后每个都初始化,不管是新的还是旧的.</li><li>把<code>m0</code>和<code>allp[0]</code>绑定在一起，即<code>m0.p = allp[0], allp[0].m = m0</code></li><li>把除了<code>allp[0]</code>之外的所有<code>p</code>放入到全局变量<code>sched</code>的<code>pidle</code>空闲队列之中</li></ul><blockquote><p><a href=https://github.com/golang/go/blob/5c2c6d3fbf4f0a1299b5e41463847d242eae19ca/src/runtime/proc.go#L4319>src/runtime/proc.go</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>procresize</span>(<span style=color:#a6e22e>nprocs</span> <span style=color:#66d9ef>int32</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>p</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>old</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gomaxprocs</span> <span style=color:#75715e>//系统初始化时 gomaxprocs = 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>old</span> &lt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>nprocs</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;procresize: invalid arg&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Grow allp if necessary.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nprocs</span> &gt; int32(len(<span style=color:#a6e22e>allp</span>)) { <span style=color:#75715e>//初始化时 len(allp) == 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// Synchronize with retake, which could be running
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// concurrently since it doesn&#39;t run on a P.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>allpLock</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nprocs</span> <span style=color:#f92672>&lt;=</span> int32(cap(<span style=color:#a6e22e>allp</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>allp</span> = <span style=color:#a6e22e>allp</span>[:<span style=color:#a6e22e>nprocs</span>]
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> { <span style=color:#75715e>//初始化时进入此分支，创建allp 切片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>nallp</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>nprocs</span>)
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Copy everything up to allp&#39;s cap so we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// never lose old allocated Ps.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            copy(<span style=color:#a6e22e>nallp</span>, <span style=color:#a6e22e>allp</span>[:cap(<span style=color:#a6e22e>allp</span>)]) <span style=color:#75715e>//把旧的allp拷贝到新的nallp里面
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>allp</span> = <span style=color:#a6e22e>nallp</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>allpLock</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// initialize new P&#39;s
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>old</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>nprocs</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allp</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pp</span> = new(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>i</span>) <span style=color:#75715e>//每个p然后进行初始化 旧的也需要重新进行初始化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>atomicstorep</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>allp</span>[<span style=color:#a6e22e>i</span>]), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>pp</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()  <span style=color:#75715e>// _g_ = g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>id</span> &lt; <span style=color:#a6e22e>nprocs</span> {<span style=color:#75715e>//初始化时m0-&gt;p还未初始化，所以不会执行这个分支
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// continue to use the current P
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>_Prunning</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>mcache</span>.<span style=color:#a6e22e>prepareForSweep</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {<span style=color:#75715e>//初始化时执行这个分支
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// release the current P and acquire allp[0]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {<span style=color:#75715e>//初始化时这里不执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>m</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>mcache</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allp</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>m</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>_Pidle</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>acquirep</span>(<span style=color:#a6e22e>p</span>) <span style=color:#75715e>// --&gt; Associate p and the current m; 在初始化的时候就是把p和m0关联起来,其实是这两个strct的成员相互赋值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>traceGoStart</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// release resources from unused P&#39;s --&gt; zxc 就是释放多余的P
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nprocs</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>old</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allp</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>destroy</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e>// TODO zxc can&#39;t free P itself because it can be referenced by an M in syscall
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//下面这个for 循环把所有空闲的p放入空闲链表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>runnablePs</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nprocs</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allp</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>p</span> {<span style=color:#75715e>//不放allp[0],因为它跟m0在上面已经关联了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>_Pidle</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>runqempty</span>(<span style=color:#a6e22e>p</span>) {<span style=color:#75715e>//初始化时除了allp[0]其它p全部执行这个分支，放入空闲链表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>pidleput</span>(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>runnablePs</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200907153347.png alt=内存关系图></p><h4 id=创造一个将要运行runtimemainpc的goroutine>创造一个将要运行<code>runtime·mainPC</code>的goroutine
<a class=anchor href=#%e5%88%9b%e9%80%a0%e4%b8%80%e4%b8%aa%e5%b0%86%e8%a6%81%e8%bf%90%e8%a1%8cruntimemainpc%e7%9a%84goroutine>#</a></h4><p>我们继续下面的
<a href=https://github.com/golang/go/blob/93810ac1f4574e1e2a79ea156781bafaf8b8ebe0/src/runtime/asm_amd64.s#L87>runtime·rt0_go</a>函数.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#75715e>// create a new goroutine to start program
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>mainPC</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span><span style=color:#75715e>// entry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>PUSHQ</span>	<span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PUSHQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span><span style=color:#75715e>// arg size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>newproc</span>(<span style=color:#a6e22e>SB</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>POPQ</span>	<span style=color:#a6e22e>AX</span>
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200909112003.png alt="main goroutine,第一条指令"></p><h5 id=newproc>newproc
<a class=anchor href=#newproc>#</a></h5><blockquote><p><a href=https://github.com/golang/go/blob/93810ac1f4574e1e2a79ea156781bafaf8b8ebe0/src/runtime/proc.go#L3528>src/runtime/proc.go</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Create a new g running fn with siz bytes of arguments.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Put it on the queue of g&#39;s waiting to run.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// The compiler turns a go statement into a call to this.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Cannot split the stack because it assumes that the arguments
</span></span></span><span style=display:flex><span><span style=color:#75715e>// are available sequentially after &amp;fn; they would not be
</span></span></span><span style=display:flex><span><span style=color:#75715e>// copied if a stack split occurred.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:nosplit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newproc</span>(<span style=color:#a6e22e>siz</span> <span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>fn</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>funcval</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>argp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>fn</span>), <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>PtrSize</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getcallerpc</span>() <span style=color:#75715e>//getcallerpc:返回其调用者的程序计数器（PC）---getcallersp返回其调用者的堆栈指针（SP）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {  <span style=color:#75715e>// systemstack 切到g0的栈和CPU寄存器去执行, 执行完了, 再切换原来的栈和CPU寄存器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>newproc1</span>(<span style=color:#a6e22e>fn</span>, (<span style=color:#f92672>*</span><span style=color:#66d9ef>uint8</span>)(<span style=color:#a6e22e>argp</span>), <span style=color:#a6e22e>siz</span>, <span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>pc</span>) 
</span></span><span style=display:flex><span>		 <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 创建一个新的g运行的fn，参数的字节数从argp开始; 
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 siz: 参数的大小
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 callergp: 调用者的goroutine pointer[caller-callee]
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 callerpc: 调用者的程序计数器
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 */</span> 
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create a new g running fn with narg bytes of arguments starting
</span></span></span><span style=display:flex><span><span style=color:#75715e>// at argp. callerpc is the address of the go statement that created
</span></span></span><span style=display:flex><span><span style=color:#75715e>// this. The new g is put on the queue of g&#39;s waiting to run.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newproc1</span>(<span style=color:#a6e22e>fn</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>funcval</span>, <span style=color:#a6e22e>argp</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint8</span>, <span style=color:#a6e22e>narg</span> <span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>callergp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>callerpc</span> <span style=color:#66d9ef>uintptr</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fn</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>throwing</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#75715e>// do not dump full stacks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;go of nil func value&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>acquirem</span>() <span style=color:#75715e>// disable preemption because it can be holding p in a local var // TODO zxc 禁止抢占
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>siz</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>narg</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>siz</span> = (<span style=color:#a6e22e>siz</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>7</span>) <span style=color:#f92672>&amp;^</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// We could allocate a larger initial stack if necessary.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Not worth it: this is almost always an error.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 4*sizeof(uintreg): extra space added below
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// sizeof(uintreg): caller&#39;s LR (arm) or return address (x86, in gostartcall).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>siz</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>_StackMin</span><span style=color:#f92672>-</span><span style=color:#ae81ff>4</span><span style=color:#f92672>*</span><span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>RegSize</span><span style=color:#f92672>-</span><span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>RegSize</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;newproc: function arguments too large for new goroutine&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_p_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>() <span style=color:#75715e>// 的到m上的p,在这里就是allp[0]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>newg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gfget</span>(<span style=color:#a6e22e>_p_</span>) <span style=color:#75715e>// 从本地或者全局队列尝试获取g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newg</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {<span style=color:#75715e>// 如果获取失败就构造一个g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>newg</span> = <span style=color:#a6e22e>malg</span>(<span style=color:#a6e22e>_StackMin</span>) <span style=color:#75715e>// 跳转到g0的栈,然后再堆上分配,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>newg</span>, <span style=color:#a6e22e>_Gidle</span>, <span style=color:#a6e22e>_Gdead</span>) <span style=color:#75715e>//_Gidle=iota //0 新创建的默认是0,所以就是idle;修改状态为Gdead,这样gc就是扫描newg上面的栈,来尝试要不要回收.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>allgadd</span>(<span style=color:#a6e22e>newg</span>) <span style=color:#75715e>// publishes with a g-&gt;status of Gdead so GC scanner doesn&#39;t look at uninitialized stack. 这里的把生成的g放入全局allgs []*g//保存所有的g
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200907161241.png alt=为main函数创建一个新的goroutine></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>hi</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;newproc1: newg missing stack&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>readgstatus</span>(<span style=color:#a6e22e>newg</span>) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>_Gdead</span> { <span style=color:#75715e>//不是Gdead就panic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;newproc1: new g is not Gdead&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>totalSize</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>*</span><span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>RegSize</span> <span style=color:#f92672>+</span> uintptr(<span style=color:#a6e22e>siz</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>MinFrameSize</span> <span style=color:#75715e>// extra space in case of reads slightly beyond frame
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>totalSize</span> <span style=color:#f92672>+=</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>totalSize</span> <span style=color:#f92672>&amp;</span> (<span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>SpAlign</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)                  <span style=color:#75715e>// align to spAlign
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>hi</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>totalSize</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>spArg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sp</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>usesLR</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// caller&#39;s LR
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>*</span>(<span style=color:#f92672>*</span><span style=color:#66d9ef>uintptr</span>)(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>sp</span>)) = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>prepGoExitFrame</span>(<span style=color:#a6e22e>sp</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>spArg</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>MinFrameSize</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>narg</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>//memmove copies n bytes from &#34;from&#34; to &#34;to&#34;,把在调用者的栈上的,callee
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>memmove</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>spArg</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>argp</span>), uintptr(<span style=color:#a6e22e>narg</span>))
</span></span><span style=display:flex><span>		<span style=color:#75715e>// This is a stack-to-stack copy. If write barriers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// are enabled and the source stack is grey (the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// destination is always black), then perform a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// barrier copy. We do this *after* the memmove
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// because the destination stack may have garbage on
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>writeBarrier</span>.<span style=color:#a6e22e>needed</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>curg</span>.<span style=color:#a6e22e>gcscandone</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findfunc</span>(<span style=color:#a6e22e>fn</span>.<span style=color:#a6e22e>fn</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>stkmap</span> <span style=color:#f92672>:=</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>stackmap</span>)(<span style=color:#a6e22e>funcdata</span>(<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>_FUNCDATA_ArgsPointerMaps</span>))
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>stkmap</span>.<span style=color:#a6e22e>nbit</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// We&#39;re in the prologue, so it&#39;s always stack map index 0.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>bv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>stackmapdata</span>(<span style=color:#a6e22e>stkmap</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>bulkBarrierBitmap</span>(<span style=color:#a6e22e>spArg</span>, <span style=color:#a6e22e>spArg</span>, uintptr(<span style=color:#a6e22e>bv</span>.<span style=color:#a6e22e>n</span>)<span style=color:#f92672>*</span><span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>PtrSize</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>bv</span>.<span style=color:#a6e22e>bytedata</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memclrNoHeapPointers</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>), <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>)) <span style=color:#75715e>//newg.sched 空间置零
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>sp</span> = <span style=color:#a6e22e>sp</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>stktopsp</span> = <span style=color:#a6e22e>sp</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>pc</span> = <span style=color:#a6e22e>funcPC</span>(<span style=color:#a6e22e>goexit</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>PCQuantum</span> <span style=color:#75715e>// +PCQuantum=1 so that previous instruction is in same function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>guintptr</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>newg</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gostartcallfn</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>sched</span>, <span style=color:#a6e22e>fn</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*      这个函数
</span></span></span><span style=display:flex><span><span style=color:#75715e>			    1. 调整newg的栈空间，把goexit函数的第二条指令的地址入栈，伪造成goexit函数调用了fn，
</span></span></span><span style=display:flex><span><span style=color:#75715e>			        从而使fn执行完成后执行ret指令时返回到goexit继续执行完成最后的清理工作；
</span></span></span><span style=display:flex><span><span style=color:#75715e>			    2. 重新设置newg.buf.pc 为需要执行的函数的地址，即fn，我们这个场景为runtime.main函数的地址。
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>			// adjust Gobuf as if it executed a call to fn
</span></span></span><span style=display:flex><span><span style=color:#75715e>			// and then did an immediate gosave.
</span></span></span><span style=display:flex><span><span style=color:#75715e>			func gostartcallfn(gobuf *gobuf, fv *funcval) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>				var fn unsafe.Pointer
</span></span></span><span style=display:flex><span><span style=color:#75715e>				if fv != nil {
</span></span></span><span style=display:flex><span><span style=color:#75715e>					fn = unsafe.Pointer(fv.fn)
</span></span></span><span style=display:flex><span><span style=color:#75715e>				} else {
</span></span></span><span style=display:flex><span><span style=color:#75715e>					fn = unsafe.Pointer(funcPC(nilfunc))
</span></span></span><span style=display:flex><span><span style=color:#75715e>				}
</span></span></span><span style=display:flex><span><span style=color:#75715e>				gostartcall(gobuf, fn, unsafe.Pointer(fv))
</span></span></span><span style=display:flex><span><span style=color:#75715e>			}
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>			// adjust Gobuf as if it executed a call to fn with context ctxt
</span></span></span><span style=display:flex><span><span style=color:#75715e>			// and then did an immediate gosave.
</span></span></span><span style=display:flex><span><span style=color:#75715e>			func gostartcall(buf *gobuf, fn, ctxt unsafe.Pointer) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>				sp := buf.sp
</span></span></span><span style=display:flex><span><span style=color:#75715e>				if sys.RegSize &gt; sys.PtrSize {
</span></span></span><span style=display:flex><span><span style=color:#75715e>					sp -= sys.PtrSize
</span></span></span><span style=display:flex><span><span style=color:#75715e>					*(*uintptr)(unsafe.Pointer(sp)) = 0
</span></span></span><span style=display:flex><span><span style=color:#75715e>				}
</span></span></span><span style=display:flex><span><span style=color:#75715e>				sp -= sys.PtrSize
</span></span></span><span style=display:flex><span><span style=color:#75715e>				*(*uintptr)(unsafe.Pointer(sp)) = buf.pc
</span></span></span><span style=display:flex><span><span style=color:#75715e>				buf.sp = sp
</span></span></span><span style=display:flex><span><span style=color:#75715e>				buf.pc = uintptr(fn)
</span></span></span><span style=display:flex><span><span style=color:#75715e>				buf.ctxt = ctxt
</span></span></span><span style=display:flex><span><span style=color:#75715e>			}
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>gopc</span> = <span style=color:#a6e22e>callerpc</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>ancestors</span> = <span style=color:#a6e22e>saveAncestors</span>(<span style=color:#a6e22e>callergp</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>startpc</span> = <span style=color:#a6e22e>fn</span>.<span style=color:#a6e22e>fn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>newg</span>, <span style=color:#a6e22e>_Gdead</span>, <span style=color:#a6e22e>_Grunnable</span>) <span style=color:#75715e>//修改goroutine状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcacheend</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Sched.goidgen is the last allocated id,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// this batch must be [sched.goidgen+1, sched.goidgen+GoidCacheBatch].
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// At startup sched.goidgen=0, so main goroutine receives goid=1.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span> = <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Xadd64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>goidgen</span>, <span style=color:#a6e22e>_GoidCacheBatch</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>_GoidCacheBatch</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcacheend</span> = <span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>_GoidCacheBatch</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>goid</span> = int64(<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_p_</span>.<span style=color:#a6e22e>goidcache</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>raceenabled</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>racectx</span> = <span style=color:#a6e22e>racegostart</span>(<span style=color:#a6e22e>callerpc</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>traceGoCreate</span>(<span style=color:#a6e22e>newg</span>, <span style=color:#a6e22e>newg</span>.<span style=color:#a6e22e>startpc</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>runqput</span>(<span style=color:#a6e22e>_p_</span>, <span style=color:#a6e22e>newg</span>, <span style=color:#66d9ef>true</span>) <span style=color:#75715e>//放入本地队列， 或者全局队列  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>npidle</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>nmspinning</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>mainStarted</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>wakep</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>} <span style=color:#75715e>//end newproc1 function
</span></span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200907185424.png alt=20200907185424></p><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200907194223.png alt=20200907194223></p><h6 id=rbp这个寄存器的值还有用>rbp这个寄存器的值还有用?
<a class=anchor href=#rbp%e8%bf%99%e4%b8%aa%e5%af%84%e5%ad%98%e5%99%a8%e7%9a%84%e5%80%bc%e8%bf%98%e6%9c%89%e7%94%a8>#</a></h6><blockquote><p>rbp这个寄存器的值,会保存到新创建的goroutine里的<code>sched.bp</code>字段?</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>g</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stack</span>       <span style=color:#a6e22e>stack</span>   <span style=color:#75715e>// offset known to runtime/cgo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>stackguard0</span> <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// offset known to liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>stackguard1</span> <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// offset known to liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_panic</span>         <span style=color:#f92672>*</span><span style=color:#a6e22e>_panic</span> <span style=color:#75715e>// innermost panic - offset known to liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_defer</span>         <span style=color:#f92672>*</span><span style=color:#a6e22e>_defer</span> <span style=color:#75715e>// innermost defer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>m</span>              <span style=color:#f92672>*</span><span style=color:#a6e22e>m</span>      <span style=color:#75715e>// current m; offset known to arm liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sched</span>          <span style=color:#a6e22e>gobuf</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>gobuf</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sp</span>   <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pc</span>   <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span>    <span style=color:#a6e22e>guintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctxt</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ret</span>  <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>Uintreg</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lr</span>   <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bp</span>   <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// for GOEXPERIMENT=framepointer   ------------------------here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><ul><li>没有保存,当重新调度这个goroutine,<code>重新观察BP寄存器</code>这一章中我们会看到里面是空的</li><li><code>进入main函数</code>里面有rpb是否会入栈</li></ul><h4 id=mstart>mstart
<a class=anchor href=#mstart>#</a></h4><p>我们继续下面的
<a href=https://github.com/golang/go/blob/93810ac1f4574e1e2a79ea156781bafaf8b8ebe0/src/runtime/asm_amd64.s#L87>runtime·rt0_go</a>函数.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#75715e>// start this M
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>mstart</span>(<span style=color:#a6e22e>SB</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>abort</span>(<span style=color:#a6e22e>SB</span>)	<span style=color:#75715e>// mstart should never return
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>RET</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Prevent dead-code elimination of debugCallV1, which is
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// intended to be called by debuggers.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>debugCallV1</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// mstart is the entry-point for new Ms.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// This must not split the stack because we may not even have stack
</span></span></span><span style=display:flex><span><span style=color:#75715e>// bounds set up yet.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// May run during STW (because it doesn&#39;t have a P yet), so write
</span></span></span><span style=display:flex><span><span style=color:#75715e>// barriers are not allowed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:nosplit
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:nowritebarrierrec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mstart</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()  <span style=color:#75715e>// g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>osStack</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>lo</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*  ? linux的话， 从runtime·rt0_go我们知道，g0的stack.lo,不是为0的.
</span></span></span><span style=display:flex><span><span style=color:#75715e>		// create istack out of the given (operating system) stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e>		// _cgo_init may update stackguard.
</span></span></span><span style=display:flex><span><span style=color:#75715e>		MOVQ	$runtime·g0(SB), DI
</span></span></span><span style=display:flex><span><span style=color:#75715e>		LEAQ	(-64*1024+104)(SP), BX
</span></span></span><span style=display:flex><span><span style=color:#75715e>		MOVQ	BX, g_stackguard0(DI)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		MOVQ	BX, g_stackguard1(DI)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		MOVQ	BX, (g_stack+stack_lo)(DI)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		MOVQ	SP, (g_stack+stack_hi)(DI)
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>osStack</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Initialize stack bounds from system stack.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// Cgo may have left stack size in stack.hi.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// minit may update the stack bounds.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>size</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>hi</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>size</span> = <span style=color:#ae81ff>8192</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>StackGuardMultiplier</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>hi</span> = uintptr(<span style=color:#a6e22e>noescape</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>size</span>)))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>lo</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>hi</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Initialize stack guard so that we can start calling regular
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// Go code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard0</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>lo</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>_StackGuard</span>  <span style=color:#75715e>//这个stackguard0比stack.lo大，防止越界
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// This is the g0, so we can also call go:systemstack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// functions, which check stackguard1.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard1</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>stackguard0</span> <span style=color:#75715e>//stackguard1的作用是栈溢出检查，如果是stackguard0与stackguard1相等，那么是不能放数据到g0栈中了吗
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>mstart1</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Exit this thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;windows&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;solaris&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;illumos&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;plan9&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;darwin&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>GOOS</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;aix&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// the stack, but put it in _g_.stack before mstart,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// so the logic above hasn&#39;t set osStack yet.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>osStack</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mexit</span>(<span style=color:#a6e22e>osStack</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mstart1</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()   <span style=color:#75715e>//g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>g0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;bad runtime·mstart&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Record the caller for use as the top of stack in mcall and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// for terminating the thread.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// We&#39;re never coming back to mstart1 after we call schedule,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// so other calls can reuse the current frame.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>getcallerpc</span>(), <span style=color:#a6e22e>getcallersp</span>()) <span style=color:#75715e>//就是把pc, sp保存到自己的sched里面， 但是bp寄存器没有保存，因为会重新使用这个栈？
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	TODO zxc 这里为什么不是当前的, gdb查看下.
</span></span></span><span style=display:flex><span><span style=color:#75715e>		getcallerpc()返回的是mstart调用mstart1时被call指令压栈的返回地址， bp+1 ?
</span></span></span><span style=display:flex><span><span style=color:#75715e>		getcallersp()函数返回的是调用mstart1函数之前mstart函数的栈顶地址    bp ?
</span></span></span><span style=display:flex><span><span style=color:#75715e>	*/</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>asminit</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>minit</span>() <span style=color:#75715e>//初始化信号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Install signal handlers; after minit so that minit can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// prepare the thread to be able to handle the signals.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 安装信号处理程序;所以minit可以准备线程以便能够处理信号, 在minit之后执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>==</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mstartm0</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>mstartfn</span>; <span style=color:#a6e22e>fn</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {   <span style=color:#75715e>//如果m的mstartfn不是空的，先执行它
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>fn</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m0</span> { <span style=color:#75715e>// 如果m不等于m0  就是m0的话,前面m0和allp[0]已经绑定了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>acquirep</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nextp</span>.<span style=color:#a6e22e>ptr</span>()) <span style=color:#75715e>//TODO zxc 这个acquirep函数是把m和m.nextp进行绑定,如果到这里的时候,nextp已经状态不是空闲的状态,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		                            <span style=color:#75715e>//那么会抛出错误?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>nextp</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>schedule</span>() <span style=color:#75715e>//进入调度
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h5 id=save函数保存pcsp到g0方便下次再度调度运行g0>save函数保存pc,sp到g0,方便下次再度调度运行g0
<a class=anchor href=#save%e5%87%bd%e6%95%b0%e4%bf%9d%e5%ad%98pcsp%e5%88%b0g0%e6%96%b9%e4%be%bf%e4%b8%8b%e6%ac%a1%e5%86%8d%e5%ba%a6%e8%b0%83%e5%ba%a6%e8%bf%90%e8%a1%8cg0>#</a></h5><p>list /usr/lib/golang/src/runtime/proc.go:1167
list /usr/lib/golang/src/runtime/proc.go:1179
list /usr/lib/golang/src/runtime/proc.go:1190</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>[</span><span style=color:#a6e22e>root@gitlab</span> <span style=color:#66d9ef>kubernets</span>]<span style=color:#75715e># gdb test
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>GNU</span> <span style=color:#66d9ef>gdb</span> (<span style=color:#66d9ef>GDB</span>) <span style=color:#66d9ef>Red</span> <span style=color:#66d9ef>Hat</span> <span style=color:#66d9ef>Enterprise</span> <span style=color:#66d9ef>Linux</span> <span style=color:#ae81ff>7</span><span style=color:#66d9ef>.6.1-119.el7</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Copyright</span> (<span style=color:#66d9ef>C</span>) <span style=color:#ae81ff>2013</span> <span style=color:#66d9ef>Free</span> <span style=color:#66d9ef>Software</span> <span style=color:#66d9ef>Foundation</span>, <span style=color:#66d9ef>Inc.</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>License</span> <span style=color:#66d9ef>GPLv3</span><span style=color:#960050;background-color:#1e0010>+</span>: <span style=color:#66d9ef>GNU</span> <span style=color:#66d9ef>GPL</span> <span style=color:#66d9ef>version</span> <span style=color:#ae81ff>3</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>later</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>http</span>:<span style=color:#960050;background-color:#1e0010>//</span><span style=color:#66d9ef>gnu.org</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>licenses</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>gpl.html</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>This</span> <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>free</span> <span style=color:#66d9ef>software</span>: <span style=color:#66d9ef>you</span> <span style=color:#66d9ef>are</span> <span style=color:#66d9ef>free</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>change</span> <span style=color:#66d9ef>and</span> <span style=color:#66d9ef>redistribute</span> <span style=color:#66d9ef>it.</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>There</span> <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>NO</span> <span style=color:#66d9ef>WARRANTY</span>, <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>extent</span> <span style=color:#66d9ef>permitted</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>law.</span>  <span style=color:#66d9ef>Type</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>show</span> <span style=color:#66d9ef>copying</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>and</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>show</span> <span style=color:#66d9ef>warranty</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>details.</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>This</span> <span style=color:#66d9ef>GDB</span> <span style=color:#66d9ef>was</span> <span style=color:#66d9ef>configured</span> <span style=color:#66d9ef>as</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>x86_64-redhat-linux-gnu</span><span style=color:#960050;background-color:#1e0010>&#34;</span>.
</span></span><span style=display:flex><span><span style=color:#a6e22e>For</span> <span style=color:#66d9ef>bug</span> <span style=color:#66d9ef>reporting</span> <span style=color:#66d9ef>instructions</span>, <span style=color:#66d9ef>please</span> <span style=color:#66d9ef>see</span>:
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>&lt;</span>http:<span style=color:#960050;background-color:#1e0010>//</span><span style=color:#a6e22e>www.gnu.org</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>software</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>gdb</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>bugs</span><span style=color:#960050;background-color:#1e0010>/&gt;</span><span style=color:#66d9ef>...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Reading</span> <span style=color:#66d9ef>symbols</span> <span style=color:#66d9ef>from</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>tmp</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>kubernets</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>test...done.</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Loading</span> <span style=color:#66d9ef>Go</span> <span style=color:#66d9ef>Runtime</span> <span style=color:#66d9ef>support.</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>list</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>1167</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1162</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>Go</span> <span style=color:#66d9ef>code.</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1163</span>		<span style=color:#a6e22e>_g_.stackguard0</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>_g_.stack.lo</span> <span style=color:#960050;background-color:#1e0010>+</span> <span style=color:#66d9ef>_StackGuard</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1164</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>This</span> <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>g0</span>, <span style=color:#66d9ef>so</span> <span style=color:#66d9ef>we</span> <span style=color:#66d9ef>can</span> <span style=color:#66d9ef>also</span> <span style=color:#66d9ef>call</span> <span style=color:#66d9ef>go</span>:<span style=color:#66d9ef>systemstack</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1165</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>functions</span>, <span style=color:#66d9ef>which</span> <span style=color:#66d9ef>check</span> <span style=color:#66d9ef>stackguard1.</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1166</span>		<span style=color:#a6e22e>_g_.stackguard1</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>_g_.stackguard0</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1167</span>		<span style=color:#a6e22e>mstart1</span>()
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1168</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1169</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>Exit</span> <span style=color:#66d9ef>this</span> <span style=color:#66d9ef>thread.</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1170</span>		<span style=color:#a6e22e>if</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>windows</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>||</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>solaris</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>||</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>illumos</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>||</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>plan9</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>||</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>darwin</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>||</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>aix</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1171</span>			<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>Windows</span>, <span style=color:#66d9ef>Solaris</span>, <span style=color:#66d9ef>illumos</span>, <span style=color:#66d9ef>Darwin</span>, <span style=color:#66d9ef>AIX</span> <span style=color:#66d9ef>and</span> <span style=color:#66d9ef>Plan</span> <span style=color:#ae81ff>9</span> <span style=color:#66d9ef>always</span> <span style=color:#66d9ef>system-allocate</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>b</span> <span style=color:#ae81ff>1167</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>at</span> <span style=color:#ae81ff>0x42dd09</span>: <span style=color:#66d9ef>file</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>, <span style=color:#66d9ef>line</span> <span style=color:#ae81ff>1167</span>.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>list</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>1179</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1174</span>			<span style=color:#a6e22e>osStack</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1175</span>		<span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1176</span>		<span style=color:#a6e22e>mexit</span>(<span style=color:#66d9ef>osStack</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1177</span>	<span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1178</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1179</span>	<span style=color:#a6e22e>func</span> <span style=color:#66d9ef>mstart1</span>() <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1180</span>		<span style=color:#a6e22e>_g_</span> :<span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>getg</span>()
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1181</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1182</span>		<span style=color:#a6e22e>if</span> <span style=color:#66d9ef>_g_</span> !<span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>_g_.m.g0</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1183</span>			<span style=color:#a6e22e>throw</span>(<span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>bad</span> <span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#66d9ef>mstart</span><span style=color:#960050;background-color:#1e0010>&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>b</span> <span style=color:#ae81ff>1179</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>2</span> <span style=color:#66d9ef>at</span> <span style=color:#ae81ff>0x42dd30</span>: <span style=color:#66d9ef>file</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>, <span style=color:#66d9ef>line</span> <span style=color:#ae81ff>1179</span>.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>list</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>1190</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1185</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1186</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>Record</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>caller</span> <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>use</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>top</span> <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>stack</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>mcall</span> <span style=color:#66d9ef>and</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1187</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>for</span> <span style=color:#66d9ef>terminating</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>thread.</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1188</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>We</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>re</span> <span style=color:#66d9ef>never</span> <span style=color:#66d9ef>coming</span> <span style=color:#66d9ef>back</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>mstart1</span> <span style=color:#66d9ef>after</span> <span style=color:#66d9ef>we</span> <span style=color:#66d9ef>call</span> <span style=color:#66d9ef>schedule</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1189</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>so</span> <span style=color:#66d9ef>other</span> <span style=color:#66d9ef>calls</span> <span style=color:#66d9ef>can</span> <span style=color:#66d9ef>reuse</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>current</span> <span style=color:#66d9ef>frame.</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1190</span>		<span style=color:#a6e22e>save</span>(<span style=color:#66d9ef>getcallerpc</span>(), <span style=color:#66d9ef>getcallersp</span>())
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1191</span>		<span style=color:#a6e22e>asminit</span>()
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1192</span>		<span style=color:#a6e22e>minit</span>()
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1193</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1194</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>Install</span> <span style=color:#66d9ef>signal</span> <span style=color:#66d9ef>handlers</span><span style=color:#75715e>; after minit so that minit can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>(<span style=color:#66d9ef>gdb</span>) <span style=color:#66d9ef>b</span> <span style=color:#ae81ff>1190</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>3</span> <span style=color:#66d9ef>at</span> <span style=color:#ae81ff>0x42dd7f</span>: <span style=color:#66d9ef>file</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>, <span style=color:#66d9ef>line</span> <span style=color:#ae81ff>1190</span>.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>info</span> <span style=color:#66d9ef>breakpoint</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Num</span>     <span style=color:#66d9ef>Type</span>           <span style=color:#66d9ef>Disp</span> <span style=color:#66d9ef>Enb</span> <span style=color:#66d9ef>Address</span>            <span style=color:#66d9ef>What</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#66d9ef>keep</span> <span style=color:#66d9ef>y</span>   <span style=color:#ae81ff>0x000000000042dd09</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>runtime.mstart</span> <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>1167</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>2</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#66d9ef>keep</span> <span style=color:#66d9ef>y</span>   <span style=color:#ae81ff>0x000000000042dd30</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>runtime.mstart1</span> <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>1179</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>3</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#66d9ef>keep</span> <span style=color:#66d9ef>y</span>   <span style=color:#ae81ff>0x000000000042dd7f</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>runtime.mstart1</span> <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>1190</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>run</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Starting</span> <span style=color:#66d9ef>program</span>: <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>tmp</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>kubernets</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>runtime.mstart</span> () <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>1167</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1167</span>		<span style=color:#a6e22e>mstart1</span>()
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>list</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1162</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>Go</span> <span style=color:#66d9ef>code.</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1163</span>		<span style=color:#a6e22e>_g_.stackguard0</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>_g_.stack.lo</span> <span style=color:#960050;background-color:#1e0010>+</span> <span style=color:#66d9ef>_StackGuard</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1164</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>This</span> <span style=color:#66d9ef>is</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>g0</span>, <span style=color:#66d9ef>so</span> <span style=color:#66d9ef>we</span> <span style=color:#66d9ef>can</span> <span style=color:#66d9ef>also</span> <span style=color:#66d9ef>call</span> <span style=color:#66d9ef>go</span>:<span style=color:#66d9ef>systemstack</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1165</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>functions</span>, <span style=color:#66d9ef>which</span> <span style=color:#66d9ef>check</span> <span style=color:#66d9ef>stackguard1.</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1166</span>		<span style=color:#a6e22e>_g_.stackguard1</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>_g_.stackguard0</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1167</span>		<span style=color:#a6e22e>mstart1</span>()
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1168</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1169</span>		<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>Exit</span> <span style=color:#66d9ef>this</span> <span style=color:#66d9ef>thread.</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1170</span>		<span style=color:#a6e22e>if</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>windows</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>||</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>solaris</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>||</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>illumos</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>||</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>plan9</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>||</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>darwin</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>||</span> <span style=color:#66d9ef>GOOS</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#66d9ef>aix</span><span style=color:#960050;background-color:#1e0010>&#34;</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1171</span>			<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#a6e22e>Windows</span>, <span style=color:#66d9ef>Solaris</span>, <span style=color:#66d9ef>illumos</span>, <span style=color:#66d9ef>Darwin</span>, <span style=color:#66d9ef>AIX</span> <span style=color:#66d9ef>and</span> <span style=color:#66d9ef>Plan</span> <span style=color:#ae81ff>9</span> <span style=color:#66d9ef>always</span> <span style=color:#66d9ef>system-allocate</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>info</span> <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>rbp</span> <span style=color:#66d9ef>rsp</span> <span style=color:#66d9ef>pc</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0x7fffffffe490</span>	<span style=color:#ae81ff>0x7fffffffe490</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0x7fffffffe478</span>	<span style=color:#ae81ff>0x7fffffffe478</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x42dd09</span>	<span style=color:#ae81ff>0x42dd09</span> &lt;<span style=color:#66d9ef>runtime.mstart</span>+<span style=color:#ae81ff>105</span>&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Continuing.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>2</span>, <span style=color:#66d9ef>runtime.mstart1</span> () <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>1179</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1179</span>	<span style=color:#a6e22e>func</span> <span style=color:#66d9ef>mstart1</span>() <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>info</span> <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>rbp</span> <span style=color:#66d9ef>rsp</span> <span style=color:#66d9ef>pc</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0x7fffffffe490</span>	<span style=color:#ae81ff>0x7fffffffe490</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0x7fffffffe470</span>	<span style=color:#ae81ff>0x7fffffffe470</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x42dd30</span>	<span style=color:#ae81ff>0x42dd30</span> &lt;<span style=color:#66d9ef>runtime.mstart1</span>&gt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>x</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>8</span><span style=color:#66d9ef>xb</span> <span style=color:#ae81ff>0x7fffffffe470</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>0</span>x7fffffffe470:	<span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0e</span>	<span style=color:#ae81ff>0xdd</span>	<span style=color:#ae81ff>0x42</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>info</span> <span style=color:#66d9ef>frame</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Stack</span> <span style=color:#66d9ef>frame</span> <span style=color:#66d9ef>at</span> <span style=color:#ae81ff>0x7fffffffe478</span>:
</span></span><span style=display:flex><span> <span style=color:#a6e22e>rip</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#ae81ff>0x42dd30</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>runtime.mstart1</span> (<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>1179</span>)<span style=color:#75715e>; saved rip 0x42dd0e
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>called</span> <span style=color:#66d9ef>by</span> <span style=color:#66d9ef>frame</span> <span style=color:#66d9ef>at</span> <span style=color:#ae81ff>0x7fffffffe4a0</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>source</span> <span style=color:#66d9ef>language</span> <span style=color:#66d9ef>unknown.</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Arglist</span> <span style=color:#66d9ef>at</span> <span style=color:#ae81ff>0x7fffffffe468</span>, <span style=color:#66d9ef>args</span>:
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Locals</span> <span style=color:#66d9ef>at</span> <span style=color:#ae81ff>0x7fffffffe468</span>, <span style=color:#66d9ef>Previous</span> <span style=color:#66d9ef>frame</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>s</span> <span style=color:#66d9ef>sp</span> <span style=color:#66d9ef>is</span> <span style=color:#ae81ff>0x7fffffffe478</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Saved</span> <span style=color:#66d9ef>registers</span>:
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rip</span> <span style=color:#66d9ef>at</span> <span style=color:#ae81ff>0x7fffffffe470</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>)
</span></span></code></pre></div><h6 id=反汇编看下mstart1到save函数的汇编代码>反汇编看下mstart1到save函数的汇编代码
<a class=anchor href=#%e5%8f%8d%e6%b1%87%e7%bc%96%e7%9c%8b%e4%b8%8bmstart1%e5%88%b0save%e5%87%bd%e6%95%b0%e7%9a%84%e6%b1%87%e7%bc%96%e4%bb%a3%e7%a0%81>#</a></h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>disass</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Dump</span> <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>assembler</span> <span style=color:#66d9ef>code</span> <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>function</span> <span style=color:#66d9ef>runtime.mstart1</span>:
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>=&gt;</span> <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd30</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %fs:<span style=color:#ae81ff>0xfffffffffffffff8</span>,%rcx <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>rcx</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&amp;</span><span style=color:#66d9ef>g0</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd39</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>9</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>cmp</span>    <span style=color:#ae81ff>0x10</span>(%rcx),%rsp             <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>g0.stackguard0与rsp</span>(<span style=color:#ae81ff>0x7fffffffe470</span>)<span style=color:#960050;background-color:#1e0010>判断是否达到栈顶部</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd3d</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>13</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jbe</span>    <span style=color:#ae81ff>0x42de2e</span> &lt;<span style=color:#66d9ef>runtime.mstart1</span>+<span style=color:#ae81ff>254</span>&gt;  <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>jump</span> <span style=color:#66d9ef>below</span> <span style=color:#66d9ef>equal</span> <span style=color:#960050;background-color:#1e0010>&lt;=</span>, <span style=color:#960050;background-color:#1e0010>就</span><span style=color:#66d9ef>panic</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd43</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>19</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>sub</span>    <span style=color:#66d9ef>$0x20</span>,%rsp <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>rsp</span><span style=color:#960050;background-color:#1e0010>=</span><span style=color:#ae81ff>0x7fffffffe470</span>-<span style=color:#ae81ff>0x20</span><span style=color:#960050;background-color:#1e0010>=</span><span style=color:#ae81ff>0x7fffffffe450</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd47</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>23</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rbp,<span style=color:#ae81ff>0x18</span>(%rsp) <span style=color:#960050;background-color:#1e0010>//</span><span style=color:#66d9ef>rsp</span>(<span style=color:#ae81ff>0x7fffffffe450</span>)<span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x18</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>rbp</span> <span style=color:#960050;background-color:#1e0010>==&gt;</span> <span style=color:#66d9ef>caller</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>s栈底</span>(<span style=color:#66d9ef>rbp</span>)<span style=color:#960050;background-color:#1e0010>入</span><span style=color:#66d9ef>callee的栈</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>/*</span>
</span></span><span style=display:flex><span>		 <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>x</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>8</span><span style=color:#66d9ef>xb</span> <span style=color:#ae81ff>0x7fffffffe468</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>0</span>x7fffffffe468:	<span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x90</span>	<span style=color:#ae81ff>0xe4</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0x7f</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span> 
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>从前面</span> <span style=color:#66d9ef>info</span> <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>rbp</span> <span style=color:#66d9ef>rsp</span> <span style=color:#66d9ef>pc返回可以看到</span>,<span style=color:#960050;background-color:#1e0010>就是</span><span style=color:#66d9ef>rbp的值</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>*/</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd4c</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>28</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>lea</span>    <span style=color:#ae81ff>0x18</span>(%rsp),%rbp <span style=color:#960050;background-color:#1e0010>//取地址不取引用</span>,<span style=color:#960050;background-color:#1e0010>得到</span><span style=color:#66d9ef>rbp</span><span style=color:#960050;background-color:#1e0010>=</span><span style=color:#ae81ff>0x7fffffffe468</span><span style=color:#75715e>; 所以callee[mstart1函数]新的栈底rbp就指向这
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#960050;background-color:#1e0010>/</span>*
</span></span><span style=display:flex><span>		 <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>info</span> <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>rbp</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0x7fffffffe468</span>	<span style=color:#ae81ff>0x7fffffffe468</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>*/</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd51</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>33</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %fs:<span style=color:#ae81ff>0xfffffffffffffff8</span>,%rax <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>rax</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&amp;</span><span style=color:#66d9ef>g0</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd5a</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>42</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#ae81ff>0x30</span>(%rax),%rcx <span style=color:#960050;background-color:#1e0010>//</span><span style=color:#66d9ef>rcx</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>g0.m.g0</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd5e</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>46</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>cmp</span>    %rax,(%rcx)     <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>g0是否与g0.m.g0相等</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd61</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>49</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>jne</span>    <span style=color:#ae81ff>0x42de14</span> &lt;<span style=color:#66d9ef>runtime.mstart1</span>+<span style=color:#ae81ff>228</span>&gt; <span style=color:#960050;background-color:#1e0010>//跳转到</span><span style=color:#66d9ef>...如果不等于</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd67</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>55</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rax,<span style=color:#ae81ff>0x10</span>(%rsp) <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>rsp</span>(<span style=color:#ae81ff>0x7fffffffe450</span>)<span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x10</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#ae81ff>0x7fffffffe460</span><span style=color:#960050;background-color:#1e0010>的地方保存</span><span style=color:#66d9ef>g0的地址</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd6c</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>60</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    <span style=color:#ae81ff>0x20</span>(%rsp),%rax <span style=color:#960050;background-color:#1e0010>//</span><span style=color:#66d9ef>rsp</span>(<span style=color:#ae81ff>0x7fffffffe450</span>)<span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x20</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#ae81ff>0x7fffffffe470</span><span style=color:#960050;background-color:#1e0010>的地址内容放到</span><span style=color:#66d9ef>rax</span> <span style=color:#960050;background-color:#1e0010>//这里就是</span><span style=color:#66d9ef>caller</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>s</span> <span style=color:#66d9ef>pc</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd71</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>65</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rax,(%rsp) <span style=color:#960050;background-color:#1e0010>//所以从下面可以看出</span><span style=color:#ae81ff>0x7fffffffe470</span><span style=color:#960050;background-color:#1e0010>与</span><span style=color:#ae81ff>0x7fffffffe450</span><span style=color:#960050;background-color:#1e0010>内容是一样的都是</span><span style=color:#66d9ef>caller</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>s</span> <span style=color:#66d9ef>pc</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd75</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>69</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>lea</span>    <span style=color:#ae81ff>0x28</span>(%rsp),%rax <span style=color:#960050;background-color:#1e0010>//</span><span style=color:#66d9ef>rsp</span>(<span style=color:#ae81ff>0x7fffffffe450</span>)<span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x28</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#ae81ff>0x7fffffffe478</span><span style=color:#960050;background-color:#1e0010>这个值</span>,<span style=color:#960050;background-color:#1e0010>不是里面的值放到</span><span style=color:#66d9ef>rax</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd7a</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>74</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>mov</span>    %rax,<span style=color:#ae81ff>0x8</span>(%rsp) <span style=color:#960050;background-color:#1e0010>//</span><span style=color:#66d9ef>rsp</span>(<span style=color:#ae81ff>0x7fffffffe450</span>)<span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x8</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#ae81ff>0x7fffffffe458</span> <span style=color:#960050;background-color:#1e0010>==&gt;所以这个</span><span style=color:#66d9ef>go语言里面的sp是从自调用返回后</span>,<span style=color:#66d9ef>sp里的值</span>,<span style=color:#960050;background-color:#1e0010>它不包括</span><span style=color:#66d9ef>caller调用callee的时候</span>,<span style=color:#66d9ef>call指令临时保存的pc</span>,<span style=color:#960050;background-color:#1e0010>所以地址是</span><span style=color:#ae81ff>0x7fffffffe478</span><span style=color:#960050;background-color:#1e0010>而不是</span><span style=color:#ae81ff>0x7fffffffe470</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>/*</span>
</span></span><span style=display:flex><span>		 <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>info</span> <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>rsp</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0x7fffffffe450</span>	<span style=color:#ae81ff>0x7fffffffe450</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>x</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>64</span><span style=color:#66d9ef>xb</span> <span style=color:#ae81ff>0x7fffffffe450</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>0</span>x7fffffffe450:	<span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0e</span>	<span style=color:#ae81ff>0xdd</span>	<span style=color:#ae81ff>0x42</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span> <span style=color:#960050;background-color:#1e0010>//</span><span style=color:#66d9ef>caller</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>s</span> <span style=color:#66d9ef>pc</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>0</span>x7fffffffe458:	<span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x78</span>	<span style=color:#ae81ff>0xe4</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0x7f</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span> <span style=color:#960050;background-color:#1e0010>//</span><span style=color:#66d9ef>caller</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>s</span> <span style=color:#66d9ef>sp</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>0</span>x7fffffffe460:	<span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>xc0</span>	<span style=color:#ae81ff>0xda</span>	<span style=color:#ae81ff>0x55</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span> <span style=color:#960050;background-color:#1e0010>//局部变量</span><span style=color:#66d9ef>_g_也就是全局变量g0的地址</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>0</span>x7fffffffe468:	<span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x90</span>	<span style=color:#ae81ff>0xe4</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0x7f</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span> <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>caller</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>s</span> <span style=color:#66d9ef>rbp</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>0</span>x7fffffffe470:	<span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x0e</span>	<span style=color:#ae81ff>0xdd</span>	<span style=color:#ae81ff>0x42</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span> <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>caller</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#66d9ef>s</span> <span style=color:#66d9ef>pc</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>0</span>x7fffffffe478:	<span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x74</span>	<span style=color:#ae81ff>0x15</span>	<span style=color:#ae81ff>0x45</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>0</span>x7fffffffe480:	<span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>0</span>x7fffffffe488:	<span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x08</span>	<span style=color:#ae81ff>0xe5</span>	<span style=color:#ae81ff>0xfe</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0xff</span>	<span style=color:#ae81ff>0x7f</span>	<span style=color:#ae81ff>0x00</span>	<span style=color:#ae81ff>0x00</span> 
</span></span><span style=display:flex><span>   *<span style=color:#960050;background-color:#1e0010>/</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span><span style=color:#a6e22e>x000000000042dd7f</span> <span style=color:#960050;background-color:#1e0010>&lt;+</span><span style=color:#ae81ff>79</span><span style=color:#960050;background-color:#1e0010>&gt;</span>:	<span style=color:#66d9ef>callq</span>  <span style=color:#ae81ff>0x431bd0</span> &lt;<span style=color:#66d9ef>runtime.save</span>&gt; <span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>save</span>(<span style=color:#66d9ef>getcallerpc</span>(), <span style=color:#66d9ef>getcallersp</span>())
</span></span></code></pre></div><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200908170921.png alt="gdb调试的时候发现,info frame中sp没有包括pc"></p><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200908193623.png alt=20200908193623></p><p><img src=https://raw.githubusercontent.com/zput/myPicLib/master/zput.github.io/20200908200455.png alt=mstart1函数,到保存pc,sp到g0></p><h5 id=schedule>schedule
<a class=anchor href=#schedule>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// One round of scheduler: find a runnable goroutine and execute it.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Never returns.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>schedule</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>() <span style=color:#75715e>// get g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>top</span>:
</span></span><span style=display:flex><span>	<span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>inheritTime</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Normal goroutines will check for need to wakeP in ready,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// but GCworkers and tracereaders will not, so the check must
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// be done here instead.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>tryWakeP</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e>//一般的goroutines会在准备好的时候检查是否需要wakeP。gcworker, tracereaders需要现在唤醒P.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>shutdown</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span> = <span style=color:#a6e22e>traceReader</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Gwaiting</span>, <span style=color:#a6e22e>_Grunnable</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>traceGoUnpark</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>tryWakeP</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>gcBlackenEnabled</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span> = <span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>findRunnableGCWorker</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>())
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tryWakeP</span> = <span style=color:#a6e22e>tryWakeP</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Check the global runnable queue once in a while to ensure fairness.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// Otherwise two goroutines can completely occupy the local runqueue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// by constantly respawning each other.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>schedtick</span><span style=color:#f92672>%</span><span style=color:#ae81ff>61</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>runqsize</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gp</span> = <span style=color:#a6e22e>globrunqget</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>(), <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>inheritTime</span> = <span style=color:#a6e22e>runqget</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>())
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>spinning</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;schedule: spinning with local work&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>inheritTime</span> = <span style=color:#a6e22e>findrunnable</span>() <span style=color:#75715e>// blocks until work is available
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// This thread is going to run a goroutine and is not spinning anymore,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// so if it was marked as spinning we need to reset it now and potentially
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// start a new spinning M.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>spinning</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resetspinning</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>disable</span>.<span style=color:#a6e22e>user</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>schedEnabled</span>(<span style=color:#a6e22e>gp</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Scheduling of this goroutine is disabled. Put it on
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// the list of pending runnable goroutines for when we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// re-enable user scheduling and look again.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>schedEnabled</span>(<span style=color:#a6e22e>gp</span>) {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Something re-enabled scheduling while we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// were acquiring the lock.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>disable</span>.<span style=color:#a6e22e>runnable</span>.<span style=color:#a6e22e>pushBack</span>(<span style=color:#a6e22e>gp</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>disable</span>.<span style=color:#a6e22e>n</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>top</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If about to schedule a not-normal goroutine (a GCworker or tracereader),
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// wake a P if there is one.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tryWakeP</span> { <span style=color:#75715e>//a GCworker or tracereader,需要唤醒P
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>npidle</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>nmspinning</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>wakep</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>inheritTime</span>) <span style=color:#75715e>// 执行G
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><ul><li><p>schedule()函数主要是获取一个Goroutine.</p><ul><li>schedule函数通过调用<code>globrunqget()</code>和<code>runqget()</code>函数分别从全局运行队列和当前工作线程的本地运行队列中选取下一个需要运行的goroutine;</li><li>如果这两个队列都没有需要运行的goroutine则通过<code>findrunnable()</code>函数从其它p的运行队列中盗取goroutine.</li></ul></li><li><p>一旦找到下一个需要运行的goroutine，则调用excute函数从g0切换到该goroutine去运行.</p><ul><li>否则<code>gp, inheritTime = findrunnable() // blocks until work is available</code>,一直阻塞在findrunnable()上面</li></ul></li></ul><h6 id=execute函数>execute函数
<a class=anchor href=#execute%e5%87%bd%e6%95%b0>#</a></h6><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Schedules gp to run on the current M.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// If inheritTime is true, gp inherits the remaining time in the
</span></span></span><span style=display:flex><span><span style=color:#75715e>// current time slice. Otherwise, it starts a new time slice.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Never returns.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Write barriers are allowed because this is called immediately after
</span></span></span><span style=display:flex><span><span style=color:#75715e>// acquiring a P in several places.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//go:yeswritebarrierrec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>inheritTime</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>() <span style=color:#75715e>// g0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Grunnable</span>, <span style=color:#a6e22e>_Grunning</span>) <span style=color:#75715e>//修改将要运行的gp的状态.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>waitsince</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>preempt</span> = <span style=color:#66d9ef>false</span> <span style=color:#75715e>//抢占标志位
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>stackguard0</span> = <span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>lo</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>_StackGuard</span> <span style=color:#75715e>//设置栈顶的保护,比栈地址的最低位高点,防止栈越界
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>inheritTime</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>schedtick</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>curg</span> = <span style=color:#a6e22e>gp</span> <span style=color:#75715e>//这里就开始设置M的curg为gp,而不是g0了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>m</span> = <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>  <span style=color:#75715e>// m.curg = gp and gp.m = m
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gogo</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>sched</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>execute函数主要为将要被调度运行的gp设置状态,与M相互关联</p><h6 id=gogo>gogo
<a class=anchor href=#gogo>#</a></h6><p>寻找在那个文件里面:<code>list /usr/lib/golang/src/runtime/proc.go:2165</code></p><blockquote><p>gdb查看发现又到了asm_amd64.s文件</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>step</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>runtime.gogo</span> () <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>asm_amd64.s</span>:<span style=color:#ae81ff>272</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>272</span>	<span style=color:#a6e22e>TEXT</span> <span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#66d9ef>gogo</span>(<span style=color:#66d9ef>SB</span>), <span style=color:#66d9ef>NOSPLIT</span>, <span style=color:#66d9ef>$16-8</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>list</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// func gogo(buf *gobuf)
</span></span></span><span style=display:flex><span><span style=color:#75715e>// restore state from Gobuf; longjmp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>gogo</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>NOSPLIT</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>buf</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>FP</span>), <span style=color:#a6e22e>BX</span>		<span style=color:#75715e>// gobuf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_g</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>DX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>DX</span>), <span style=color:#a6e22e>CX</span>		<span style=color:#75715e>// make sure g != nil //防止g.gobuf.g里面的值是空的,空的取地址会panic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>CX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>DX</span>, <span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>CX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_sp</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>SP</span>	<span style=color:#75715e>// restore SP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_ret</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_ctxt</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>DX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_bp</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>BP</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>gobuf_sp</span>(<span style=color:#a6e22e>BX</span>)	<span style=color:#75715e>// clear to help garbage collector
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>gobuf_ret</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>gobuf_ctxt</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>gobuf_bp</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>gobuf_pc</span>(<span style=color:#a6e22e>BX</span>), <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JMP</span>	<span style=color:#a6e22e>BX</span>
</span></span></code></pre></div><p>gogo把将要运行的main函数的goroutine从gobuf中取出到寄存器中,同时清0,有助于垃圾回收.</p><h6 id=重新观察bp寄存器>重新观察BP寄存器
<a class=anchor href=#%e9%87%8d%e6%96%b0%e8%a7%82%e5%af%9fbp%e5%af%84%e5%ad%98%e5%99%a8>#</a></h6><blockquote><p>当调度这个main函数的goroutine,从g.sched中恢复的寄存器的值,其中恢复后BP寄存器的值就是0</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>info</span> <span style=color:#66d9ef>breakpoints</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Num</span>     <span style=color:#66d9ef>Type</span>           <span style=color:#66d9ef>Disp</span> <span style=color:#66d9ef>Enb</span> <span style=color:#66d9ef>Address</span>            <span style=color:#66d9ef>What</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>1</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#66d9ef>keep</span> <span style=color:#66d9ef>y</span>   <span style=color:#ae81ff>0x000000000042fe3e</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>runtime.execute</span> <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>2171</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>breakpoint</span> <span style=color:#66d9ef>already</span> <span style=color:#66d9ef>hit</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>time</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>2</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#66d9ef>keep</span> <span style=color:#66d9ef>y</span>   <span style=color:#ae81ff>0x00000000004515ce</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>runtime.gogo</span> <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>asm_amd64.s</span>:<span style=color:#ae81ff>281</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>3</span>       <span style=color:#a6e22e>breakpoint</span>     <span style=color:#66d9ef>keep</span> <span style=color:#66d9ef>y</span>   <span style=color:#ae81ff>0x00000000004515d2</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>runtime.gogo</span> <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>asm_amd64.s</span>:<span style=color:#ae81ff>282</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>run</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>The</span> <span style=color:#66d9ef>program</span> <span style=color:#66d9ef>being</span> <span style=color:#66d9ef>debugged</span> <span style=color:#66d9ef>has</span> <span style=color:#66d9ef>been</span> <span style=color:#66d9ef>started</span> <span style=color:#66d9ef>already.</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Start</span> <span style=color:#66d9ef>it</span> <span style=color:#66d9ef>from</span> <span style=color:#66d9ef>the</span> <span style=color:#66d9ef>beginning</span><span style=color:#960050;background-color:#1e0010>?</span> (<span style=color:#66d9ef>y</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>n</span>) <span style=color:#66d9ef>y</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Starting</span> <span style=color:#66d9ef>program</span>: <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>tmp</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>kubernets</span><span style=color:#960050;background-color:#1e0010>/</span>.<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>runtime.execute</span> (<span style=color:#66d9ef>gp</span><span style=color:#960050;background-color:#1e0010>=</span><span style=color:#ae81ff>0xc000000300</span>, <span style=color:#66d9ef>inheritTime</span><span style=color:#960050;background-color:#1e0010>=</span><span style=color:#66d9ef>true</span>) <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>proc.go</span>:<span style=color:#ae81ff>2171</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>2171</span>		<span style=color:#a6e22e>gogo</span>(<span style=color:#960050;background-color:#1e0010>&amp;</span><span style=color:#66d9ef>gp.sched</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Continuing.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>2</span>, <span style=color:#66d9ef>runtime.gogo</span> () <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>asm_amd64.s</span>:<span style=color:#ae81ff>281</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>281</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>gobuf_bp</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>BP</span> <span style=color:#960050;background-color:#1e0010>//这里打了断点</span>,<span style=color:#960050;background-color:#1e0010>观察下</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>list</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>276</span>		<span style=color:#a6e22e>get_tls</span>(<span style=color:#66d9ef>CX</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>277</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>DX</span>, <span style=color:#66d9ef>g</span>(<span style=color:#66d9ef>CX</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>278</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>gobuf_sp</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>SP</span>	<span style=color:#960050;background-color:#1e0010>//</span> <span style=color:#66d9ef>restore</span> <span style=color:#66d9ef>SP</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>279</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>gobuf_ret</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>AX</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>280</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>gobuf_ctxt</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>DX</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>281</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>gobuf_bp</span>(<span style=color:#66d9ef>BX</span>), <span style=color:#66d9ef>BP</span>     <span style=color:#960050;background-color:#1e0010>//这里打了断点</span>,<span style=color:#960050;background-color:#1e0010>观察下</span>  ------------------<span style=color:#66d9ef>here</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>282</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>$0</span>, <span style=color:#66d9ef>gobuf_sp</span>(<span style=color:#66d9ef>BX</span>)	 <span style=color:#960050;background-color:#1e0010>//这里打了断点</span>,<span style=color:#960050;background-color:#1e0010>观察下</span>  ------------------<span style=color:#66d9ef>here</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>283</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>$0</span>, <span style=color:#66d9ef>gobuf_ret</span>(<span style=color:#66d9ef>BX</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>284</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>$0</span>, <span style=color:#66d9ef>gobuf_ctxt</span>(<span style=color:#66d9ef>BX</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>285</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>$0</span>, <span style=color:#66d9ef>gobuf_bp</span>(<span style=color:#66d9ef>BX</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>info</span> <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>rbp</span> <span style=color:#66d9ef>rsp</span> <span style=color:#66d9ef>pc</span> <span style=color:#66d9ef>bp</span> <span style=color:#66d9ef>sp</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0x7fffffffe3c8</span>	<span style=color:#ae81ff>0x7fffffffe3c8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0xc0000307d8</span>	<span style=color:#ae81ff>0xc0000307d8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x4515ce</span>	<span style=color:#ae81ff>0x4515ce</span> &lt;<span style=color:#66d9ef>runtime.gogo</span>+<span style=color:#ae81ff>46</span>&gt;
</span></span><span style=display:flex><span><span style=color:#a6e22e>bp</span>             <span style=color:#ae81ff>0xe3c8</span>	-<span style=color:#ae81ff>7224</span> <span style=color:#960050;background-color:#1e0010>//其值开始不是</span><span style=color:#ae81ff>0</span>  ------------------<span style=color:#66d9ef>here</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sp</span>             <span style=color:#ae81ff>0xc0000307d8</span>	<span style=color:#ae81ff>0xc0000307d8</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>step</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Breakpoint</span> <span style=color:#ae81ff>3</span>, <span style=color:#66d9ef>runtime.gogo</span> () <span style=color:#66d9ef>at</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>lib</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>golang</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>src</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>runtime</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>asm_amd64.s</span>:<span style=color:#ae81ff>282</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>282</span>		<span style=color:#a6e22e>MOVQ</span>	<span style=color:#66d9ef>$0</span>, <span style=color:#66d9ef>gobuf_sp</span>(<span style=color:#66d9ef>BX</span>)	<span style=color:#960050;background-color:#1e0010>//这里打了断点</span>,<span style=color:#960050;background-color:#1e0010>观察下</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>) <span style=color:#66d9ef>info</span> <span style=color:#66d9ef>register</span> <span style=color:#66d9ef>rbp</span> <span style=color:#66d9ef>rsp</span> <span style=color:#66d9ef>pc</span> <span style=color:#66d9ef>bp</span> <span style=color:#66d9ef>sp</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rbp</span>            <span style=color:#ae81ff>0x0</span>	<span style=color:#ae81ff>0x0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsp</span>            <span style=color:#ae81ff>0xc0000307d8</span>	<span style=color:#ae81ff>0xc0000307d8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pc</span>             <span style=color:#ae81ff>0x4515d2</span>	<span style=color:#ae81ff>0x4515d2</span> &lt;<span style=color:#66d9ef>runtime.gogo</span>+<span style=color:#ae81ff>50</span>&gt;
</span></span><span style=display:flex><span><span style=color:#a6e22e>bp</span>             <span style=color:#ae81ff>0x0</span>	<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>//其值的确是为</span><span style=color:#ae81ff>0</span>  ------------------<span style=color:#66d9ef>here</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sp</span>             <span style=color:#ae81ff>0xc0000307d8</span>	<span style=color:#ae81ff>0xc0000307d8</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>gdb</span>)
</span></span></code></pre></div><h3 id=进入main函数>进入main函数
<a class=anchor href=#%e8%bf%9b%e5%85%a5main%e5%87%bd%e6%95%b0>#</a></h3><blockquote><p>文件里面<code>func main() {</code>:<code>list /usr/lib/golang/src/runtime/proc.go:113</code></p><blockquote><p>我们打下断点到这个函数,然后查看它前几个汇编代码</p></blockquote></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> list /usr/lib/golang/src/runtime/proc.go:113
</span></span><span style=display:flex><span><span style=color:#ae81ff>108</span>
</span></span><span style=display:flex><span>109	// Value to use <span style=color:#66d9ef>for</span> signal mask <span style=color:#66d9ef>for</span> newly created M<span style=color:#e6db74>&#39;s.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>110	var initSigmask sigset
</span></span></span><span style=display:flex><span><span style=color:#e6db74>111
</span></span></span><span style=display:flex><span><span style=color:#e6db74>112	// The main goroutine.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>113	func main() {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>114		g := getg()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>115
</span></span></span><span style=display:flex><span><span style=color:#e6db74>116		// Racectx of m0-&gt;g0 is used only as the parent of the main goroutine.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>117		// It must not be used for anything else.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(gdb) b 113
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Breakpoint 4 at 0x42aea0: file /usr/lib/golang/src/runtime/proc.go, line 113.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(gdb) c
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Continuing.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Breakpoint 4, runtime.main () at /usr/lib/golang/src/runtime/proc.go:113
</span></span></span><span style=display:flex><span><span style=color:#e6db74>113	func main() {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(gdb) list
</span></span></span><span style=display:flex><span><span style=color:#e6db74>108
</span></span></span><span style=display:flex><span><span style=color:#e6db74>109	// Value to use for signal mask for newly created M&#39;</span>s.
</span></span><span style=display:flex><span>110	var initSigmask sigset
</span></span><span style=display:flex><span><span style=color:#ae81ff>111</span>
</span></span><span style=display:flex><span>112	// The main goroutine.
</span></span><span style=display:flex><span>113	func main<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>114		g :<span style=color:#f92672>=</span> getg<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>115</span>
</span></span><span style=display:flex><span>116		// Racectx of m0-&gt;g0 is used only as the parent of the main goroutine.
</span></span><span style=display:flex><span>117		// It must not be used <span style=color:#66d9ef>for</span> anything <span style=color:#66d9ef>else</span>.
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> info register rbp rsp pc bp sp
</span></span><span style=display:flex><span>rbp            0x0	0x0
</span></span><span style=display:flex><span>rsp            0xc0000307d8	0xc0000307d8
</span></span><span style=display:flex><span>pc             0x42aea0	0x42aea0 &lt;runtime.main&gt;
</span></span><span style=display:flex><span>bp             0x0	<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>sp             0xc0000307d8	0xc0000307d8
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> disas
</span></span><span style=display:flex><span>Dump of assembler code <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>function</span> runtime.main:
</span></span><span style=display:flex><span><span style=color:#f92672>=</span>&gt; 0x000000000042aea0 &lt;+0&gt;:	    mov    %fs:0xfffffffffffffff8,%rcx
</span></span><span style=display:flex><span>   0x000000000042aea9 &lt;+9&gt;:	    cmp    0x10<span style=color:#f92672>(</span>%rcx<span style=color:#f92672>)</span>,%rsp
</span></span><span style=display:flex><span>   0x000000000042aead &lt;+13&gt;:	jbe    0x42b1ea &lt;runtime.main+842&gt;
</span></span><span style=display:flex><span>   0x000000000042aeb3 &lt;+19&gt;:	sub    $0x78,%rsp
</span></span><span style=display:flex><span>   0x000000000042aeb7 &lt;+23&gt;:	mov    %rbp,0x70<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x000000000042aebc &lt;+28&gt;:	lea    0x70<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>,%rbp
</span></span><span style=display:flex><span>   0x000000000042aec1 &lt;+33&gt;:	mov    %fs:0xfffffffffffffff8,%rax
</span></span><span style=display:flex><span>   0x000000000042aeca &lt;+42&gt;:	mov    %rax,0x68<span style=color:#f92672>(</span>%rsp<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x000000000042aecf &lt;+47&gt;:	mov    0x30<span style=color:#f92672>(</span>%rax<span style=color:#f92672>)</span>,%rcx
</span></span><span style=display:flex><span>   0x000000000042aed3 &lt;+51&gt;:	mov    <span style=color:#f92672>(</span>%rcx<span style=color:#f92672>)</span>,%rcx
</span></span><span style=display:flex><span>   0x000000000042aed6 &lt;+54&gt;:	movq   $0x0,0x130<span style=color:#f92672>(</span>%rcx<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   0x000000000042aee1 &lt;+65&gt;:	movq   $0x3b9aca00,0x11e234<span style=color:#f92672>(</span>%rip<span style=color:#f92672>)</span>        <span style=color:#75715e># 0x549120 &lt;runtime.maxstacksize&gt;</span>
</span></span><span style=display:flex><span>   0x000000000042aeec &lt;+76&gt;:	movb   $0x1,0x14dabc<span style=color:#f92672>(</span>%rip<span style=color:#f92672>)</span>        <span style=color:#75715e># 0x5789af &lt;runtime.mainStarted&gt;</span>
</span></span></code></pre></div><ul><li>前面三条我们前面详细解释过.</li></ul><pre tabindex=0><code>Dump of assembler code for function runtime.main:
=&gt; 0x000000000042aea0 &lt;+0&gt;:	    mov    %fs:0xfffffffffffffff8,%rcx
   0x000000000042aea9 &lt;+9&gt;:	    cmp    0x10(%rcx),%rsp
   0x000000000042aead &lt;+13&gt;:	jbe    0x42b1ea &lt;runtime.main+842&gt;
</code></pre><ul><li>虽然这个rbp是0,是空的,但是还是保存到栈里面去了.</li></ul><pre tabindex=0><code>   0x000000000042aeb3 &lt;+19&gt;:	sub    $0x78,%rsp
   0x000000000042aeb7 &lt;+23&gt;:	mov    %rbp,0x70(%rsp)
   0x000000000042aebc &lt;+28&gt;:	lea    0x70(%rsp),%rbp
</code></pre><p>TODO systemstack</p><p><a href=http://www.mit.edu/afs.new/sipb/project/golang/doc/asm.html>http://www.mit.edu/afs.new/sipb/project/golang/doc/asm.html</a></p><p>// &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;- need deleted &mdash;&mdash;&mdash;&mdash;&mdash;-</p><p>// &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-
// 获取课堂、作业完成情况
rpc GetStudyReport (GetStudyReportRequest) returns (GetStudyReportResponse);
// 获取课堂、作业完成情况Json
rpc GetStudyReportJson (GetStudyReportRequest) returns (GetStudyReportResponse);
// 通过分享ID, 获取课程报告情况
rpc GetStudyReportByShare (GetStudyReportByShareRequest) returns (GetStudyReportResponse);
// 通过分享ID, 获取课程报告情况Json
rpc GetStudyReportByShareJson (GetStudyReportByShareRequest) returns (GetStudyReportResponse);</p><p>//获取老师点评信息
rpc GetCourseEvaluate (GetCourseEvaluateRequest) returns (GetCourseEvaluateResponse);
//获取老师点评信息json
rpc GetCourseEvaluateJson (GetCourseEvaluateRequest) returns (GetCourseEvaluateResponse);</p><p>project</p><p>//&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p><p>//提交AI课任务中的工程 todo 9.2 zxc
rpc SubmitAIMission (SubmitMissionProjectRequest) returns (SubmitMissionProjectResponse);</p><p>// &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-</p><p>//获取工程信息
rpc GetProjectInfo (GetProjectInfoRequest) returns (GetProjectInfoResponse);</p><p>//获取工程信息by分享ID, 不需要token校验
rpc GetTaskInClassByShare (GetTaskInClassByShareRequest) returns (GetTaskInClassByShareResponse);</p><p>//获取工程信息by userID, serialID, courseID, missionID
rpc GetProjectInfoByUnique (GetProjectInfoByUniqueRequest) returns (GetProjectInfoByUniqueResponse);</p><p>message GetCourseEvaluateResponse {
Project project = 1; //工程信息
repeated Comment comments = 2; //所有点评信息
string shareUUID = 3; //如果分享课程报告出去,通过这个ID来获取工程详细信息.
}</p><p>//获取工程信息
func (p *AIProjectModel) GetProject(author uint32, seriesID uint32, courseID uint32) (define.RetCode, *worker.Project) {</p><p>// Array returns the optimal driver.Valuer and sql.Scanner for an array or
// slice of any dimension.
//
// For example:
// db.Query(<code>SELECT * FROM t WHERE id = ANY($1)</code>, pq.Array([]int{235, 401}))
//
// var x []sql.NullInt64
// db.QueryRow(&lsquo;SELECT ARRAY[235, 401]&rsquo;).Scan(pq.Array(&x))
//
// Scanning multi-dimensional arrays is not supported. Arrays where the lower
// bound is not one (such as `[0:0]={1}&rsquo;) are not supported.</p><pre><code>aiCommentProject := define.AICommentProject{
	ResourceID: resourceID,
	CoverURL:   coverUrl,
	ResourceIDs: resourceIDs,
}
</code></pre><p>alter table ai_course_project
add resource_ids integer[] default array[]::integer[]</p><p>alter table ai_course_project
add read_aloud_time int default 0 not null;</p><p>alter table share_action_record
add resource_ids integer[] default array[]::integer[]</p><p>alter table share_action_record
add read_aloud_time int default 0 not null;</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=zput/utterances-comments data-repo-id=R_kgDOHhATGQ data-category=Announcements data-category-id=DIC_kwDOHhATGc4CPxca data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#例子>例子</a><ul><li><a href=#程序加载到内存入口>程序加载到内存入口</a></li><li><a href=#进行初始化全局变量>进行初始化全局变量</a></li><li><a href=#进入main函数>进入main函数</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>