<!doctype html><html lang=zh dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="类汇编函数 # go汇编 # gdb golang assamble non-split; sp bp 会更新吗?
main function enter BP is useful ? schedule
dropg()函数 # dropg() //解除g和m之间的关系; func dropg() { _g_ := getg() setMNoWB(&_g_.m.curg.m, nil) setGNoWB(&_g_.m.curg, nil) } park_m函数 # 通过mcall从gN转到g0; stack转移了, jmp跳转到park_m(*g)函数, # gN&ndash;>m &mdash;> gN mcall怎么保证g0的m指向了m的?
// park continuation on g0. func park_m(gp *g) { _g_ := getg() if trace.enabled { traceGoPark(_g_.m.waittraceev, _g_.m.waittraceskip) } casgstatus(gp, _Grunning, _Gwaiting) dropg() //解除g和m之间的关系 ...... schedule() } get_tls函数 # TEXT runtime·rt0_go(SB),NOSPLIT,$0 //."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="类汇编函数"><meta property="og:description" content="类汇编函数 # go汇编 # gdb golang assamble non-split; sp bp 会更新吗?
main function enter BP is useful ? schedule
dropg()函数 # dropg() //解除g和m之间的关系; func dropg() { _g_ := getg() setMNoWB(&_g_.m.curg.m, nil) setGNoWB(&_g_.m.curg, nil) } park_m函数 # 通过mcall从gN转到g0; stack转移了, jmp跳转到park_m(*g)函数, # gN&ndash;>m &mdash;> gN mcall怎么保证g0的m指向了m的?
// park continuation on g0. func park_m(gp *g) { _g_ := getg() if trace.enabled { traceGoPark(_g_.m.waittraceev, _g_.m.waittraceskip) } casgstatus(gp, _Grunning, _Gwaiting) dropg() //解除g和m之间的关系 ...... schedule() } get_tls函数 # TEXT runtime·rt0_go(SB),NOSPLIT,$0 //."><meta property="og:type" content="article"><meta property="og:url" content="https://zput.github.io/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/preknowledge/similar_assemble/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2019-02-28T15:03:00+00:00"><meta property="article:modified_time" content="2019-02-28T15:03:00+00:00"><title>类汇编函数 | go调度源码分析</title><link rel=manifest href=/go-goroutine/manifest.json><link rel=icon href=/go-goroutine/favicon.png type=image/x-icon><link rel=stylesheet href=/go-goroutine/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/go-goroutine/flexsearch.min.js></script>
<script defer src=/go-goroutine/en.search.min.b77a6f37e3a22f740fdae7830efd046d776addfddd90ac431c247f5a2bf82b3b.js integrity="sha256-t3pvN+OiL3QP2ueDDv0EbXdq3f3dkKxDHCR/Wiv4Kzs=" crossorigin=anonymous></script>
<script defer src=/go-goroutine/sw.min.ec96d6e09af3075a94dd4de723a2edddf2ef138381c7e1e5b5a1f2c0578ee8bd.js integrity="sha256-7JbW4JrzB1qU3U3nI6Lt3fLvE4OBx+HltaHywFeO6L0=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/go-goroutine/><span>go调度源码分析</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://zput.github.io target=_blank rel=noopener>Zput博客</a></li><li><a href=https://github.com/zput target=_blank rel=noopener>GitHub</a></li></ul><hr><ul><li><span>基础知识</span><ul><li><a href=/go-goroutine/docs/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/golang_basic/>基本用法</a></li></ul></li><li><span>健壮与性能</span><ul><li><a href=/go-goroutine/docs/%E5%81%A5%E5%A3%AE%E4%B8%8E%E6%80%A7%E8%83%BD/golang_test/>测试相关函数</a></li></ul></li><li><span>运行时</span><ul><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/golang_gmp/>GMP</a></li><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/golang_gc/>垃圾回收</a></li><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/>调度</a><ul><li><span>前置知识</span><ul><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/preknowledge/memory/>内存大小端</a></li><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/preknowledge/register_functionstack/>伪寄存器</a></li><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/preknowledge/similar_assemble/ class=active>类汇编函数</a></li><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/preknowledge/global_g_queue/>全局G队列</a></li></ul></li><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/2_init_before_enter_main_function/>初始化</a></li><li><input type=checkbox id=section-4ad8a00adbec3893f6c5db43a3f2fc72 class=toggle>
<label for=section-4ad8a00adbec3893f6c5db43a3f2fc72 class="flex justify-between"><a role=button>调度策略</a></label><ul><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/%E4%B8%80-%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/4.1.2-%E7%9B%97%E5%8F%96goroutine%E4%BB%8E%E5%85%B6%E4%BB%96%E9%98%9F%E5%88%97/>盗取goroutine</a></li><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/%E4%B8%80-%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5/4.1.1-%E4%BB%8E%E6%9C%AC%E5%9C%B0%E9%98%9F%E5%88%97%E6%88%96%E5%85%A8%E5%B1%80%E9%98%9F%E5%88%97%E8%8E%B7%E5%8F%96goroutine/>从队列获取goroutine</a></li></ul></li><li><input type=checkbox id=section-da1a4198fe20413d9888e739425b5df0 class=toggle>
<label for=section-da1a4198fe20413d9888e739425b5df0 class="flex justify-between"><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/>调度时机</a></label><ul><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.1-%E4%B8%BB%E5%8A%A8%E8%B0%83%E5%BA%A6/>主动调度</a></li><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.2-%E8%A2%AB%E5%8A%A8%E8%B0%83%E5%BA%A6/>被动调度</a></li><li><input type=checkbox id=section-5fa1bc00e046d2c14caea8c58f1b9628 class=toggle>
<label for=section-5fa1bc00e046d2c14caea8c58f1b9628 class="flex justify-between"><a role=button>剥夺调度</a></label><ul><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.3-%E5%89%A5%E5%A4%BA%E8%B0%83%E5%BA%A6/4.2.3.1-%E8%BF%90%E8%A1%8C%E7%94%A8%E6%88%B7%E4%BB%A3%E7%A0%81%E6%97%B6%E9%97%B4%E8%BF%87%E9%95%BF%E8%B0%83%E5%BA%A6/>运行用户代码时间过长调度</a></li><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/%E4%BA%8C-%E8%B0%83%E5%BA%A6%E7%9A%84%E6%97%B6%E6%9C%BA/4.2.3-%E5%89%A5%E5%A4%BA%E8%B0%83%E5%BA%A6/4.2.3.2-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%94%B6%E5%B0%BE%E5%A6%82%E6%9E%9C%E4%BB%8E%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E8%BF%94%E5%9B%9E%E5%A6%82%E4%BD%95%E9%87%8D%E6%96%B0%E5%BE%97%E5%88%B0P/>系统调用收尾,如从系统调用返回,如何重新得到P</a></li></ul></li></ul></li><li><input type=checkbox id=section-1d9ef7158540fca01ab9b01e7778b8a4 class=toggle>
<label for=section-1d9ef7158540fca01ab9b01e7778b8a4 class="flex justify-between"><a role=button>调度循环</a></label><ul><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/%E4%B8%89-%E8%B0%83%E5%BA%A6%E5%BE%AA%E7%8E%AF/4.3.1-%E8%B0%83%E5%BA%A6%E5%BE%AA%E7%8E%AF/>调度循环</a></li></ul></li><li><a href=/go-goroutine/docs/%E8%BF%90%E8%A1%8C%E6%97%B6/%E8%B0%83%E5%BA%A6/3_exit_goroutine/>退出</a></li></ul></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/go-goroutine/svg/menu.svg class=book-icon alt=Menu></label>
<strong>类汇编函数</strong>
<label for=toc-control><img src=/go-goroutine/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#类汇编函数>类汇编函数</a><ul><li><a href=#go汇编>go汇编</a><ul><li><a href=#dropg函数>dropg()函数</a></li><li><a href=#park_m函数>park_m函数</a></li></ul></li><li><a href=#通过mcall从gn转到g0-stack转移了-jmp跳转到park_mg函数>通过mcall从gN转到g0; stack转移了, jmp跳转到park_m(*g)函数,</a></li><li><a href=#get_tls函数>get_tls函数</a><ul><li></li><li><a href=#参考>参考</a></li></ul></li><li><a href=#m_morebufgobuf_pcregister>(m_morebuf+gobuf_pc)(REGISTER)</a></li><li><a href=#附录>附录</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=类汇编函数>类汇编函数
<a class=anchor href=#%e7%b1%bb%e6%b1%87%e7%bc%96%e5%87%bd%e6%95%b0>#</a></h1><h2 id=go汇编>go汇编
<a class=anchor href=#go%e6%b1%87%e7%bc%96>#</a></h2><p>gdb golang assamble
non-split; sp bp 会更新吗?</p><p>main function enter BP is useful ? schedule</p><h3 id=dropg函数>dropg()函数
<a class=anchor href=#dropg%e5%87%bd%e6%95%b0>#</a></h3><ul><li>dropg() //解除g和m之间的关系;</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dropg</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>setMNoWB</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>curg</span>.<span style=color:#a6e22e>m</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>setGNoWB</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>curg</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=park_m函数>park_m函数
<a class=anchor href=#park_m%e5%87%bd%e6%95%b0>#</a></h3><h2 id=通过mcall从gn转到g0-stack转移了-jmp跳转到park_mg函数>通过mcall从gN转到g0; stack转移了, jmp跳转到park_m(*g)函数,
<a class=anchor href=#%e9%80%9a%e8%bf%87mcall%e4%bb%8egn%e8%bd%ac%e5%88%b0g0-stack%e8%bd%ac%e7%a7%bb%e4%ba%86-jmp%e8%b7%b3%e8%bd%ac%e5%88%b0park_mg%e5%87%bd%e6%95%b0>#</a></h2><p>gN&ndash;>m &mdash;> gN
mcall怎么保证g0的m指向了m的?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// park continuation on g0.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>park_m</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_g_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>enabled</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>traceGoPark</span>(<span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>waittraceev</span>, <span style=color:#a6e22e>_g_</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>waittraceskip</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Grunning</span>, <span style=color:#a6e22e>_Gwaiting</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dropg</span>()  <span style=color:#75715e>//解除g和m之间的关系
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>......</span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>schedule</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=get_tls函数>get_tls函数
<a class=anchor href=#get_tls%e5%87%bd%e6%95%b0>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>rt0_go</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#a6e22e>NOSPLIT</span>,<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LEAQ</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>m0</span><span style=color:#f92672>+</span><span style=color:#a6e22e>m_tls</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>DI</span>  <span style=color:#75715e>// //DI = &amp;m0.tls，取m0的tls成员的地址到DI寄存器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>settls</span>(<span style=color:#a6e22e>SB</span>)        <span style=color:#75715e>// 调用settls设置线程本地存储，settls函数的参数在DI寄存器中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// store through it, to make sure it works // 可以看做是测试;测试刚刚那个绑定是否成功。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>BX</span>)    <span style=color:#75715e>// 把TLS地址放入BX寄存器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x123</span>, <span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>BX</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>m0</span><span style=color:#f92672>+</span><span style=color:#a6e22e>m_tls</span>(<span style=color:#a6e22e>SB</span>), <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CMPQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x123</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JEQ</span> <span style=color:#ae81ff>2</span>(<span style=color:#a6e22e>PC</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CALL</span>	<span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>abort</span>(<span style=color:#a6e22e>SB</span>)
</span></span></code></pre></div><h4 id=settls>settls
<a class=anchor href=#settls>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// set tls base to DI
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>TEXT</span> <span style=color:#a6e22e>runtime</span><span style=color:#960050;background-color:#1e0010>·</span><span style=color:#a6e22e>settls</span>(<span style=color:#a6e22e>SB</span>),<span style=color:#a6e22e>NOSPLIT</span>,<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>32</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ADDQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>8</span>, <span style=color:#a6e22e>DI</span>	<span style=color:#75715e>// ELF wants to use -8(FS) //因为后面要-8,所以先加+8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>DI</span>, <span style=color:#a6e22e>SI</span>  <span style=color:#75715e>// is SI parameter?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0x1002</span>, <span style=color:#a6e22e>DI</span>	<span style=color:#75715e>// ARCH_SET_FS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#a6e22e>SYS_arch_prctl</span>, <span style=color:#a6e22e>AX</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SYSCALL</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CMPQ</span>	<span style=color:#a6e22e>AX</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0xfffffffffffff001</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>JLS</span>	<span style=color:#ae81ff>2</span>(<span style=color:#a6e22e>PC</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MOVL</span>	<span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0xf1</span>, <span style=color:#ae81ff>0xf1</span>  <span style=color:#75715e>// crash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>RET</span>
</span></span></code></pre></div><p><a href=https://www.man7.org/linux/man-pages/man2/arch_prctl.2.html>arch_prctl</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>arch_prctl</span>(<span style=color:#66d9ef>int</span> code, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> addr);
</span></span><span style=display:flex><span><span style=color:#75715e>// arch_prctl() sets architecture-specific process or thread state. code selects a subfunction and passes argument addr to it;
</span></span></span></code></pre></div><p>其中：<code>ARCH_SET_FS</code>: Set the 64-bit base for the FS register to addr.</p><blockquote><p>现在知道就是把m0.tls[0]传给FS寄存器</p></blockquote><h4 id=get_tlsbx与gbx>get_tls(BX)与g(BX)
<a class=anchor href=#get_tlsbx%e4%b8%8egbx>#</a></h4><p>这个<code>get_tls(BX)</code>与<code>g()</code>其实都是宏定义：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>ifdef</span> <span style=color:#a6e22e>GOARCH_amd64</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>define</span>	<span style=color:#a6e22e>get_tls</span>(<span style=color:#a6e22e>r</span>)	<span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>TLS</span>, <span style=color:#a6e22e>r</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>define</span>	<span style=color:#a6e22e>g</span>(<span style=color:#a6e22e>r</span>)	<span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>r</span>)(<span style=color:#a6e22e>TLS</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span><span style=color:#a6e22e>endif</span>
</span></span></code></pre></div><p>可以得到</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>MOVQ</span> <span style=color:#a6e22e>TLS</span>, <span style=color:#a6e22e>BX</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>(<span style=color:#a6e22e>BX</span>)(<span style=color:#a6e22e>TLS</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><p>有两个疑问，
第一个是TLS是代表什么?
第二个是0(BX)(TLS*1)是能转换为什么地址？</p><pre tabindex=0><code>	// Thread-local storage references use the TLS pseudo-register.
	// As a register, TLS refers to the thread-local storage base, and it
	// can only be loaded into another register:
	//
	//         MOVQ TLS, AX
	//
	// An offset from the thread-local storage base is written off(reg)(TLS*1).
	// Semantically it is off(reg), but the (TLS*1) annotation marks this as
	// indexing from the loaded TLS base. This emits a relocation so that
	// if the linker needs to adjust the offset, it can. For example:
	//
	//         MOVQ TLS, AX
	//         MOVQ 0(AX)(TLS*1), CX // load g into CX
	//
	// On systems that support direct access to the TLS memory, this
	// pair of instructions can be reduced to a direct TLS memory reference:
	//
	//         MOVQ 0(TLS), CX // load g into CX
	//
	// The 2-instruction and 1-instruction forms correspond to the two code
	// sequences for loading a TLS variable in the local exec model given in &#34;ELF
	// Handling For Thread-Local Storage&#34;.
</code></pre><blockquote><p>这里总结就是:</p><blockquote><p>TLS代表的是伪寄存器，是线程本地存储的基地址。
语义上<code>off(reg)(TLS*1)== off(reg)</code>. 而这个<code>(TLS*1)</code>说明是从线程本地存储的基地址上进行索引。</p></blockquote></blockquote><h3 id=参考>参考
<a class=anchor href=#%e5%8f%82%e8%80%83>#</a></h3><p><a href=https://www.zhihu.com/question/284288720>https://www.zhihu.com/question/284288720</a>
<a href=https://segmentfault.com/a/1190000038626134>https://segmentfault.com/a/1190000038626134</a>
<a href=https://www.altoros.com/blog/golang-internals-part-5-the-runtime-bootstrap-process/>https://www.altoros.com/blog/golang-internals-part-5-the-runtime-bootstrap-process/</a></p><p><a href=https://segmentfault.com/a/1190000010984538>gid</a></p><ul><li>Addressing modes:<ul><li>(DI)(BX<em>2): The location at address DI plus BX</em>2.</li><li>64(DI)(BX<em>2): The location at address DI plus BX</em>2 plus 64. These modes accept only 1, 2, 4, and 8 as scale factors.</li></ul></li></ul><p><a href=https://golang.org/doc/asm#directives>https://golang.org/doc/asm#directives</a></p><p><a href=https://lrita.github.io/2017/12/12/golang-asm/#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E>https://lrita.github.io/2017/12/12/golang-asm/#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E</a></p><p><a href=https://github.com/go-internals-cn/go-internals>https://github.com/go-internals-cn/go-internals</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// When building for inclusion into a shared library, an instruction of the form
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//     MOV off(CX)(TLS*1), AX
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// becomes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//     mov %fs:off(%rcx), %rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// which assumes that the correct TLS offset has been loaded into %rcx (today
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// there is only one TLS variable -- g -- so this is OK). When not building for
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// a shared library the instruction does not require a prefix.
</span></span></span></code></pre></div><h2 id=m_morebufgobuf_pcregister>(m_morebuf+gobuf_pc)(REGISTER)
<a class=anchor href=#m_morebufgobuf_pcregister>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#ae81ff>8</span>(<span style=color:#a6e22e>SP</span>), <span style=color:#a6e22e>AX</span>	<span style=color:#75715e>// f&#39;s caller&#39;s PC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>MOVQ</span>	<span style=color:#a6e22e>AX</span>, (<span style=color:#a6e22e>m_morebuf</span><span style=color:#f92672>+</span><span style=color:#a6e22e>gobuf_pc</span>)(<span style=color:#a6e22e>BX</span>)
</span></span></code></pre></div><p><a href=https://github.com/zput/go/blob/5622128a77b4af5e5dc02edf53ecac545e3af730/src/runtime/runtime2.go#L452>runtime.m</a>
<a href=https://github.com/zput/go/blob/5622128a77b4af5e5dc02edf53ecac545e3af730/src/runtime/runtime2.go#L302>runtime.gobuf</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>m</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g0</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>     <span style=color:#75715e>// goroutine with scheduling stack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>morebuf</span> <span style=color:#a6e22e>gobuf</span>  <span style=color:#75715e>// gobuf arg to morestack   //-----------morebuf-------------//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>divmod</span>  <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// div/mod denominator for arm - known to liblink
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>gobuf</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The offsets of sp, pc, and g are known to (hard-coded in) libmach.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// ctxt is unusual with respect to GC: it may be a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// heap-allocated funcval, so GC needs to track it, but it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// needs to be set and cleared from assembly, where it&#39;s
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// difficult to have write barriers. However, ctxt is really a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// saved, live register, and we only ever exchange it between
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// the real register and the gobuf. Hence, we treat it as a
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// root during stack scanning, which means assembly that saves
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// and restores it doesn&#39;t need write barriers. It&#39;s still
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// typed as a pointer so that any other writes from Go get
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// write barriers.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sp</span>   <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pc</span>   <span style=color:#66d9ef>uintptr</span>   <span style=color:#75715e>// &lt;&lt;&lt;--- 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>g</span>    <span style=color:#a6e22e>guintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctxt</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ret</span>  <span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>Uintreg</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lr</span>   <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bp</span>   <span style=color:#66d9ef>uintptr</span> <span style=color:#75715e>// for GOEXPERIMENT=framepointer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>我们从这个<code>m_morebuf+gobuf_pc</code>就知道指的是这个m结构体中的morebuf结构体字段中的pc值。</p><p><a href=https://github.com/zput/go/blob/5622128a77b4af5e5dc02edf53ecac545e3af730/src/runtime/runtime2.go#L387>runtime.g</a></p><h2 id=附录>附录
<a class=anchor href=#%e9%99%84%e5%bd%95>#</a></h2><p><a href=https://lrita.github.io/2017/12/12/golang-asm/#interface>https://lrita.github.io/2017/12/12/golang-asm/#interface</a></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments><script src=https://giscus.app/client.js data-repo=zput/utterances-comments data-repo-id=R_kgDOHhATGQ data-category=Announcements data-category-id=DIC_kwDOHhATGc4CPxca data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#类汇编函数>类汇编函数</a><ul><li><a href=#go汇编>go汇编</a><ul><li><a href=#dropg函数>dropg()函数</a></li><li><a href=#park_m函数>park_m函数</a></li></ul></li><li><a href=#通过mcall从gn转到g0-stack转移了-jmp跳转到park_mg函数>通过mcall从gN转到g0; stack转移了, jmp跳转到park_m(*g)函数,</a></li><li><a href=#get_tls函数>get_tls函数</a><ul><li></li><li><a href=#参考>参考</a></li></ul></li><li><a href=#m_morebufgobuf_pcregister>(m_morebuf+gobuf_pc)(REGISTER)</a></li><li><a href=#附录>附录</a></li></ul></li></ul></nav></div></aside></main></body></html>